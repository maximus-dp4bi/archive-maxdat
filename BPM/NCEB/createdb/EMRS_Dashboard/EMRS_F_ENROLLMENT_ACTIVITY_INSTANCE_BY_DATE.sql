--Added FFS logic here instead of in Selection_trans_sv
drop view EMRS_F_ENROLLMENT_ACTIVITY_INSTANCE_BY_DATE;
CREATE OR REPLACE VIEW EMRS_F_ENROLLMENT_ACTIVITY_INSTANCE_BY_DATE AS
SELECT --/*+ PARALLEL(10) */
ACT.RECORD_DATE
, ACT.RECORD_MONTH
, NULL RECORD_NAME
, ACT.PROGRAM_CODE
, ACT.PLAN_TYPE
, ACT.ACTIVITY_TYPE
, ACT.SUB_ACTIVITY_TYPE
, ACT.ACTIVITY_STATUS
, ACT.SELECTION_SOURCE_CODE
, ACT.TRAN_PLAN_ID
, ACT.REASON_CD
, ACT.DISENROLL_TYPE_CD
, ACT.COUNTY_CODE
, ACT.CSDA_CODE
, ACT.STATE_CODE
, ACT.MANAGED_CARE_STATUS
, ACT.NEW_ENROLL_IND
, ACT.TRANSFER_IN_IND
, ACT.TRANSFER_OUT_IND
, ACT.DISENROLL_IND
, ACT.PCP_SELECTED_NEW_ENROLL_IND
, ACT.PCP_SELECTED_TRANSFER_IN_IND
, ACT.URGENT_IND
, ACT.ACTIVITY_IND
, ACT.ACTIVITY_PROCESSING_CAL_DAYS_CNT ACTIVITY_PROCESSING_CAL_DAYS_CNT
, ACT.SELECTION_TRANSACTION_ID
, ACT.SELECTION_SEGMENT_ID
, ACT.DOCUMENT_ID
, ACT.document_received_date
, ACT.CALL_RECORD_ID
, ACT.EVENT_ID
, ACT.ACTIVITY_ID
--, ACT.COUNTY_LATITUDE
--, ACT.COUNTY_LONGITUDE
FROM --EMRS_F_ENROLL_ACTIVITY_SV ACT
(
SELECT
CASE WHEN SELT.SELECTION_STATUS_CODE IN 'acceptedByState' then coalesCe(SELT.ACCEPTED_DATE,SELT.STATUS_DATE)
     WHEN SELT.SELECTION_STATUS_CODE IN ('denied','invalid') THEN COALESCE(SELT.DENIED_DATE, SELT.STATUS_DATE)
     ELSE SELT.RECORD_DATE
     END RECORD_DATE
, LAST_DAY(CASE WHEN SELT.SELECTION_STATUS_CODE IN 'acceptedByState' then coalesCe(SELT.ACCEPTED_DATE,SELT.STATUS_DATE)
     WHEN SELT.SELECTION_STATUS_CODE IN ('denied','invalid') THEN COALESCE(SELT.DENIED_DATE, SELT.STATUS_DATE)
     ELSE SELT.RECORD_DATE
     END) RECORD_MONTH
, NULL RECORD_NAME
,SELT.PROGRAM_CODE
,selt.PLAN_TYPE
,case when SELT.TRANSACTION_TYPE_CD = 'NewEnrollment' then 'ENROLLMENT'
      WHEN SELT.TRANSACTION_TYPE_CD = 'Transfer' THEN 'TRANSFER_IN'
      WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then 'TRANSFER_IN'
      WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' then 'DISENROLLMENT'
      ELSE NULL END ACTIVITY_TYPE
, CASE WHEN DSNT.DISENROLL_TYPE_CD = 'WITHCAUSE' THEN 'DISENROLLMENT_WITHCAUSE'
       WHEN DSNT.DISENROLL_TYPE_CD = 'WITHOUTCAUSE' THEN 'DISENROLLMENT_WITHOUTCAUSE'
       ELSE NULL END SUB_ACTIVITY_TYPE
, CASE WHEN SELT.SELECTION_STATUS_CODE IN 'acceptedByState' then 'APPROVED'
     WHEN SELT.SELECTION_STATUS_CODE IN ('denied','invalid') THEN 'DENIED'
     WHEN SELT.SELECTION_STATUS_CODE IN ('readyToUpload','uploadedToState','pendToRecycle') then 'INPROCESS'
     ELSE SELT.SELECTION_STATUS_CODE
     END ACTIVITY_STATUS
, SELT.SELECTION_SOURCE_CD SELECTION_SOURCE_CODE
, case when SELT.TRANSACTION_TYPE_CD = 'NewEnrollment' then SELT.PLAN_ID
      WHEN SELT.TRANSACTION_TYPE_CD = 'Transfer' THEN SELT.PLAN_ID
      WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then PLNT.PLAN_ID
      ELSE NULL END  CURRENT_PLAN_ID
, case WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then SELT.PLAN_ID
       when SELT.TRANSACTION_TYPE_CD = 'Disenrollment' then SELT.PLAN_ID
      WHEN SELT.TRANSACTION_TYPE_CD = 'Transfer' THEN SELT.PRIOR_PLAN_ID
      ELSE NULL END PRIOR_PLAN_ID
, case when SELT.TRANSACTION_TYPE_CD = 'NewEnrollment' then SELT.PLAN_ID
      WHEN SELT.TRANSACTION_TYPE_CD = 'Transfer' THEN SELT.PLAN_ID
      WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then PLNT.PLAN_ID
      WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' then  PLNT.PLAN_ID 
      ELSE NULL END  TRAN_PLAN_ID
,DSNR.REASON_CD REASON_CD
,DSNT.DISENROLL_TYPE_CD
, CASE WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then SELT.COUNTY_CODE
       WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' then NVL(SELT.PRIOR_COUNTY_CD, SELT.COUNTY_CODE)
       ELSE SELT.COUNTY_CODE
       END COUNTY_CODE
, CASE WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then SELT.CSDA_CODE
       WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' then NVL(SELT.PRIOR_CSDA_CODE, SELT.CSDA_CODE)
       ELSE SELT.CSDA_CODE
       END CSDA_CODE
, CASE WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then SELT.STATE_CODE
       WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' then NVL(SELT.PRIOR_STATE_CODE, SELT.STATE_CODE)
       ELSE SELT.STATE_CODE
       END STATE_CODE
,SELT.MANAGED_CARE_STATUS
, CASE WHEN SELT.TRANSACTION_TYPE_CD = 'NewEnrollment' then 1 ELSE 0 END NEW_ENROLL_IND
, CASE WHEN SELT.TRANSACTION_TYPE_CD = 'Transfer' or (SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13') THEN 1 ELSE 0 END TRANSFER_IN_IND
, 0 TRANSFER_OUT_IND
, CASE WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE <> 'NFPHPCR13' THEN 1 ELSE 0 END DISENROLL_IND
, CASE WHEN SELT.TRANSACTION_TYPE_CD = 'NewEnrollment' and NVL(SELT.PROVIDER_ID, SELT.PROVIDER_ID_EXT) is not null then 1 else 0 end PCP_SELECTED_NEW_ENROLL_IND 
, CASE WHEN SELT.TRANSACTION_TYPE_CD = 'Transfer' and NVL(SELT.PROVIDER_ID, SELT.PROVIDER_ID_EXT) IS NOT NULL THEN 1 ELSE 0 END PCP_SELECTED_TRANSFER_IN_IND
, DSNR.urgent URGENT_IND
, case WHEN DSNT.DISENROLL_TYPE_CD = 'WITHOUTCAUSE' and  SELT.SELECTION_SOURCE_CD = 'C' and SELT.SELECTION_STATUS_CODE in 'acceptedByState' and SELT.DOCUMENT_ID is not null and SELT.MODIFIED_NAME = '-415' then SELT.RECORD_DATE - SELT.document_received_date 
       WHEN DSNT.DISENROLL_TYPE_CD = 'WITHOUTCAUSE' and  SELT.SELECTION_SOURCE_CD = 'C' and SELT.SELECTION_STATUS_CODE in 'acceptedByState' and SELT.DOCUMENT_ID is not null then SELT.ACCEPTED_DATE - SELT.document_received_date 
         else 0 end ACTIVITY_PROCESSING_CAL_DAYS_CNT
, case WHEN DSNT.DISENROLL_TYPE_CD = 'WITHOUTCAUSE' and  SELT.SELECTION_SOURCE_CD = 'C' and SELT.SELECTION_STATUS_CODE in 'acceptedByState' and SELT.DOCUMENT_ID is not null then 1 else 0 end ACTIVITY_IND
, SELT.SELECTION_TRANSACTION_ID
, SELT.SELECTION_SEGMENT_ID
, SELT.DOCUMENT_ID
, SELT.document_received_date
, SELT.CALL_RECORD_ID
, SELT.EVENT_ID
, NVL(TO_NUMBER(
  LPAD(TO_CHAR(NVL(SELECTION_TRANSACTION_ID,0)),10,'0')
  ||LPAD(TO_CHAR(NVL(EVENT_ID,0)),10,'0')
  ||LPAD(TO_CHAR(NVL(CALL_RECORD_ID,0)),10,'0')
  ||LPAD(TO_CHAR(NVL(DOCUMENT_ID,0)),10,'0')
  ||LPAD(TO_CHAR(NVL(SELECTION_SEGMENT_ID,0)),10,'0')
  ||'01'
  ),-1) ACTIVITY_ID
--, CL.LATITUDE COUNTY_LATITUDE
--, CL.LONGITUDE COUNTY_LONGITUDE
FROM MAXDAT_SUPPORT.EMRS_D_SELECTION_TRANS_SV SELT
LEFT JOIN MAXDAT_SUPPORT.EMRS_D_DISENROLL_REASON_SV DSNR ON DSNR.reason_cd = SELT.CHANGE_REASON_CODE
left join MAXDAT_SUPPORT.Emrs_d_Disenroll_Type_Sv dsnt on dsnt.DISENROLL_TYPE_CD = dsnr.DISENROLL_TYPE_CD
left join maxdat_support.emrs_d_plan_sv pln on pln.plan_id = (case WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then selt.plan_id else selt.prior_plan_id end)
left join maxdat_support.emrs_d_plan_sv plnt on plnt.plan_id = (case WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then 601 else selt.plan_id end)
--LEFT JOIN MAXDAT_SUPPORT.EMRS_D_COUNTY_LOCATIONS CL ON CL.COUNTY_CODE = SELT.COUNTY_CODE
where 1=1
and SELT.SELECTION_STATUS_CODE IN ('readyToUpload','uploadedToState','pendToRecycle','acceptedByState','denied','invalid')
--and selt.selection_transaction_id = 16422793
union all
SELECT
CASE WHEN SELT.SELECTION_STATUS_CODE IN 'acceptedByState' then coalesCe(SELT.ACCEPTED_DATE,SELT.STATUS_DATE)
     WHEN SELT.SELECTION_STATUS_CODE IN ('denied','invalid') THEN COALESCE(SELT.DENIED_DATE, SELT.STATUS_DATE)
     ELSE SELT.RECORD_DATE
     END RECORD_DATE
, LAST_DAY(CASE WHEN SELT.SELECTION_STATUS_CODE IN 'acceptedByState' then coalesCe(SELT.ACCEPTED_DATE,SELT.STATUS_DATE)
     WHEN SELT.SELECTION_STATUS_CODE IN ('denied','invalid') THEN COALESCE(SELT.DENIED_DATE, SELT.STATUS_DATE)
     ELSE SELT.RECORD_DATE
     END) RECORD_MONTH
, NULL RECORD_NAME
,SELT.PROGRAM_CODE
,selt.PLAN_TYPE
,case when SELT.TRANSACTION_TYPE_CD = 'NewEnrollment' then 'ENROLLMENT'
      WHEN SELT.TRANSACTION_TYPE_CD = 'Transfer' THEN 'TRANSFER_OUT'
      WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then 'TRANSFER_OUT'
      WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' then 'DISENROLLMENT'
      ELSE NULL END ACTIVITY_TYPE
, CASE WHEN DSNT.DISENROLL_TYPE_CD = 'WITHCAUSE' THEN 'DISENROLLMENT_WITHCAUSE'
       WHEN DSNT.DISENROLL_TYPE_CD = 'WITHOUTCAUSE' THEN 'DISENROLLMENT_WITHOUTCAUSE'
       ELSE NULL END SUB_ACTIVITY_TYPE
, CASE WHEN SELT.SELECTION_STATUS_CODE IN 'acceptedByState' then 'APPROVED'
     WHEN SELT.SELECTION_STATUS_CODE IN ('denied','invalid') THEN 'DENIED'
     WHEN SELT.SELECTION_STATUS_CODE IN ('readyToUpload','uploadedToState','pendToRecycle') then 'INPROCESS'
     ELSE SELT.SELECTION_STATUS_CODE
     END ACTIVITY_STATUS
, SELT.SELECTION_SOURCE_CD SELECTION_SOURCE_CODE
, case when SELT.TRANSACTION_TYPE_CD = 'NewEnrollment' then SELT.PLAN_ID
      WHEN SELT.TRANSACTION_TYPE_CD = 'Transfer' THEN SELT.PLAN_ID
      WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then PLN.PLAN_ID
      ELSE NULL END  CURRENT_PLAN_ID
, case WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then SELT.PLAN_ID
       when SELT.TRANSACTION_TYPE_CD = 'Disenrollment' then SELT.PLAN_ID
      WHEN SELT.TRANSACTION_TYPE_CD = 'Transfer' THEN SELT.PRIOR_PLAN_ID
      ELSE NULL END PRIOR_PLAN_ID
, case when SELT.TRANSACTION_TYPE_CD = 'NewEnrollment' then NULL
      WHEN SELT.TRANSACTION_TYPE_CD = 'Transfer' THEN SELT.PRIOR_PLAN_ID
      WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then SELT.PLAN_ID
      WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' then SELT.PLAN_ID
      ELSE NULL END  TRAN_PLAN_ID
,DSNR.REASON_CD
,DSNT.DISENROLL_TYPE_CD
, CASE WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then SELT.COUNTY_CODE
       WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' then NVL(SELT.PRIOR_COUNTY_CD, SELT.COUNTY_CODE)
       ELSE SELT.COUNTY_CODE
       END COUNTY_CODE
, CASE WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then SELT.CSDA_CODE
       WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' then NVL(SELT.PRIOR_CSDA_CODE, SELT.CSDA_CODE)
       ELSE SELT.CSDA_CODE
       END CSDA_CODE
, CASE WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then SELT.STATE_CODE
       WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' then NVL(SELT.PRIOR_STATE_CODE, SELT.STATE_CODE)
       ELSE SELT.STATE_CODE
       END STATE_CODE
,SELT.MANAGED_CARE_STATUS
, 0 NEW_ENROLL_IND
, 0 TRANSFER_IN_IND
, CASE WHEN SELT.TRANSACTION_TYPE_CD = 'Transfer' or (SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13') THEN 1 ELSE 0 END TRANSFER_OUT_IND
, 0 DISENROLL_IND
, 0 PCP_SELECTED_NEW_ENROLL_IND
, 0 PCP_SELECTED_TRANSFER_IN_IND
, DSNR.urgent URGENT_IND
, 0 ACTIVITY_PROCESSING_CAL_DAYS_CNT
, 0 ACTIVITY_IND
, SELT.SELECTION_TRANSACTION_ID
, SELT.SELECTION_SEGMENT_ID
, SELT.DOCUMENT_ID
, SELT.document_received_date
, SELT.CALL_RECORD_ID
, SELT.EVENT_ID
, NVL(TO_NUMBER(
  LPAD(TO_CHAR(NVL(SELECTION_TRANSACTION_ID,0)),10,'0')
  ||LPAD(TO_CHAR(NVL(EVENT_ID,0)),10,'0')
  ||LPAD(TO_CHAR(NVL(CALL_RECORD_ID,0)),10,'0')
  ||LPAD(TO_CHAR(NVL(DOCUMENT_ID,0)),10,'0')
  ||LPAD(TO_CHAR(NVL(SELECTION_SEGMENT_ID,0)),10,'0')
  ||'02'),-1) ACTIVITY_ID
--, CL.LATITUDE COUNTY_LATITUDE
--, CL.LONGITUDE COUNTY_LONGITUDE
FROM MAXDAT_SUPPORT.EMRS_D_SELECTION_TRANS_SV SELT
LEFT JOIN MAXDAT_SUPPORT.EMRS_D_DISENROLL_REASON_SV DSNR ON DSNR.reason_cd = SELT.CHANGE_REASON_CODE
left join MAXDAT_SUPPORT.Emrs_d_Disenroll_Type_Sv dsnt on dsnt.DISENROLL_TYPE_CD = dsnr.DISENROLL_TYPE_CD
left join maxdat_support.emrs_d_plan_sv pln on pln.plan_id = (case WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then selt.plan_id else selt.prior_plan_id end)
left join maxdat_support.emrs_d_plan_sv plnt on plnt.plan_id = (case WHEN SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13' then 601 else selt.plan_id end)
--LEFT JOIN MAXDAT_SUPPORT.EMRS_D_COUNTY_LOCATIONS CL ON CL.COUNTY_CODE = SELT.COUNTY_CODE
where 1=1
and SELT.SELECTION_STATUS_CODE IN ('readyToUpload','uploadedToState','pendToRecycle','acceptedByState','denied','invalid')
and (SELT.TRANSACTION_TYPE_CD = 'Transfer' or (SELT.TRANSACTION_TYPE_CD = 'Disenrollment' and CHANGE_REASON_CODE = 'NFPHPCR13'))
--and selt.selection_transaction_id = 16422793
) ACT
;
GRANT SELECT ON EMRS_F_ENROLLMENT_ACTIVITY_INSTANCE_BY_DATE TO MAXDATSUPPORT_READ_ONLY;
GRANT SELECT ON EMRS_F_ENROLLMENT_ACTIVITY_INSTANCE_BY_DATE TO MAXDAT_REPORTS;

--select * from EMRS_F_ENROLLMENT_ACTIVITY_INSTANCE_BY_DATE
