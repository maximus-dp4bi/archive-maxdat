SELECTdistinct pa.CaseId, FIRST_VALUE(a.Id) over(partition by pa.CaseId, pa.Id order by a.CreatedDate) FurtherAssessmentId, FIRST_VALUE(a.CreatedDate) over(partition by pa.CaseId, pa.Id order by a.CreatedDate) FurtherAssessmentCreatedDate, pa.Id PriorPublishedAssessmentId, pa.FirstPublishDate PriorPublishedAssessmentFirstPublishDatefrom [assessment].[assessment] ainner join (select distinct a.*, min(cn1.CreatedDate) over(partition by a.Id) as FirstPublishDatefrom  (select distinct aa.CaseId, aa.Id, aa.FinishDate, aa.CreatedDate, aa.DateOfAssessment, lead(aa.FinishDate) over(partition by aa.CaseId order by aa.VersionNumber) NextAssessFinishDatefrom [HWSInternal].[Assessment].[Assessment] aa  inner join [HWSInternal].[Assessment].[ReturnToWorkPlan] rtwp on rtwp.AssessmentId = aa.Id  inner join [HWSInternal].[casE].[CASE] c on aa.CaseId = c.IdWhere aa.IsPublished = 1  and aa.FinishDate is not null) a  inner join [HWSInternal].[CASE].[CASENOTE] cn1 ON                a.CaseId = cn1.CaseId and cn1.CreatedBy = 'Service: Return To Work Plan'                and cn1.comment like 'RTWP%Sent'                and cn1.CreatedDate >= a.FinishDate                and cn1.CreatedDate < coalesce(a.NextAssessFinishDate,getdate())) pa on a.CaseId = pa.CaseIdand a.CreatedDate > pa.FirstPublishDateand pa.FirstPublishDate is not nulland (a.FinishDate is null or a.FinishDate > pa.FinishDate)