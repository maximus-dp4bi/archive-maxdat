CREATE OR REPLACE VIEW MAXDAT.F_MW_STAFF_PERFORMANCE_BY_DAY_SV
AS select
D_DATE as D_DAY,
staff.STAFF_ID
,case when curr_owner_staff_id = 0 then 'system' when curr_owner_staff_id = -1 then 'unknown staff'
else trim(staff.first_name) || ' ' || (case when staff.middle_name is not null then (trim(staff.middle_name) || ' ') else '' end) || trim(staff.last_name) end as STAFF_NAME
,super.SUPERVISOR_PERSON_ID as SUPERVISOR_ID
,case when super.supervisor_person_id = -1 then 'supervisor unknown'
else (select trim(st.first_name) || ' ' || (case when st.middle_name is not null then (trim(st.middle_name) || ' ') else '' end) || trim(st.last_name) from D_STAFF st where st.staff_id = super.SUPERVISOR_PERSON_ID) end as SUPERVISOR_NAME
,TASK_TYPE_ID
--appeal attributes
,priorities.PRIORITY_NAME as APPEAL_PRIORITY
,parts.PART_NAME as APPEAL_PART
,stages.STAGE_NAME as APPEAL_STAGE
,issues.ISSUE_NAME as APPEAL_ISSUE
,items.ITEM_SERVICE_NAME as APPEAL_ITEM
,types.TYPE_NAME as APPEAL_TYPE
--,dismissals.DISMISSAL_NAME as APPEAL_DISMISSAL
, case when dismissals.dismissal_id is null then 'No' else dismissals.dismissal_name end as APPEAL_DISMISSAL
,dismissal_reasons.DISMISS_REASON_NAME as APPEAL_DISMISSAL_REASON
,case when (auto_forward is not null and auto_forward <> 0 ) then 'Y' else 'N' end as AUTO_FORWARD
,reasons.REASON_NAME as APPEAL_REASON
, EMPLOYEE_COMPLETION_COUNT
, CURRENT_CLAIM_COUNT
,round(EMPLOYEE_TOTAL_HANDLE_TIME,6) as EMPLOYEE_TOTAL_HANDLE_TIME
,round(EMPLOYEE_MIN_HANDLE_TIME,6) as EMPLOYEE_MIN_HANDLE_TIME
,round(EMPLOYEE_MAX_HANDLE_TIME,6) as EMPLOYEE_MAX_HANDLE_TIME
,TEAM_COMPLETION_COUNT
,round(TEAM_TOTAL_HANDLE_TIME,6) as TEAM_TOTAL_HANDLE_TIME
,round(TEAM_MIN_HANDLE_TIME,6) as TEAM_MIN_HANDLE_TIME
,round(TEAM_MAX_HANDLE_TIME,6) as TEAM_MAX_HANDLE_TIME
,PROJECT_COMPLETION_COUNT
,round(PROJECT_TOTAL_HANDLE_TIME,6) as PROJECT_TOTAL_HANDLE_TIME
,round(PROJECT_MIN_HANDLE_TIME,6) as PROJECT_MIN_HANDLE_TIME
,round(PROJECT_MAX_HANDLE_TIME,6) as PROJECT_MAX_HANDLE_TIME
from(
WITH EMPS as (
SELECT
dd.D_DATE
,ti.TASK_TYPE_ID
,ai.APPEAL_PRIORITY_ID
,ai.APPEAL_PART_ID
,ai.APPEAL_STAGE
,ai.APPEAL_ISSUE
,ai.APPEAL_ITEM
,ai.APPEAL_TYPE
,ai.APPEAL_DISMISSAL
,ai.APPEAL_DISMISSAL_REASON
,ai.AUTO_FORWARD
,ai.APPEAL_REASON
,ti.CURR_TEAM_ID
,ti.CURR_OWNER_STAFF_ID
,count(ti.MW_BI_ID ) as EMPLOYEE_COMPLETION_COUNT
,sum (ti.HANDLE_TIME) as EMPLOYEE_TOTAL_HANDLE_TIME
,min (ti.HANDLE_TIME) as EMPLOYEE_MIN_HANDLE_TIME
,max (ti.HANDLE_TIME) as EMPLOYEE_MAX_HANDLE_TIME
FROM
D_MW_TASK_INSTANCE ti
JOIN D_DATES dd ON trunc(ti.COMPLETE_DATE) = trunc(dd.D_DATE)
JOIN D_MW_APPEAL_INSTANCE ai ON ti.SOURCE_REFERENCE_ID = ai.APPEAL_ID
GROUP BY
dd.D_DATE
,ti.TASK_TYPE_ID
,ai.APPEAL_PRIORITY_ID
,ai.APPEAL_PART_ID
,ai.APPEAL_STAGE
,ai.APPEAL_ISSUE
,ai.APPEAL_ITEM
,ai.APPEAL_TYPE
,ai.APPEAL_DISMISSAL
,ai.APPEAL_DISMISSAL_REASON
,ai.AUTO_FORWARD
,ai.APPEAL_REASON
,ti.CURR_TEAM_ID
,ti.CURR_OWNER_STAFF_ID
),
TEAMS as (
SELECT
dd.D_DATE
,ti.TASK_TYPE_ID
,ai.APPEAL_PRIORITY_ID
,ai.APPEAL_PART_ID
,ai.APPEAL_STAGE
,ai.APPEAL_ISSUE
,ai.APPEAL_ITEM
,ai.APPEAL_TYPE
,ai.APPEAL_DISMISSAL
,ai.APPEAL_DISMISSAL_REASON
,ai.AUTO_FORWARD
,ai.APPEAL_REASON
,ti.CURR_TEAM_ID
,count(ti.MW_BI_ID ) as TEAM_COMPLETION_COUNT
,sum (ti.HANDLE_TIME) as TEAM_TOTAL_HANDLE_TIME
,min (ti.HANDLE_TIME) as TEAM_MIN_HANDLE_TIME
,max (ti.HANDLE_TIME) as TEAM_MAX_HANDLE_TIME
FROM
D_MW_TASK_INSTANCE ti
JOIN D_DATES dd ON trunc(ti.COMPLETE_DATE) = trunc(dd.D_DATE)
JOIN D_MW_APPEAL_INSTANCE ai ON ti.SOURCE_REFERENCE_ID = ai.APPEAL_ID
GROUP BY
dd.D_DATE
,ti.TASK_TYPE_ID
,ai.APPEAL_PRIORITY_ID
,ai.APPEAL_PART_ID
,ai.APPEAL_STAGE
,ai.APPEAL_ISSUE
,ai.APPEAL_ITEM
,ai.APPEAL_TYPE
,ai.APPEAL_DISMISSAL
,ai.APPEAL_DISMISSAL_REASON
,ai.AUTO_FORWARD
,ai.APPEAL_REASON
,ti.CURR_TEAM_ID
),
PROJECT as (
SELECT
dd.D_DATE
,ti.TASK_TYPE_ID
,ai.APPEAL_PRIORITY_ID
,ai.APPEAL_PART_ID
,ai.APPEAL_STAGE
,ai.APPEAL_ISSUE
,ai.APPEAL_ITEM
,ai.APPEAL_TYPE
,ai.APPEAL_DISMISSAL
,ai.APPEAL_DISMISSAL_REASON
,ai.AUTO_FORWARD
,ai.APPEAL_REASON
,count(ti.MW_BI_ID ) as PROJECT_COMPLETION_COUNT
,sum (ti.HANDLE_TIME) as PROJECT_TOTAL_HANDLE_TIME
,min (ti.HANDLE_TIME) as PROJECT_MIN_HANDLE_TIME
,max (ti.HANDLE_TIME) as PROJECT_MAX_HANDLE_TIME
FROM
D_MW_TASK_INSTANCE ti
JOIN D_DATES dd ON trunc(ti.COMPLETE_DATE) = trunc(dd.D_DATE)
JOIN D_MW_APPEAL_INSTANCE ai ON ti.SOURCE_REFERENCE_ID = ai.APPEAL_ID
GROUP BY
dd.D_DATE
,ti.TASK_TYPE_ID
,ai.APPEAL_PRIORITY_ID
,ai.APPEAL_PART_ID
,ai.APPEAL_STAGE
,ai.APPEAL_ISSUE
,ai.APPEAL_ITEM
,ai.APPEAL_TYPE
,ai.APPEAL_DISMISSAL
,ai.APPEAL_DISMISSAL_REASON
,ai.AUTO_FORWARD
,ai.APPEAL_REASON
),
EMPS_CLAIM_COUNT as (
SELECT dd.D_DATE
,ti.TASK_TYPE_ID
,ai.APPEAL_PRIORITY_ID
,ai.APPEAL_PART_ID
,ai.APPEAL_STAGE
,ai.APPEAL_ISSUE
,ai.APPEAL_ITEM
,ai.APPEAL_TYPE
,ai.APPEAL_DISMISSAL
,ai.APPEAL_DISMISSAL_REASON
,ai.AUTO_FORWARD
,ai.APPEAL_REASON
,staff.STAFF_ID,
count(ti.MW_BI_ID) as CURRENT_CLAIM_COUNT
FROM D_MW_TASK_INSTANCE ti
JOIN D_DATES dd ON ti.CREATE_DATE <= dd.D_DATE
JOIN D_MW_APPEAL_INSTANCE ai ON ti.SOURCE_REFERENCE_ID = ai.APPEAL_ID
JOIN D_STAFF staff ON ti.CURR_OWNER_STAFF_ID = staff.STAFF_ID
WHERE ti.CURR_TASK_STATUS = 'CLAIMED'
GROUP BY dd.D_DATE, ti.TASK_TYPE_ID
,ai.APPEAL_PRIORITY_ID
,ai.APPEAL_PART_ID
,ai.APPEAL_STAGE
,ai.APPEAL_ISSUE
,ai.APPEAL_ITEM
,ai.APPEAL_TYPE
,ai.APPEAL_DISMISSAL
,ai.APPEAL_DISMISSAL_REASON
,ai.AUTO_FORWARD
,ai.APPEAL_REASON
,staff.STAFF_ID
)
SELECT EMPS.D_DATE, EMPS.TASK_TYPE_ID
,EMPS.APPEAL_PRIORITY_ID
,EMPS.APPEAL_PART_ID
,EMPS.APPEAL_STAGE
,EMPS.APPEAL_ISSUE
,EMPS.APPEAL_ITEM
,EMPS.APPEAL_TYPE
,EMPS.APPEAL_DISMISSAL
,EMPS.APPEAL_DISMISSAL_REASON
,EMPS.AUTO_FORWARD
,EMPS.APPEAL_REASON
, EMPS.CURR_TEAM_ID, EMPS.CURR_OWNER_STAFF_ID
, EMPS.EMPLOYEE_COMPLETION_COUNT
, nvl(EMPS_CLAIM_COUNT.CURRENT_CLAIM_COUNT,0) as CURRENT_CLAIM_COUNT
,EMPS.EMPLOYEE_TOTAL_HANDLE_TIME
,EMPS.EMPLOYEE_MIN_HANDLE_TIME
,EMPS.EMPLOYEE_MAX_HANDLE_TIME
,TEAMS.TEAM_COMPLETION_COUNT
,TEAMS.TEAM_TOTAL_HANDLE_TIME
,TEAMS.TEAM_MIN_HANDLE_TIME
,TEAMS.TEAM_MAX_HANDLE_TIME
,PROJECT.PROJECT_COMPLETION_COUNT
,PROJECT.PROJECT_TOTAL_HANDLE_TIME
,PROJECT.PROJECT_MIN_HANDLE_TIME
,PROJECT.PROJECT_MAX_HANDLE_TIME
FROM
EMPS
JOIN TEAMS ON EMPS.D_DATE = TEAMS.D_DATE
 AND EMPS.TASK_TYPE_ID = TEAMS.TASK_TYPE_ID
 AND decode(EMPS.APPEAL_PRIORITY_ID,TEAMS.APPEAL_PRIORITY_ID,1,0)=1
 AND decode(EMPS.APPEAL_PART_ID,TEAMS.APPEAL_PART_ID,1,0)=1
 AND decode(EMPS.APPEAL_STAGE,TEAMS.APPEAL_STAGE,1,0)=1
 AND decode(EMPS.APPEAL_ISSUE,TEAMS.APPEAL_ISSUE,1,0)=1
 AND decode(EMPS.APPEAL_ITEM,TEAMS.APPEAL_ITEM,1,0)=1
 AND decode(EMPS.APPEAL_TYPE,TEAMS.APPEAL_TYPE,1,0)=1
 AND decode(EMPS.APPEAL_DISMISSAL,TEAMS.APPEAL_DISMISSAL,1,0)=1
 AND decode(EMPS.APPEAL_DISMISSAL_REASON,TEAMS.APPEAL_DISMISSAL_REASON,1,0)=1
 AND decode(EMPS.AUTO_FORWARD,TEAMS.AUTO_FORWARD,1,0)=1
 AND decode(EMPS.APPEAL_REASON,TEAMS.APPEAL_REASON,1,0)=1
AND decode(EMPS.CURR_TEAM_ID,TEAMS.CURR_TEAM_ID,1,0)=1
JOIN PROJECT ON EMPS.D_DATE = PROJECT.D_DATE
AND EMPS.TASK_TYPE_ID = PROJECT.TASK_TYPE_ID
 AND decode(EMPS.APPEAL_PRIORITY_ID,PROJECT.APPEAL_PRIORITY_ID,1,0)=1
 AND decode(EMPS.APPEAL_PART_ID,PROJECT.APPEAL_PART_ID,1,0)=1
 AND decode(EMPS.APPEAL_STAGE,PROJECT.APPEAL_STAGE,1,0)=1
 AND decode(EMPS.APPEAL_ISSUE,PROJECT.APPEAL_ISSUE,1,0)=1
 AND decode(EMPS.APPEAL_ITEM,PROJECT.APPEAL_ITEM,1,0)=1
 AND decode(EMPS.APPEAL_TYPE,PROJECT.APPEAL_TYPE,1,0)=1
 AND decode(EMPS.APPEAL_DISMISSAL,PROJECT.APPEAL_DISMISSAL,1,0)=1
 AND decode(EMPS.APPEAL_DISMISSAL_REASON,PROJECT.APPEAL_DISMISSAL_REASON,1,0)=1
 AND decode(EMPS.AUTO_FORWARD,PROJECT.AUTO_FORWARD,1,0)=1
 AND decode(EMPS.APPEAL_REASON,PROJECT.APPEAL_REASON,1,0)=1
LEFT JOIN EMPS_CLAIM_COUNT ON EMPS.CURR_OWNER_STAFF_ID = EMPS_CLAIM_COUNT.STAFF_ID
AND EMPS.D_DATE = EMPS_CLAIM_COUNT.D_DATE
AND EMPS.TASK_TYPE_ID = EMPS_CLAIM_COUNT.TASK_TYPE_ID
 AND decode(EMPS.APPEAL_PRIORITY_ID,EMPS_CLAIM_COUNT.APPEAL_PRIORITY_ID,1,0)=1
 AND decode(EMPS.APPEAL_PART_ID,EMPS_CLAIM_COUNT.APPEAL_PART_ID,1,0)=1
 AND decode(EMPS.APPEAL_STAGE,EMPS_CLAIM_COUNT.APPEAL_STAGE,1,0)=1
 AND decode(EMPS.APPEAL_ISSUE,EMPS_CLAIM_COUNT.APPEAL_ISSUE,1,0)=1
 AND decode(EMPS.APPEAL_ITEM,EMPS_CLAIM_COUNT.APPEAL_ITEM,1,0)=1
 AND decode(EMPS.APPEAL_TYPE,EMPS_CLAIM_COUNT.APPEAL_TYPE,1,0)=1
 AND decode(EMPS.APPEAL_DISMISSAL,EMPS_CLAIM_COUNT.APPEAL_DISMISSAL,1,0)=1
 AND decode(EMPS.APPEAL_DISMISSAL_REASON,EMPS_CLAIM_COUNT.APPEAL_DISMISSAL_REASON,1,0)=1
 AND decode(EMPS.AUTO_FORWARD, EMPS_CLAIM_COUNT.AUTO_FORWARD,1,0)=1
 AND decode(EMPS.APPEAL_REASON,EMPS_CLAIM_COUNT.APPEAL_REASON,1,0)=1
)
LEFT OUTER JOIN D_STAFF staff ON CURR_OWNER_STAFF_ID = staff.STAFF_ID
LEFT OUTER JOIN D_SUPERVISOR super ON CURR_OWNER_STAFF_ID = super.PERSON_ID
LEFT OUTER JOIN D_APPEAL_PRIORITIES priorities ON APPEAL_PRIORITY_ID = priorities.PRIORITY_ID
LEFT OUTER JOIN D_APPEAL_PARTS parts ON APPEAL_PART_ID = parts.PART_ID
LEFT OUTER JOIN D_APPEAL_ISSUES issues ON APPEAL_ISSUE = issues.ISSUE_ID
LEFT OUTER JOIN D_APPEAL_ITEM_SERVICES items ON APPEAL_ITEM = items.ITEM_SERVICE_ID
LEFT OUTER JOIN D_APPEAL_STAGES stages ON APPEAL_STAGE = stages.STAGE_ID
LEFT OUTER JOIN D_APPEAL_TYPES types ON APPEAL_TYPE = types.TYPE_ID
LEFT OUTER JOIN D_APPELLANT_DISMISSALS dismissals ON APPEAL_DISMISSAL = dismissals.DISMISSAL_ID
LEFT OUTER JOIN D_APPELLANT_DISMISS_REASONS dismissal_reasons ON APPEAL_DISMISSAL_REASON = dismissal_reasons.DISMISS_REASON_ID
--LEFT OUTER JOIN D_APPEAL_AUTO_FORWARDS auto_forwards ON AUTO_FORWARD = auto_forwards.AUTO_FORWARD_ID
LEFT OUTER JOIN D_APPEAL_REASONS reasons ON APPEAL_REASON = reasons.REASON_ID;


GRANT SELECT ON MAXDAT.F_MW_APPEAL_INSTANCE_BY_DATE_SV TO MAXDAT_READ_ONLY;