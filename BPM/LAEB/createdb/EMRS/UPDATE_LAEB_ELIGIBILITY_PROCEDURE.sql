CREATE OR REPLACE PROCEDURE MAXDAT_SUPPORT.UPDATE_D_CLIENT_ELIGIBILITY
AS
BEGIN
    execute immediate 'TRUNCATE TABLE MAXDAT_SUPPORT.D_CLIENT_ELIGIBILITY'; 
    INSERT
INTO D_CLIENT_ELIGIBILITY
  (
    ELIG_SEGMENT_AND_DETAILS_ID,
    SEGMENT_TYPE_CD,
    CLIENT_ID,
    ME_START_DATE,
    ME_END_DATE,
    ME_START_ND,
    ME_END_ND,
    AID_CATEGORY,
    TYPE_CASE,
    AC_TC,
    COA,
    PRIOR_START_DATE,
    PRIOR_END_DATE,
    PRIOR_COA,
    PRIOR_AC,
    PRIOR_TC,
    PRIOR_ESAD_ID,
    PREGNANCY_FLAG,
    CLOSE_REASON,
    SEQUENCE_ID,
    LAST_ACTIVITY,
    APPROVAL_CD,
    SEGMENT_CREATE_DATE,
    SEQUENCE_NUM,
    COMPARABLE_KEY
  )

SELECT esad3.ELIG_SEGMENT_AND_DETAILS_ID ,
  esad3.SEGMENT_TYPE_CD ,
  esad3.CLIENT_ID ,
  esad3.ME_START_DATE ,
  esad3.ME_END_DATE ,
  esad3.ME_START_ND ,
  esad3.ME_END_ND ,
  esad3.AID_CATEGORY ,
  esad3.TYPE_CASE ,
  esad3.AID_CATEGORY || '/' || esad3.TYPE_CASE AS AC_TC,
  esad3.COA ,
  esad3.PRIOR_START_DATE AS PRIOR_START_DATE,
  esad3.PRIOR_END_DATE AS PRIOR_END_DATE,
  CASE WHEN (esad3.ME_START_DATE - esad3.PRIOR_END_DATE) <= 95 THEN esad3.PRIOR_COA ELSE NULL END AS PRIOR_COA,
  CASE WHEN (esad3.ME_START_DATE - esad3.PRIOR_END_DATE) <= 95 THEN esad3.PRIOR_AC ELSE NULL END AS PRIOR_AC,
  CASE WHEN (esad3.ME_START_DATE - esad3.PRIOR_END_DATE) <= 95 THEN esad3.PRIOR_TC ELSE NULL END AS PRIOR_TC,
  esad3.PRIOR_ESAD_ID ,
  CASE WHEN esad3.AID_CATEGORY = '03' and esad3.TYPE_CASE in ('013','053','104','127') THEN 1 ELSE 0 END AS PREGNANCY_FLAG,
  esad3.CLOSE_REASON ,
  esad3.SEQUENCE_ID ,
  esad3.LAST_ACTIVITY ,
  esad3.APPROVAL_CD ,
  esad3.SEGMENT_CREATE_DATE ,
  RANK() OVER(PARTITION BY esad3.CLIENT_ID ORDER BY esad3.SEQUENCE_NUM) AS SEQUENCE_NUM ,
  esad3.COMPARABLE_KEY 
FROM
(SELECT esad2.ELIG_SEGMENT_AND_DETAILS_ID,
    esad2.SEGMENT_TYPE_CD,
    esad2.CLIENT_ID,
    esad2.ME_START_DATE,
    esad2.ME_END_DATE,
    esad2.ME_START_ND,
    esad2.ME_END_ND,
    esad2.AID_CATEGORY,
    esad2.TYPE_CASE,
    esad2.COA,
    LEAD( esad2.ME_START_DATE, 1) OVER (PARTITION BY esad2.CLIENT_ID ORDER BY esad2.SEQUENCE_NUM) PRIOR_START_DATE,
    LEAD( esad2.ME_END_DATE, 1) OVER (PARTITION BY esad2.CLIENT_ID ORDER BY esad2.SEQUENCE_NUM) PRIOR_END_DATE,
    LEAD( esad2.COA, 1) OVER (PARTITION BY esad2.CLIENT_ID ORDER BY esad2.SEQUENCE_NUM) PRIOR_COA,   --priors are only populated when there is less than 95 days between the last elig seg and the start of the current elig seg
    LEAD( esad2.AID_CATEGORY, 1) OVER (PARTITION BY esad2.CLIENT_ID ORDER BY esad2.SEQUENCE_NUM) PRIOR_AC,
    LEAD( esad2.TYPE_CASE, 1) OVER (PARTITION BY esad2.CLIENT_ID ORDER BY esad2.SEQUENCE_NUM) PRIOR_TC,
    LEAD( esad2.ELIG_SEGMENT_AND_DETAILS_ID, 1) OVER (PARTITION BY esad2.CLIENT_ID ORDER BY esad2.SEQUENCE_NUM) PRIOR_ESAD_ID,
    esad2.CLOSE_REASON,
    esad2.SEQUENCE_ID,
    esad2.LAST_ACTIVITY,
    esad2.APPROVAL_CD,
    esad2.SEGMENT_CREATE_DATE,
    esad2.SEQUENCE_NUM,
    esad2.COMPARABLE_KEY
  FROM
  (SELECT esad.SEGMENT_TYPE_CD,
    esad.CLIENT_ID,
    esad.SEGMENT_DETAIL_VALUE_1 AS AID_CATEGORY,
    esad.SEGMENT_DETAIL_VALUE_2 AS TYPE_CASE,
    m.ACUTE_COA AS COA,
    MIN(esad.SEGMENT_DETAIL_VALUE_5) AS SEQUENCE_ID,
    MAX(esad.ELIG_SEGMENT_AND_DETAILS_ID) AS ELIG_SEGMENT_AND_DETAILS_ID,
    MIN(esad.START_DATE) AS ME_START_DATE,
    MAX(esad.END_DATE) AS ME_END_DATE,
    MIN(esad.START_ND) AS ME_START_ND,
    MAX(esad.END_ND) AS ME_END_ND,
    MAX(esad.SEGMENT_DETAIL_VALUE_3) AS CLOSE_REASON,
    MAX(esad.SEGMENT_DETAIL_VALUE_6) AS LAST_ACTIVITY,
    MAX(esad.SEGMENT_DETAIL_VALUE_7) AS APPROVAL_CD,
    MIN(esad.SEGMENT_DETAIL_VALUE_8) AS SEGMENT_CREATE_DATE,
    MIN(esad.SEQUENCE_NUM) AS SEQUENCE_NUM,
    esad.COMPARABLE_KEY
  FROM EB.ELIG_SEGMENT_AND_DETAILS esad
  LEFT JOIN MVX_XWALK m ON (esad.SEGMENT_DETAIL_VALUE_1 = m.AID_CATEGORY AND esad.SEGMENT_DETAIL_VALUE_2 = m.TYPE_CASE)
  WHERE esad.SEGMENT_TYPE_CD = 'ME'
  AND CASE WHEN esad.SEGMENT_DETAIL_VALUE_1 = '17' AND esad.SEGMENT_DETAIL_VALUE_2 = '095' AND esad.SEQUENCE_NUM <> 1 THEN 1 ELSE 0 END = 0
  GROUP BY esad.SEGMENT_TYPE_CD,
    esad.CLIENT_ID,
    esad.SEGMENT_DETAIL_VALUE_1,
    esad.SEGMENT_DETAIL_VALUE_2,
    m.ACUTE_COA,
    esad.COMPARABLE_KEY) esad2) esad3;
COMMIT;
END;


