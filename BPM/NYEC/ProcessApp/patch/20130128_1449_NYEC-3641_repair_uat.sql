-- Drop direct triggers.
drop trigger TRG_AI_NYEC_ETL_PROCESS_APP;
drop trigger TRG_AU_NYEC_ETL_PROCESS_APP;

-- Stop control job.
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_CONTROL_JOB;

-- Stop ''STARTED' jobs.  (will take about 12 minutes to run)
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4634);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4635);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4636);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4637);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4638);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4639);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4640);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4641);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4642);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4643);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4644);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4645);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4646);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4647);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4648);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4649);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4650);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4651);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4652);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4653);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4654);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4655);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4656);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4657);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4658);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4659);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4660);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4661);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4662);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4663);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4664);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4665);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4666);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4667);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4668);
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_JOB_BY_ID(4669);

-- Stop jobs with incorrect meta-data.
update PROCESS_BPM_QUEUE_JOB
set 
  STATUS = 'STOPPED',
  END_DATE = sysdate,
  STATUS_DATE = sysdate
where
  STATUS = 'STARTED';
  
commit;

-- Stop all jobs.  (will take about 15 minutes to run)
execute PROCESS_BPM_QUEUE_JOB_CONTROL.STOP_ALL_JOBS;
    
-- Cleanup duplicate instances.
declare
  cursor c_bi_ids 
  is 
  select bi.BI_ID
  from 
    BPM_INSTANCE bi,
    (select IDENTIFIER
     from BPM_INSTANCE
     where BSL_ID = 2
     group by IDENTIFIER
     having count(IDENTIFIER) > 1) dup_identifiers
  where 
    bi.IDENTIFIER = dup_identifiers.IDENTIFIER
    and BIL_ID = 3;
begin
  for r_bi_id in c_bi_ids
  loop
  
    delete from BPM_INSTANCE_ATTRIBUTE
    where BI_ID = r_bi_id.BI_ID;

    delete from BPM_UPDATE_EVENT 
    where BI_ID = r_bi_id.BI_ID;

    delete from BPM_INSTANCE 
    where BI_ID = r_bi_id.BI_ID
      and BEM_ID = 2 
      and BIL_ID = 3;
    
    commit;
    
  end loop;
end;
/

-- Fix BIL_ID;
update BPM_INSTANCE
set BIL_ID = 2
where BEM_ID = 2 and BIL_ID != 2;

commit;

-- Fix stuck processing queue rows.
update BPM_UPDATE_EVENT_QUEUE
set PROCESS_BUEQ_ID = null
where PROCESS_BUEQ_ID is not null;

commit;
