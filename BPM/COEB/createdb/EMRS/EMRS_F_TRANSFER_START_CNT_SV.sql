CREATE OR REPLACE VIEW EMRS_F_TRANSFER_START_CNT_SV AS
SELECT 
  T.REC_MONTH RECORD_DATE
 ,T.PROGRAM_CODE
 ,T.PLAN_TYPE
 , T.plan_Service_type_Cd
 , T.PLAN_ID
  , T.PROVIDER_ORG_TYPE
  , T.provider_org_CD
  , SUM(T.ACC_PROVIDER_CHG) ACC_PROVIDER_CHG_CNT
  , SUM(T.ACC_PROV_RAE_CHG) ACC_PROV_RAE_CHG_CNT
  , SUM(CHP_PLAN_CHG) CHP_PLAN_CHG_CNT
FROM (
      SELECT TRUNC(ST.ACCEPTED_DATE,'MM') REC_MONTH
      , TRUNC(ST.ACCEPTED_DATE) REC_DATE
      , ST.SELECTION_TRANSACTION_ID SELECTION_TXN_ID
       ,ST.PROGRAM_CODE
       ,ST.PLAN_TYPE
      , ST.PLAN_SERVICE_TYPE_CD
      , ST.SELECTION_SOURCE_CD
      , ST.ACCEPTED_DATE
      , ST.PRIOR_PLAN_ID PLAN_ID
      , ST.PRIOR_PLAN_ID_EXT PLAN_ID_EXT
      , ST.TRANSACTION_TYPE_CD
      , ST.PRIOR_PROVIDER_ID PROVIDER_ID
      , ST.PRIOR_PROVIDER_ID_EXT PROVIDER_ID_EXT
      , ST.PLAN_ID TO_PLAN_ID
      , ST.PLAN_ID_EXT TO_PLAN_ID_EXT
      , ST.CONTRACT_ID TO_CONTRACT_ID
      , ST.PROVIDER_ID TO_PROVIDER_ID
      , ST.PROVIDER_ID_EXT TO_PROVIDER_ID_EXT
      , CASE WHEN ST.PLAN_SERVICE_TYPE_CD = 'ACC' AND PRIOR_PROVIDER_ID_EXT IN ('07020368','23876239') THEN 'MCO' 
             WHEN ST.PLAN_SERVICE_TYPE_CD = 'ACC' AND PRIOR_PROVIDER_ID_EXT NOT IN ('07020368','23876239') THEN 'PCMP' 
             WHEN ST.PLAN_SERVICE_TYPE_CD = 'ACC' AND PRIOR_PROVIDER_ID_EXT IS NULL THEN 'PCMP' 
             ELSE NULL END PROVIDER_ORG_TYPE
      , CASE WHEN ST.PLAN_SERVICE_TYPE_CD = 'ACC' AND PRIOR_PROVIDER_ID_EXT IN ('07020368','23876239') THEN PRIOR_PROVIDER_ID_EXT 
             WHEN ST.PLAN_SERVICE_TYPE_CD = 'ACC' AND PRIOR_PROVIDER_ID_EXT NOT IN ('07020368','23876239') THEN 'PCMP' 
             WHEN ST.PLAN_SERVICE_TYPE_CD = 'ACC' AND PRIOR_PROVIDER_ID_EXT IS NULL THEN 'PCMP' 
             ELSE NULL END PROVIDER_ORG_CD
      , case when st.plan_service_type_cd = 'ACC' and sT.prior_provider_id_ext <> nvl(provider_id_ext,'0') then 1 else 0 end ACC_PROVIDER_CHG
      , case when ST.plan_service_type_cd = 'ACC' and ST.PRIOR_PLAN_ID <> ST.PLAN_ID THEN 1 ELSE 0 END ACC_PROV_RAE_CHG
      , case when ST.plan_service_type_cd = 'CHP'  and ST.PRIOR_PLAN_ID <> ST.PLAN_ID THEN 1 ELSE 0 END CHP_PLAN_CHG
      FROM MAXDAT_SUPPORT.EMRS_D_SELECTION_TRANS_SV ST
      WHERE ST.TRANSACTION_TYPE_CD IN ('Transfer','PCPTransfer')
      AND ST.START_DATE >= GREATEST(ADD_MONTHS(TRUNC(SYSDATE),-12),TO_DATE('6/1/2018','MM/DD/YYYY'))
      AND (ST.PLAN_ID <> ST.PRIOR_PLAN_ID OR 
          (ST.PLAN_SERVICE_TYPE_CD = 'ACC' AND ST.PLAN_ID = ST.PRIOR_PLAN_ID AND ST.PROVIDER_ID_EXT <> ST.PRIOR_PROVIDER_ID_EXT))
      AND ST.ACCEPTED_DATE IS NOT NULL
      AND ST.PRIOR_PLAN_ID > 1
) T
GROUP BY 
  T.REC_MONTH
 ,T.PROGRAM_CODE
 ,T.PLAN_TYPE
 , T.plan_Service_type_Cd
 , T.PLAN_ID
  , T.PROVIDER_ORG_TYPE
  , T.provider_org_CD
;

GRANT SELECT ON MAXDAT_SUPPORT.EMRS_F_TRANSFER_START_CNT_SV TO MAXDAT_REPORTS;  


  
