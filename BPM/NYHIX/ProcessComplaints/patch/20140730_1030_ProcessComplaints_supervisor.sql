--1081 rows
declare
cursor csr_sups iS select * from corp_etl_complaints_incidents stg  --where incident_id = 26034519
where incident_id in (select incident_header_id from incident_header_stat_hist_stg where incident_header_id = stg.incident_id and  status_cd  = 'REFERRED_TO_SUPERVISOR')
and incident_id in (select incident_id
from CORP_ETL_COMPLAINTS_INCIDENTS 
where 
incident_status in ('Incident Closed','Referral Closed')
and ased_resolve_incident_EES_CSS is  null
and assd_resolve_incident_EES_CSS is not null
and forward_dt is null
and incident_id not in 
(26035668, --These exclusions are appeal initiated status
26039629,
26039646,
26043118,
26045863,
26046387,
26047790,
26052803,
26056150,
26056285,
26056469,
26056516,
26058410,
26058931,
26059085,
26059090,
26061049,
26061084,
26062850,
26068305,
26069383,
26069529,
26069640,
26070097,
26071111,
26071854,
26072308,
26072514,
26072717,
26073330,
26074875,
26075142,
26075352,
26077255,
26078399,
26078575,
26079110,
26079157,
26079191,
26079373,
26080443,
26080451,
26080536,
26080652,
26081931,
26082071,
26082350,
26082515,
26082530,
26082713,
26083032,
26083081,
26083896,
26084066,
26084735,
26085402,
26085925,
26086112,
26086527,
26086540,
26086616,
26086745,
26087032,
26088271,
26088345,
26088651,
26088812,
26089013,
26089974,
26090820,
26090842,
26091816,
26091867,
26093169,
26094279,
26094486,
26095386,
26096649,
26097651,
26100416,
26100536,
26101895,
26102597,
26102674,
26103088,
26106176,
26108403,
26108793,
26114339,
26114851,
26114944,
26115769,
26116089,
26117146,
26117218,
26119925,
26123656,
26125159,
26138556,
26034853,
26034880,
26034910,
26034962,
26034964,
26034992,
26035014,
26035051,
26035097,
26035101,
26035104,
26035105,
26035107,
26035120,
26035131,
26035156,
26035285,
26035334,
26035415,
26035427,
26035443,
26035452,
26035456,
26035623,
26039970,
26042321,
26046181,
26068098,
26078184,
26079435,
26084563,
26089776)
and incident_id not in ( --these are statuses referral_open and open
26042388,
26042808,
26042934,
26043156,
26043400,
26043578,
26044004,
26044093,
26044094,
26044096,
26044161,
26044402,
26045358,
26045891,
26046038,
26046580,
26046756,
26046789,
26046798,
26047050,
26048374,
26049089,
26049160,
26049941,
26050046,
26050159,
26050740,
26051013,
26051238,
26051415,
26051493,
26051500,
26051734,
26052089,
26052610,
26052724,
26052809,
26053156,
26053507,
26053583,
26053861,
26053948,
26054114,
26054317,
26054513,
26054927,
26055099,
26056106,
26056178,
26056796,
26056996,
26057092,
26057099,
26057115,
26057407,
26057519,
26057562,
26058130,
26058793,
26060622,
26062328,
26062712,
26063517,
26063586,
26063661,
26064734,
26065726,
26066630,
26067409,
26067422,
26067978,
26067997,
26069246,
26069857,
26069914,
26070542,
26070563,
26073650,
26073870,
26074527,
26074647,
26074678,
26075139,
26075410,
26075413,
26075518,
26077264,
26078186,
26080059,
26080080,
26080210,
26080215,
26080615,
26082085,
26083738,
26083839,
26084732,
26084854,
26084951,
26085407,
26085946,
26085983,
26086326,
26086517,
26087035,
26087054,
26087277,
26088690,
26088698,
26088782,
26088887,
26088964,
26089014,
26089085,
26089148,
26089783,
26089995,
26090255,
26090400,
26090543,
26090751,
26090928,
26091112,
26091196,
26091638,
26091715,
26091987,
26092017,
26092268,
26092338,
26092341,
26092815,
26092854,
26092972,
26093032,
26093940,
26094624,
26094667,
26094735,
26094749,
26095161,
26095336,
26095442,
26095606,
26095628,
26095752,
26095899,
26095914,
26096467,
26096770,
26096878,
26096903,
26096934,
26097319,
26098216,
26098251,
26098415,
26098754,
26099000,
26099287,
26099607,
26099641,
26099844,
26099951,
26100238,
26100406,
26100550,
26100659,
26101835,
26102040,
26102352,
26102646,
26102688,
26103687,
26103871,
26105008,
26105073,
26105377,
26106450,
26106797,
26107492,
26108667,
26109092,
26109231,
26109308,
26109490,
26110203,
26110601,
26110990,
26111152,
26111211,
26113811,
26114157,
26114275,
26114564,
26114672,
26114677,
26114772,
26115074,
26115288,
26115751,
26115854,
26116041,
26116049,
26116540,
26117415,
26117682,
26117792,
26117991,
26117996,
26118102,
26118191,
26118219,
26118237,
26118266,
26118313,
26118563,
26118590,
26118596,
26118631,
26118632,
26118633,
26118635,
26118733,
26118743,
26118890,
26118901,
26118974,
26119091,
26119173,
26119203,
26119340,
26119343,
26119698,
26119849,
26119915,
26120291,
26120435,
26120440,
26120502,
26120529,
26120531,
26120599,
26120676,
26120718,
26120835,
26120887,
26120921,
26121009,
26121052,
26121157,
26121162,
26121272,
26121334,
26121380,
26121387,
26121449,
26121487,
26121488,
26121611,
26121621,
26121785,
26121868,
26121897,
26121929,
26121963,
26122647,
26122832,
26122943,
26123409,
26123552,
26123605,
26123625,
26123732,
26123792,
26124188,
26124211,
26124358,
26124646,
26124667,
26124676,
26124723,
26124775,
26124780,
26124967,
26125099,
26125186,
26125210,
26125251,
26125295,
26125362,
26125405,
26125577,
26126076,
26126107,
26126141,
26126277,
26126325,
26126545,
26126742,
26126969,
26127444,
26127662,
26127769,
26128254,
26128867,
26129979,
26130124,
26131189,
26131416,
26131562,
26131663,
26131742,
26131780,
26131837,
26131930,
26132018,
26132126,
26132386,
26132405,
26132752,
26132972,
26133517,
26133613,
26133657,
26133715,
26133858,
26133986,
26134115,
26134409,
26134560,
26134565,
26134584,
26135101,
26135169,
26135312,
26135343,
26135379,
26135503,
26135577,
26135582,
26135584,
26136145,
26136797,
26137734,
26138127,
26138185,
26138261,
26139206,
26139615,
26139673,
26139701,
26140105,
26140123
));

r_csr_sups csr_sups%ROWTYPE;
v_sup_create_dt  date  := null;
v_closed_dt date := null;

begin
open csr_sups;
fetch csr_sups into r_csr_sups;
while csr_sups%found
loop
select max(create_ts) into v_sup_create_dt from incident_header_stat_hist_stg where status_cd  = 'REFERRED_TO_SUPERVISOR' and incident_header_id = r_csr_sups.incident_id;
select max(create_ts) into v_closed_dt from incident_header_stat_hist_stg where status_cd  in( 'CLOSED','INCIDENT_CLOSED','REFERRAL CLOSED') and incident_header_id = r_csr_sups.incident_id;

update corp_etl_complaints_incidents set ased_resolve_incident_EES_CSS = v_sup_create_dt,
ASSD_RESOLVE_INCIDENT_SUP = v_sup_create_dt,
ASED_RESOLVE_INCIDENT_SUP = v_closed_dt
where incident_id = r_csr_sups.incident_id;

fetch csr_sups into r_csr_sups;
end loop;
close csr_sups;

commit;
end;
/

