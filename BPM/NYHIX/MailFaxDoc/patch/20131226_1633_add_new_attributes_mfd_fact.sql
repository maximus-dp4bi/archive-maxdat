/* 
STEP 1: Add new attributes to fact
STEP 2: Replace fact view 
STEP 3: Update fact attributes from current Dimension 
*/

--Add new attributes ENVELOPE_STATUS_DT, DOC_COMPLETE_DT, DOC_COMPLETION_COUNT, DOC_INVENTORY_COUNT

alter table F_NYHIX_MFD_BY_DATE add 
 (ENVELOPE_STATUS_DT date, 
 DOC_COMPLETE_DT date, 
 DOC_COMPLETION_COUNT number default 0, 
 DOC_INVENTORY_COUNT number default '0');

alter table F_NYHIX_MFD_BY_DATE modify 
(DOC_COMPLETION_COUNT not null,  
 DOC_INVENTORY_COUNT not null);


--Replace view F_NYHIX_MFD_BY_DATE_SV

create or replace view F_NYHIX_MFD_BY_DATE_SV as
select
  FNMFDBD_ID,
  BUCKET_START_DATE D_DATE,
  NYHIX_MFD_BI_ID,
  DNMFDDT_ID,
  DNMFDDS_ID,
  DNMFDES_ID,
  DNMFDDST_ID,
  DNMFDFT_ID,
  DNMFDTS_ID,
  DNMFDIS_ID,
  INSTANCE_STATUS_DT,
  DOC_COMPLETE_DT,
  DOCUMENT_STATUS_DT,
  ENVELOPE_STATUS_DT,
  RECEIPT_DT,
  SCAN_DT,
  RELEASE_DT,
  JEOPARDY_FLAG,
  CREATION_COUNT,
  INVENTORY_COUNT,
  DOC_INVENTORY_COUNT,
  COMPLETION_COUNT,
  DOC_COMPLETION_COUNT
from F_NYHIX_MFD_BY_DATE
where
  D_DATE >= (select min(D_DATE) from BPM_D_DATES)
  and CREATION_COUNT = 1
union all
(
select
  FNMFDBD_ID,
  bdd.D_DATE,
  NYHIX_MFD_BI_ID,
  DNMFDDT_ID,
  DNMFDDS_ID,
  DNMFDES_ID,
  DNMFDDST_ID,
  DNMFDFT_ID,
  DNMFDTS_ID,
  DNMFDIS_ID,
  INSTANCE_STATUS_DT,
  DOC_COMPLETE_DT,
  DOCUMENT_STATUS_DT,
  ENVELOPE_STATUS_DT,
  RECEIPT_DT,
  SCAN_DT,
  RELEASE_DT,
  JEOPARDY_FLAG,
  0 CREATION_COUNT,
  INVENTORY_COUNT,
  DOC_INVENTORY_COUNT,
  COMPLETION_COUNT,
  DOC_COMPLETION_COUNT
from 
  F_NYHIX_MFD_BY_DATE,
  BPM_D_DATES bdd
where
  bdd.D_DATE >= BUCKET_START_DATE
  and bdd.D_DATE < BUCKET_END_DATE
minus
select
  FNMFDBD_ID,
  bdd.D_DATE,
  NYHIX_MFD_BI_ID,
  DNMFDDT_ID,
  DNMFDDS_ID,
  DNMFDES_ID,
  DNMFDDST_ID,
  DNMFDFT_ID,
  DNMFDTS_ID,
  DNMFDIS_ID,
  INSTANCE_STATUS_DT,
  DOC_COMPLETE_DT,
  DOCUMENT_STATUS_DT,
  ENVELOPE_STATUS_DT,
  RECEIPT_DT,
  SCAN_DT,
  RELEASE_DT,
  JEOPARDY_FLAG,
  0 CREATION_COUNT,
  INVENTORY_COUNT,
  DOC_INVENTORY_COUNT,
  COMPLETION_COUNT,
  DOC_COMPLETION_COUNT
from
  BPM_D_DATES bdd,
  F_NYHIX_MFD_BY_DATE
where
  bdd.D_DATE = BUCKET_START_DATE
  and CREATION_COUNT = 1
)
union all
select
  FNMFDBD_ID,
  bdd.D_DATE,
  NYHIX_MFD_BI_ID,
  DNMFDDT_ID,
  DNMFDDS_ID,
  DNMFDES_ID,
  DNMFDDST_ID,
  DNMFDFT_ID,
  DNMFDTS_ID,
  DNMFDIS_ID,
  INSTANCE_STATUS_DT,
  DOC_COMPLETE_DT,
  DOCUMENT_STATUS_DT,
  ENVELOPE_STATUS_DT,
  RECEIPT_DT,
  SCAN_DT,
  RELEASE_DT,
  JEOPARDY_FLAG,
  CREATION_COUNT,
  INVENTORY_COUNT,
  DOC_INVENTORY_COUNT,
  COMPLETION_COUNT,
  DOC_COMPLETION_COUNT
from
  BPM_D_DATES bdd,
  F_NYHIX_MFD_BY_DATE
where
  bdd.D_DATE >= BUCKET_START_DATE
  and bdd.D_DATE = BUCKET_END_DATE
  and CREATION_COUNT = 0
  and COMPLETION_COUNT = 1
with read only;

--Get ENVELOPE_STATUS_DT, DOC_COMPLETE_DT from current dimension and update fact

declare 
cursor s1 is select NYHIX_MFD_BI_ID, ENVELOPE_STATUS_DT, DOC_COMPLETE_DT  
             from D_NYHIX_MFD_CURRENT;
begin
  for c1 in s1 
   loop

    update F_NYHIX_MFD_BY_DATE
    set DOC_COMPLETE_DT = c1.DOC_COMPLETE_DT, ENVELOPE_STATUS_DT = c1.ENVELOPE_STATUS_DT
    where NYHIX_MFD_BI_ID = c1.NYHIX_MFD_BI_ID;

    commit;

   end loop;
end;
/