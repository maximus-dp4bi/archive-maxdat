alter session set current_schema = maxdat;

create or replace view MAXDAT.NYHIX_MFB_V2_Image_Trust_Kofax_DMS_CHECK_SV
as
WITH VALID_EXPORTS 
AS ( -- THIS IS THE DRIVER TABLE
     -- ALL OTHER TABLES ARE OUTER JOINED TO THIS ONE
     -- NOTE ON 2022/10/1 BATCH CLASSES ('NYHO-FPBP-MAIL','NYHO-FAX') ARE NYEC
     -- ALL OTHERS ARE NYHIX  *** BUT THAT COULD CHANGE ***
    SELECT 
        BATCH_CREATE_DATE,
        DCN             AS KOFAX_DCN, 
        BATCH_NAME, 
        BATCH_GUID,
        BATCH_CLASS,
        FORM_TYPE,
        DOCUMENT_NUMBER,
        BATCH_ID,
        BATCH_DOC_COUNT,
        ENVELOPE_DOCUMENT_COUNT,
        DOC_PAGE_COUNT,
        DOC_TYPE,
        ENVELOPE_RECEIVED_DATE,
        FAX_BATCH_SOURCE
    FROM MAXDAT.NYHIX_MFB_V2_MAXDAT_REPORTING
    WHERE VALID = 1
   -- AND DB_RECORD_NUM > 0
    ),
DMS_DOC
AS  (
    SELECT  DCN AS DMS_DCN,
            BATCH_ID AS DMS_BATCH_ID,
            DATE_RECEIVED,
            FORM_TYPE AS DMS_FORM_TYPE,
            NUMBER_OF_PAGES,
            ECN AS DMS_ECN,
            KOFAX_DCN AS DMS_KOFAX_DCN,
            CREATION_DATE,
            LAST_UPDATE_DATE
    FROM MAXDAT.D_DOCUMENTS
    ----------        
    UNION ALL
    ----------        
    SELECT  DCN AS DMS_DCN,
            BATCH_ID AS DMS_BATCH_ID,
            DATE_RECEIVED,
            FORM_TYPE AS DMS_FORM_TYPE,
            NUMBER_OF_PAGES,
            ECN AS DMS_ECN,
            KOFAX_DCN AS DMS_KOFAX_DCN,
            CREATION_DATE,
            LAST_UPDATE_DATE
    FROM MAXDAT.D_NYEC_DOCUMENTS
    ),
BATCH_SUMMARY
    AS (
        SELECT 
			BATCH_GUID  AS SUMMARY_BATCH_GUID, --
			BATCH_COMPLETE_DT, 
			INSTANCE_STATUS, 
			SOURCE_SERVER, 
			BATCH_DESCRIPTION, 
			-- BATCH_CLASS, --
			BATCH_TYPE, 
			JEOPARDY_FLAG, 
			JEOPARDY_DAYS, 
			JEOPARDY_DT, 
			COMPLETE_DT, 
			REPROCESSED_FLAG, 
			REPROCESSED_DATE, 
			CANCEL_DT, 
			CANCEL_REASON, 
			BATCH_PRIORITY, 
			BATCH_DELETED, 
			AGE_IN_BUSINESS_DAYS, 
			AGE_IN_CALENDAR_DAYS, 
			TIMELINESS_STATUS, 
			TIMELINESS_DAYS, 
			TIMELINESS_DT, 
			LAST_EVENT_STATUS, 
			LAST_EVENT_MODULE_NAME 
FROM MAXDAT.NYHIX_MFB_V2_BATCH_SUMMARY
),
IMAGE_TRUST
AS ( SELECT DISTINCT BATCH_NAME AS IMAGE_TRUST_BATCH_NAME,
        'Image Trust' AS IMAGE_TRUST_SOURCE_SERVER
     FROM MAXDAT.NYHIX_MFB_V2_IMAGE_TRUST_STATS_BATCH
    ),
RESULTS 
AS (        
SELECT CASE 
    WHEN DMS_DOC.DMS_DCN IS NULL 
        THEN 'Missing from DMS'
    WHEN NVL(VALID_EXPORTS.DOC_PAGE_COUNT,0) <> NVL(DMS_DOC.NUMBER_OF_PAGES,0) 
        THEN 'Page Count Error' END AS ERROR_MESSAGE,
    CASE WHEN IMAGE_TRUST.IMAGE_TRUST_SOURCE_SERVER IS NOT NULL 
        THEN 'IMAGE TRUST '||IMAGE_TRUST.IMAGE_TRUST_SOURCE_SERVER 
        ELSE BATCH_SUMMARY.SOURCE_SERVER END AS INITIAL_SOURCE,    
 --   '*** Kofax >>>' as FROM_kofax,
    VALID_EXPORTS.*, -- from MAXDAT_REPORTING
 --   '*** << Kofax . DMS >>>' as from_DMS,
    DMS_DOC.*, -- from maxdat.d_documents << dms.app_doc_data_ext 
 --   '*** << DMS .. KOFAX >>>' as FROM_KOFAX_2,
    BATCH_SUMMARY.*, 
 --   '*** << KOFAX .. Image_trust >>>' as FROM_image_trust,
    IMAGE_TRUST.*
FROM VALID_EXPORTS    
LEFT OUTER JOIN DMS_DOC
    ON VALID_EXPORTS.KOFAX_DCN =  DMS_DOC.DMS_KOFAX_DCN
LEFT OUTER JOIN NYHIX_MFB_V2_IMAGE_TRUST_STATS_BATCH IT
    ON IT.BATCH_NAME = VALID_EXPORTS.BATCH_NAME 
LEFT OUTER JOIN BATCH_SUMMARY
    ON BATCH_SUMMARY.SUMMARY_BATCH_GUID = VALID_EXPORTS.BATCH_GUID
LEFT OUTER JOIN IMAGE_TRUST
    ON IMAGE_TRUST.IMAGE_TRUST_BATCH_NAME = VALID_EXPORTS.BATCH_NAME
)
SELECT * FROM RESULTS;

grant select on MAXDAT.NYHIX_MFB_V2_Image_Trust_Kofax_DMS_CHECK_SV to maxdat_read_only;

grant select on MAXDAT.NYHIX_MFB_V2_Image_Trust_Kofax_DMS_CHECK_SV to maxdat_reports;

CREATE OR REPLACE VIEW MAXDAT.NYHIX_MFB_V2_MAXDAT_REPORTING_SV
AS SELECT * FROM MAXDAT.NYHIX_MFB_V2_MAXDAT_REPORTING;

GRANT SELECT ON MAXDAT.NYHIX_MFB_V2_MAXDAT_REPORTING_SV TO MAXDAT_READ_ONLY;

GRANT SELECT ON MAXDAT.NYHIX_MFB_V2_MAXDAT_REPORTING_SV TO MAXDAT_REPORTS;

CREATE OR REPLACE VIEW MAXDAT.D_DOCUMENTS_SV AS SELECT * FROM MAXDAT.D_DOCUMENTS;

GRANT SELECT ON MAXDAT.D_DOCUMENTS_SV TO MAXDAT_READ_ONLY;

GRANT SELECT ON MAXDAT.D_DOCUMENTS_SV TO MAXDAT_REPORTS;


