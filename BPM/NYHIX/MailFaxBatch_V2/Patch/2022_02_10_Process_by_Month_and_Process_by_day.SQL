--------------------------------------------------------------------------
-- Run this script in MAXDAT@NHX1DORUHXDP.CLDMGFTTY3FU.US-EAST-1.RDS.AMAZONAWS.COM:1557/NYHXDPMU to make it look like MAXDAT@NHX1DORD1HXDP.CLDMGFTTY3FU.US-EAST-1.RDS.AMAZONAWS.COM:1557/NYHXDPMD.
--
-- Please review the script before using it to make sure it won't cause any unacceptable data loss.
--
-- MAXDAT@NHX1DORUHXDP.CLDMGFTTY3FU.US-EAST-1.RDS.AMAZONAWS.COM:1557/NYHXDPMU schema extracted by user WL134672
-- MAXDAT@NHX1DORD1HXDP.CLDMGFTTY3FU.US-EAST-1.RDS.AMAZONAWS.COM:1557/NYHXDPMD schema extracted by user MAXDAT
--------------------------------------------------------------------------
-- "Set define off" turns off substitution variables.
Set define off;

CREATE OR REPLACE PROCEDURE MAXDAT.NYHIX_MFB_V2_CHECK_FACT_BY_DAY(P_YYYYMM VARCHAR default '%')
IS

	CURSOR GUID_CSR IS
	WITH END_DT AS 
	(
        SELECT sb.SOURCE_SERVER, sb.BATCH_GUID, --sb.INSTANCE_STATUS,
		TRUNC(COALESCE(sb.REPROCESSED_DATE,
				CANCEL_DT,
				BATCH_COMPLETE_DT,
				COMPLETE_DT,
				SYSDATE)
				) END_DATE
        FROM MAXDAT.NYHIX_MFB_V2_stats_BATCH sb
        left outer join maxdat.NYHIX_MFB_V2_batch_summary bs
        on sb.batch_guid = bs.batch_guid
        and sb.source_server = bs.source_server
        WHERE TO_CHAR(SBM_MIN_START_DATE_TIME,'YYYYMM') like '202201'
        --AND ROWNUM > 10    
    ),
	LAST_DAY AS
	( 
	SELECT BATCH_GUID, MAX(TRUNC(D_DATE)) AS D_DATE
	FROM MAXDAT.F_MFB_V2_BY_DAY
	GROUP BY BATCH_GUID
	)  
	SELECT ROWNUM AS RN, END_DT.SOURCE_SERVER, END_DT.BATCH_GUID, LAST_DAY.D_DATE, END_DT.END_DATE
	FROM END_DT
	LEFT OUTER JOIN LAST_DAY ON END_DT.BATCH_GUID = LAST_DAY.BATCH_GUID
	WHERE LAST_DAY.D_DATE IS NULL
	OR END_DT.END_DATE > NVL(LAST_DAY.D_DATE,TO_DATE('19000101','YYYYMMDD'))
	ORDER BY 1,2;
    
	GUID_CSR_REC 	GUID_CSR%ROWTYPE;

	BEGIN

	IF (GUID_CSR%ISOPEN)
	THEN
		CLOSE GUID_CSR;
	END IF;
	
	OPEN GUID_CSR;

		LOOP  -- Main "Driving" Loop

			FETCH GUID_CSR INTO GUID_CSR_REC;

			EXIT WHEN GUID_CSR%NOTFOUND;
		
            IF GUID_CSR_REC.RN < 10
            THEN
                DBMS_OUTPUT.PUT_LINE(GUID_CSR_REC.SOURCE_SERVER||' '||GUID_CSR_REC.BATCH_GUID);
            END IF;		
            
            MAXDAT.NYHIX_MFB_V2_BATCH_SUMMARY_PKG.PROCESS_ONE_BATCH(GUID_CSR_REC.SOURCE_SERVER,GUID_CSR_REC.BATCH_GUID);
            
		END LOOP;

	IF (GUID_CSR%ISOPEN)
	THEN
		CLOSE GUID_CSR;
	END IF;
		
	EXCEPTION
		WHEN NO_DATA_FOUND
		THEN 
			NULL;
		WHEN OTHERS THEN RAISE;
		
	END;
/

SHOW ERRORS;

CREATE OR REPLACE PROCEDURE MAXDAT.NYHIX_MFB_V2_PROCESS_BY_MONTH(P_YYYYMM VARCHAR default '%')
IS

	CURSOR GUID_CSR IS
    SELECT ROWNUM AS RN, SB.SOURCE_SERVER, SB.BATCH_GUID --sb.INSTANCE_STATUS,
    FROM MAXDAT.NYHIX_MFB_V2_STATS_BATCH SB
    WHERE TO_CHAR(SBM_MIN_START_DATE_TIME,'YYYYMM') LIKE P_YYYYMM
    --AND ROWNUM > 10    
	ORDER BY SOURCE_SERVER, BATCH_GUID;
    
	GUID_CSR_REC 	GUID_CSR%ROWTYPE;

	BEGIN

	IF (GUID_CSR%ISOPEN)
	THEN
		CLOSE GUID_CSR;
	END IF;
	
	OPEN GUID_CSR;

		LOOP  -- Main "Driving" Loop

			FETCH GUID_CSR INTO GUID_CSR_REC;

			EXIT WHEN GUID_CSR%NOTFOUND;
		
            IF GUID_CSR_REC.RN < 10
            THEN
                DBMS_OUTPUT.PUT_LINE(GUID_CSR_REC.SOURCE_SERVER||' '||GUID_CSR_REC.BATCH_GUID);
            END IF;		
            
            MAXDAT.NYHIX_MFB_V2_BATCH_SUMMARY_PKG.PROCESS_ONE_BATCH(GUID_CSR_REC.SOURCE_SERVER,GUID_CSR_REC.BATCH_GUID);
            
		END LOOP;

	IF (GUID_CSR%ISOPEN)
	THEN
		CLOSE GUID_CSR;
	END IF;
		
	EXCEPTION
		WHEN NO_DATA_FOUND
		THEN 
			NULL;
		WHEN OTHERS THEN RAISE;
		
	END;
/

SHOW ERRORS;

exec MAXDAT.NYHIX_MFB_V2_CHECK_FACT_BY_DAY('202201');

exec MAXDAT.NYHIX_MFB_V2_PROCESS_BY_MONTH('202201');

