---------------------------------------------------
---------------------------------------------------

INSERT INTO PP_WFM_TASK_AUDIT_CNTRL_DIFFS
(STAFF_ID, TASK_YYYYMM)
SELECT DISTINCT STAFF_ID, TASK_YYYYMM
FROM PP_WFM_TASK_AUDIT_PPK_TASK;

COMMIT;

---------------------------------------------------
---------------------------------------------------

INSERT INTO DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES
(STAFF_ID, TASK_YYYYMM, TASK_ID, DELETE_DETECTED_DATE)
SELECT STAFF_ID, 
	TO_CHAR(TASK_START,'YYYYMM') AS TASK_YYYYMM, 
	TASK_ID, 
	SYSDATE AS DELETE_DETECTED_DATE
FROM DP_SCORECARD.PP_WFM_TASK_BO
WHERE NVL(DELETE_FLAG,'N') = 'N'
AND DELETE_DETECTED_DATE IS NULL
AND ( STAFF_ID, TO_CHAR(TASK_START,'YYYYMM' ))
    IN ( SELECT STAFF_ID, TASK_YYYYMM 
        FROM DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS 
        WHERE TASK_YYYYMM BETWEEN '201601' AND TO_CHAR(SYSDATE,'YYYYMM')
        )
MINUS
SELECT STAFF_ID, TO_CHAR(TASK_YYYYMM), TASK_ID, SYSDATE 
FROM PP_WFM_TASK_AUDIT_PPK_TASK
WHERE TASK_YYYYMM BETWEEN '201601' AND TO_CHAR(SYSDATE,'YYYYMM')
AND ( STAFF_ID, TASK_YYYYMM )
    IN ( SELECT STAFF_ID, TASK_YYYYMM 
        FROM DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS
        WHERE TASK_YYYYMM BETWEEN '201601' AND TO_CHAR(SYSDATE,'YYYYMM')
        )
/

commit;

----------------------------------------------------
----------------------------------------------------

UPDATE DP_SCORECARD.PP_WFM_TASK_BO T  -- 1,605,108 ROWS UPDATED.
SET T.DELETE_FLAG = 'Y', 
	T.DELETE_DETECTED_DATE = SYSDATE
	--( SELECT DELETE_DETECTED_DATE
	--FROM DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES D
	--WHERE D.TASK_ID = T.TASK_ID
	--AND D.STAFF_ID = T.STAFF_ID
	--AND TO_CHAR(T.TASK_START,'YYYYMM') = D.TASK_YYYYMM
	--)
WHERE NVL(T.DELETE_FLAG,'N') = 'N'
AND T.DELETE_DETECTED_DATE IS NULL
AND (STAFF_ID, TASK_ID, TO_CHAR(TASK_START,'YYYYMM'))
IN ( SELECT STAFF_ID, TASK_ID, TASK_YYYYMM
FROM DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES
);		

COMMIT;

