-- NYHIX-47982
SET serveroutput ON;

DECLARE

v_before_count NUMBER := 0;
v_delete_count NUMBER := 0;
v_update_count NUMBER := 0;
v_after_count  NUMBER := 0;

BEGIN

  dbms_output.put_line('This script will do an UPDATE and DELETE. Please ensure that both were successful before committing.');
  dbms_output.put_line('If either part is not successful then ROLLBACK both changes!');
  dbms_output.put_line(' ');

  SELECT COUNT(0)  -- 1257
  INTO   v_before_count
  FROM   DP_SCORECARD.SC_AGENT_STAT
  WHERE  AGENT_ID in ('204267','141164','135755','128259','146329','148010','112826','118825','246142','132772','112781','246076',
                      '133322','130460','105716','140772','130271','134874','115971','102228','147813','144291','68125','141403',
                      '128207','104418','139463','46964','135861','139092','140853','146845','144550','133323','130464','144290',
                      '113818','147793','139484','150042','150047','64055','125160','139760','247463','131935','81261','204307',
                      '139610','117691','132826','246214','117693','140626','247325','139613','140921','147809','147431','135262',
                      '245997','136397','203655','141086','136273','138365','245506','140935','134807','137323','130791','130396',
                      '124490','140925','141110','137329','138388','123263')
  AND    TRUNC(AS_DATE) between '01-FEB-19' AND '28-FEB-19';

  dbms_output.put_line('Before DP_SCORECARD.SC_AGENT_STAT update record count: '||v_before_count);

  IF v_before_count > 0
  THEN

    UPDATE DP_SCORECARD.SC_AGENT_STAT
    SET    tot_return_to_queue = 0,
    	   tot_return_to_queue_timeout = 0
    WHERE  AGENT_ID in ('204267','141164','135755','128259','146329','148010','112826','118825','246142','132772','112781','246076',
                        '133322','130460','105716','140772','130271','134874','115971','102228','147813','144291','68125','141403',
                        '128207','104418','139463','46964','135861','139092','140853','146845','144550','133323','130464','144290',
                        '113818','147793','139484','150042','150047','64055','125160','139760','247463','131935','81261','204307',
                        '139610','117691','132826','246214','117693','140626','247325','139613','140921','147809','147431','135262',
                        '245997','136397','203655','141086','136273','138365','245506','140935','134807','137323','130791','130396',
                        '124490','140925','141110','137329','138388','123263')
    AND    TRUNC(AS_DATE) between '01-FEB-19' AND '28-FEB-19';

    v_update_count := SQL%ROWCOUNT;

    dbms_output.put_line('DP_SCORECARD.SC_AGENT_STAT records updated: '||v_update_count);
    dbms_output.put_line('Do not commit unless the number of updated records is greater than');

  ELSE

    dbms_output.put_line('No records found, skip the update');

  END IF;

  SELECT COUNT(0)  -- 1257
  INTO   v_after_count
  FROM   DP_SCORECARD.SC_AGENT_STAT
  WHERE  AGENT_ID in ('204267','141164','135755','128259','146329','148010','112826','118825','246142','132772','112781','246076',
                      '133322','130460','105716','140772','130271','134874','115971','102228','147813','144291','68125','141403',
                      '128207','104418','139463','46964','135861','139092','140853','146845','144550','133323','130464','144290',
                      '113818','147793','139484','150042','150047','64055','125160','139760','247463','131935','81261','204307',
                      '139610','117691','132826','246214','117693','140626','247325','139613','140921','147809','147431','135262',
                      '245997','136397','203655','141086','136273','138365','245506','140935','134807','137323','130791','130396',
                      '124490','140925','141110','137329','138388','123263')
  AND    TRUNC(AS_DATE) between '01-FEB-19' AND '28-FEB-19'
  AND    tot_return_to_queue > 0;

  dbms_output.put_line('After record count (will be zero, based on tot_return_to_queue > 0, after the commit is performed): '||v_after_count);
  dbms_output.put_line(' ');
----------------------------
  SELECT count(0) -- 1282
  INTO   v_before_count
  FROM   DP_SCORECARD.Sc_Lag_Time
  WHERE  AGENT_ID in ('204267','141164','135755','128259','146329','148010','112826','118825','246142','132772','112781','246076',
                      '133322','130460','105716','140772','130271','134874','115971','102228','147813','144291','68125','141403',
                      '128207','104418','139463','46964','135861','139092','140853','146845','144550','133323','130464','144290',
                      '113818','147793','139484','150042','150047','64055','125160','139760','247463','131935','81261','204307',
                      '139610','117691','132826','246214','117693','140626','247325','139613','140921','147809','147431','135262',
                      '245997','136397','203655','141086','136273','138365','245506','140935','134807','137323','130791','130396',
                      '124490','140925','141110','137329','138388','123263')
  AND TRUNC(LAG_DATE) between '01-FEB-19' AND '28-FEB-19';

  dbms_output.put_line('Before DP_SCORECARD.Sc_Lag_Time record delete count: '||v_before_count);

  IF v_before_count > 0
  THEN

    DELETE FROM DP_SCORECARD.Sc_Lag_Time
    WHERE  AGENT_ID in ('204267','141164','135755','128259','146329','148010','112826','118825','246142','132772','112781','246076',
                        '133322','130460','105716','140772','130271','134874','115971','102228','147813','144291','68125','141403',
                        '128207','104418','139463','46964','135861','139092','140853','146845','144550','133323','130464','144290',
                        '113818','147793','139484','150042','150047','64055','125160','139760','247463','131935','81261','204307',
                        '139610','117691','132826','246214','117693','140626','247325','139613','140921','147809','147431','135262',
                        '245997','136397','203655','141086','136273','138365','245506','140935','134807','137323','130791','130396',
                        '124490','140925','141110','137329','138388','123263')
    AND TRUNC(LAG_DATE) between '01-FEB-19' AND '28-FEB-19';

    v_delete_count := SQL%ROWCOUNT;

    dbms_output.put_line('DP_SCORECARD.Sc_Lag_Time records deleted: '||v_delete_count);
    dbms_output.put_line('Do not commit unless the number of deleted records is equal to '||v_before_count);

  ELSE

    dbms_output.put_line('No records found, skip the delete');

  END IF;

  SELECT COUNT(0)  -- should be zero records
  INTO   v_after_count
  FROM   DP_SCORECARD.Sc_Lag_Time
  WHERE  AGENT_ID in ('204267','141164','135755','128259','146329','148010','112826','118825','246142','132772','112781','246076',
                      '133322','130460','105716','140772','130271','134874','115971','102228','147813','144291','68125','141403',
                      '128207','104418','139463','46964','135861','139092','140853','146845','144550','133323','130464','144290',
                      '113818','147793','139484','150042','150047','64055','125160','139760','247463','131935','81261','204307',
                      '139610','117691','132826','246214','117693','140626','247325','139613','140921','147809','147431','135262',
                      '245997','136397','203655','141086','136273','138365','245506','140935','134807','137323','130791','130396',
                      '124490','140925','141110','137329','138388','123263')
  AND TRUNC(LAG_DATE) between '01-FEB-19' AND '28-FEB-19';

  dbms_output.put_line('After record count (will be zero after the commit is performed): '||v_after_count);

END;
/
