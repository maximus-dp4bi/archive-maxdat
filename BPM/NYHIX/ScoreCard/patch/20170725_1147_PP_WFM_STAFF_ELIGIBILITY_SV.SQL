CREATE OR REPLACE FORCE VIEW DP_SCORECARD.PP_WFM_STAFF_ELIGIBILITY_SV
(STAFF_ID, EVENT_ID, START_DATE, END_DATE, DELETE_FLAG, 
 MODIFY_DATE, MODIFY_USER, EVENT_NAME)
AS 
WITH STAFF_ELIGIBILITY 
AS 	(
	SELECT STAFF_ID, TRUNC(START_DATE) 	AS START_DATE, 
	TRUNC(NVL(END_DATE,SYSDATE)) 		AS END_DATE,
	EVENT_ID 							AS EVENT_ID,
	SCHEDULING_PRIORITY					AS SCHEDULING_PRIORITY
	FROM DP_SCORECARD.PP_WFM_STAFF_ELIGIBILITY
	WHERE NVL(DELETE_FLAG,'N') = 'N'	
	AND TRUNC(START_DATE) <= TRUNC(SYSDATE)  
	),
STAFF_MAX_END_DATE 
AS 	( -- SELECT THE MAX END_DATE --
	SELECT STAFF_ID, MAX(END_DATE) AS END_DATE
	FROM STAFF_ELIGIBILITY 
	WHERE START_DATE <= TRUNC(SYSDATE)
	GROUP BY STAFF_ID
	),
STAFF_START_AND_END 
AS 	(
	SELECT  --<< SELECT THE MAX(START_DATE) EVEN IF MULTIPLE NULL MAX(END_DATES) 
    STAFF_ID, END_DATE, MAX(START_DATE) AS START_DATE
	FROM STAFF_ELIGIBILITY
	WHERE (STAFF_ID, END_DATE)
	IN 	( 
		SELECT STAFF_ID, END_DATE
		FROM STAFF_MAX_END_DATE
		)	
	GROUP BY STAFF_ID, END_DATE
	),
STAFF_EVENT_PRIORITY
AS 	(
	SELECT STAFF_ID, START_DATE, END_DATE, MIN(SCHEDULING_PRIORITY) AS SCHEDULING_PRIORITY
	FROM STAFF_ELIGIBILITY
	WHERE ( STAFF_ID, START_DATE, END_DATE)
	IN ( SELECT STAFF_ID, START_DATE, END_DATE
		FROM STAFF_START_AND_END
		)
	GROUP BY STAFF_ID, START_DATE, END_DATE	
	),
STAFF_EVENT_DATES	
AS	( SELECT STAFF_ID, START_DATE, END_DATE, SCHEDULING_PRIORITY, MAX(EVENT_ID) AS EVENT_ID
	FROM STAFF_ELIGIBILITY
	WHERE (STAFF_ID, START_DATE, END_DATE, SCHEDULING_PRIORITY)
	IN ( SELECT STAFF_ID, START_DATE, END_DATE, SCHEDULING_PRIORITY
		FROM STAFF_EVENT_PRIORITY
		)
	GROUP BY STAFF_ID, START_DATE, END_DATE, SCHEDULING_PRIORITY
)
--STAFF_ELIGIBILITY_SV
--AS (
SELECT SE.STAFF_ID, SE.EVENT_ID, SE.START_DATE, SE.END_DATE, SE.DELETE_FLAG, 
 SE.MODIFY_DATE, SE.MODIFY_USER, E.NAME AS EVENT_NAME
FROM DP_SCORECARD.PP_WFM_STAFF_ELIGIBILITY SE
JOIN MAXDAT.PP_WFM_EVENT E ON E.EVENT_ID = SE.EVENT_ID
JOIN STAFF_EVENT_DATES SED
ON SED.STAFF_ID = SE.STAFF_ID
AND SED.START_DATE = TRUNC(SE.START_DATE)
AND SED.END_DATE = TRUNC(NVL(SE.END_DATE,SYSDATE))
AND SED.SCHEDULING_PRIORITY = SE.SCHEDULING_PRIORITY
AND SED.EVENT_ID = SE.EVENT_ID	
WHERE (SED.STAFF_ID, SED.EVENT_ID)
IN ( SELECT STAFF_ID, EVENT_ID
FROM DP_SCORECARD.PP_WFM_STAFF_ELIGIBIL_WRK_SV
);


GRANT SELECT ON DP_SCORECARD.PP_WFM_STAFF_ELIGIBILITY_SV TO MAXDAT;

GRANT SELECT ON DP_SCORECARD.PP_WFM_STAFF_ELIGIBILITY_SV TO MAXDAT_KETTLE;

GRANT SELECT ON DP_SCORECARD.PP_WFM_STAFF_ELIGIBILITY_SV TO MAXDAT_READ_ONLY;

GRANT SELECT ON DP_SCORECARD.PP_WFM_STAFF_ELIGIBILITY_SV TO MAXDAT_REPORTS;

GRANT SELECT ON DP_SCORECARD.PP_WFM_STAFF_ELIGIBILITY_SV TO DP_SCORECARD_READ_ONLY;


