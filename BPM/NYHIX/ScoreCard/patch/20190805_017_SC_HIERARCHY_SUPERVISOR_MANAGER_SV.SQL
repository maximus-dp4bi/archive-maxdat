CREATE OR REPLACE VIEW DP_SCORECARD.SC_HIERARCHY_SUPERVISOR_MANAGER_SV
AS
-- THIS VIEW PROVIDES A CURRENT 'BEST SHOT' LIST 
-- OF SUPERVISOR TO MANAGER MAPPING.
-- A SPUPERVISOR SHOULD ONLY BE LISTED ONCE
-- PAIRED WITH THE "CURRENT" MANAGER
-- OR "LAST" MANAGER WHEN NO CURRENT MAPPING IS FOUND
WITH SUP_2_MGR AS
(SELECT SUPERVISOR_STAFF_ID, MANAGER_STAFF_ID
 FROM SCORECARD_HIERARCHY
 WHERE TERMINATION_DATE IS NULL
UNION
SELECT SUPERVISOR_STAFF_ID, MANAGER_STAFF_ID
FROM SCORECARD_HIERARCHY
WHERE ( SUPERVISOR_STAFF_ID, TERMINATION_DATE )
IN ( SELECT SUPERVISOR_STAFF_ID, MAX(TERMINATION_DATE)
     FROM SCORECARD_HIERARCHY
     WHERE TERMINATION_DATE IS NOT NULL
     AND SUPERVISOR_STAFF_ID 
     IN ( -- THIS IDENTIFIES SUPERVISORS WITH NO CURRENT EMPLOYEES IN THE HIERARCHY
        SELECT SUPERVISOR_STAFF_ID FROM SCORECARD_HIERARCHY
        WHERE TERMINATION_DATE IS NOT NULL
        MINUS
        SELECT SUPERVISOR_STAFF_ID FROM SCORECARD_HIERARCHY
        WHERE TERMINATION_DATE IS NULL
        )
     GROUP BY SUPERVISOR_STAFF_ID        
    )
)
SELECT SUP_2_MGR.MANAGER_STAFF_ID,
    NVL(MGR.NATIONAL_ID,'UNKNOWN') AS MANAGER_NATID,
    NVL(MGR.LAST_NAME||', '||MGR.FIRST_NAME,'UNKNOWN')  AS MANAGER_NAME,
    SUP_2_MGR.SUPERVISOR_STAFF_ID, 
    NVL(SUP.NATIONAL_ID,'UNKNOWN') AS SUPERVISOR_NATID,
    NVL(SUP.LAST_NAME||', '||SUP.FIRST_NAME,'UNKNOWN')  AS SUPERVISOR_NAME
FROM SUP_2_MGR
LEFT OUTER JOIN SC_HIERARCHY_STAFF SUP 
    ON SUP.STAFF_ID = SUP_2_MGR.SUPERVISOR_STAFF_ID
LEFT OUTER JOIN SC_HIERARCHY_STAFF MGR 
    ON MGR.STAFF_ID = SUP_2_MGR.MANAGER_STAFF_ID
;

GRANT SELECT ON SC_HIERARCHY_SUPERVISOR_MANAGER_SV TO MAXDAT;
GRANT SELECT ON SC_HIERARCHY_SUPERVISOR_MANAGER_SV TO MAXDAT_REPORTS;
GRANT SELECT ON SC_HIERARCHY_SUPERVISOR_MANAGER_SV TO MAXDAT_READ_ONLY;
GRANT SELECT ON SC_HIERARCHY_SUPERVISOR_MANAGER_SV TO DP_SCORECARD_READ_ONLY;

-----------------------------------------------------------------------------
-----------------------------------------------------------------------------

CREATE OR REPLACE VIEW DP_SCORECARD.SC_HIERARCHY_MANAGER_SUPERVISOR_CURRENT_SV
AS 
WITH CC_ROLLUP AS
( SELECT
    SUPERVISOR_STAFF_ID, 
  		TO_DATE (DATES_MONTH_NUM, 'YYYYMM')
			AS D_DATE,
		DATES_MONTH,
		DATES_MONTH_NUM,
		DATES_YEAR,
			'Q'
		|| TO_CHAR (ADD_MONTHS (TO_DATE (DATES_MONTH_NUM, 'YYYYMM'), +3),
					'Q')
		|| ' '
		|| TO_CHAR (ADD_MONTHS (TO_DATE (DATES_MONTH_NUM, 'YYYYMM'), +3),
					'YYYY')
			AS DATES_QTR_YEAR,
  BUILDING, DEPARTMENT, EXCLUSION_FLAG, 
 TOT_CALLS_ANSWERED, TOT_SHORT_CALLS_ANSWERED, TOT_TOT_RETURN_TO_QUEUE, TOT_AVERAGE_HANDLE_TIME, 
 TOT_SCHED_PRODUCTIVE_TIME, TOT_ACTUAL_PRODUCTIVE_TIME, TOT_TALK_TIME, TOT_WRAP_UP_TIME, TOT_LOGGED_IN_TIME, TOT_NOT_READY_TIME, 
 TOT_BREAK_TIME, TOT_LUNCH_TIME, QCS_PERFORMED, AVG_QC_SCORE, 
 TOT_INCIDENTS_COMPLETED, DAYS_INCIDENTS_COMPLETED, TOT_DEFECTS_COMPLETED, DAYS_DEFECTS_COMPLETED, 
 LAG_TIME_TOT_SCHED_PROD_TIME, TOT_CALL_RECORDS, TOT_CUSTOMER_COUNT, 
 TOT_CALL_WRAP_UP_COUNT, TOT_WRAP_UP_ERROR, DAYS_SHORT_CALLS_GT_10, DAYS_CALLS_ANSWERED, 
 ADHERENCE, TOT_RETURN_TO_QUEUE_TIMEOUT, AVG_ATTENDANCE_BALANCE, AVG_ATTENDANCE_TOTAL_BALANCE, 
 STAFF_COUNT, SUM_QC_SCORE, COUNT_QC_SCORE, QCS_REMAINING, TOT_HANDLE_TIME, TOT_HANDLE_TIME_COUNT, 
 STAFF_TRTQ_COUNT, SHORT_CALL_AGENT_COUNT, ADHERENCE_TOT_LOGGED_IN_TIME, 
 ADHERENCE_TOT_NOT_READY_TIME, CALLS_OFFERED, WEBCHAT_ASSIGNED, WEBCHAT_TRANSFERRED, WEBCHAT_CONFERENCED, 
 WEBCHAT_TOTAL_NUMBER, 
 AGENT_DISCONNECTED_SHORT_CALLS		AS SHORT_CALLS_DISCONNECTED_BY_AGENT, 
 CONSUMER_DISCONNECTED_SHORT_CALLS	AS SHORT_CALLS_DISCONNECTED_BY_CONSUMER, 
 CURRENT_MONTH_EVENTS_SCHEDULED, CURRENT_MONTH_EVENTS_MET, 
 FIRST_PRIOR_MONTH_EVENTS_SCHEDULED, FIRST_PRIOR_MONTH_EVENTS_MET, 
 SECOND_PRIOR_MONTH_EVENTS_SCHEDULED, SECOND_PRIOR_MONTH_EVENTS_MET, 
 FIRST_PRIOR_MONTH_ADHERENCE_TOT_LOGGED_IN_TIME, FIRST_PRIOR_MONTH_ADHERENCE_TOT_NOT_READY_TIME, 
 FIRST_PRIOR_MONTH_ADHERENCE_LAG_TIME_TOT_SCHED_PROD_TIME, 
 SECOND_PRIOR_MONTH_ADHERENCE_TOT_LOGGED_IN_TIME, SECOND_PRIOR_MONTH_ADHERENCE_TOT_NOT_READY_TIME, 
 SECOND_PRIOR_MONTH_ADHERENCE_LAG_TIME_TOT_SCHED_PROD_TIME, 
 THREE_MONTH_CONFORMANCE_MISSED_COUNT, 
 THREE_MONTH_AVG_ADHERENCE, 
 THREE_MONTH_ADHERENCE_FLAG, 
 MONTHLY_CONFORMANCE_FLAG
 FROM DP_SCORECARD.SC_SUMMARY_CC_ROLLUP
 ),
 CURR_STAFF AS
 (
 SELECT DISTINCT MANAGER_STAFF_ID, MANAGER_NATID, MANAGER_NAME, SUPERVISOR_STAFF_ID, SUPERVISOR_NATID, SUPERVISOR_NAME
 FROM DP_SCORECARD.SC_HIERARCHY_SUPERVISOR_MANAGER_SV
 )
SELECT CURR_STAFF.MANAGER_STAFF_ID, 
	CURR_STAFF.MANAGER_NATID, 
	CURR_STAFF.MANAGER_NAME, 
	CURR_STAFF.SUPERVISOR_STAFF_ID, 
	CURR_STAFF.SUPERVISOR_NATID, 
	CURR_STAFF.SUPERVISOR_NAME, 
	CC_ROLLUP.BUILDING, 
	CC_ROLLUP.DEPARTMENT, 
	CC_ROLLUP.D_DATE,
	CC_ROLLUP.DATES_MONTH,
	CC_ROLLUP.DATES_MONTH_NUM,
	CC_ROLLUP.DATES_YEAR,
	CC_ROLLUP.DATES_QTR_YEAR,
	CC_ROLLUP.EXCLUSION_FLAG, 
	CC_ROLLUP.TOT_CALLS_ANSWERED, 	
	CC_ROLLUP.TOT_SHORT_CALLS_ANSWERED, 
	CC_ROLLUP.TOT_TOT_RETURN_TO_QUEUE, 
	CC_ROLLUP.TOT_AVERAGE_HANDLE_TIME, 
	CC_ROLLUP.TOT_SCHED_PRODUCTIVE_TIME, 
	CC_ROLLUP.TOT_ACTUAL_PRODUCTIVE_TIME, 
	CC_ROLLUP.TOT_TALK_TIME, 
	CC_ROLLUP.TOT_WRAP_UP_TIME, 
	CC_ROLLUP.TOT_LOGGED_IN_TIME, 
	CC_ROLLUP.TOT_NOT_READY_TIME, 
	CC_ROLLUP.TOT_BREAK_TIME, 
	CC_ROLLUP.TOT_LUNCH_TIME, 
	CC_ROLLUP.QCS_PERFORMED, 
	CC_ROLLUP.AVG_QC_SCORE, 
	CC_ROLLUP.TOT_INCIDENTS_COMPLETED, 
	CC_ROLLUP.DAYS_INCIDENTS_COMPLETED, 
	CC_ROLLUP.TOT_DEFECTS_COMPLETED, 
	CC_ROLLUP.DAYS_DEFECTS_COMPLETED, 
	CC_ROLLUP.LAG_TIME_TOT_SCHED_PROD_TIME, 
	CC_ROLLUP.TOT_CALL_RECORDS, 
	CC_ROLLUP.TOT_CUSTOMER_COUNT, 
	CC_ROLLUP.TOT_CALL_WRAP_UP_COUNT, 
	CC_ROLLUP.TOT_WRAP_UP_ERROR, 
	CC_ROLLUP.DAYS_SHORT_CALLS_GT_10, 
	CC_ROLLUP.DAYS_CALLS_ANSWERED, 
	CC_ROLLUP.ADHERENCE, 
	CC_ROLLUP.TOT_RETURN_TO_QUEUE_TIMEOUT, 
	CC_ROLLUP.AVG_ATTENDANCE_BALANCE, 
	CC_ROLLUP.AVG_ATTENDANCE_TOTAL_BALANCE, 
	CC_ROLLUP.STAFF_COUNT, 
	CC_ROLLUP.SUM_QC_SCORE, 
	CC_ROLLUP.COUNT_QC_SCORE, 
	CC_ROLLUP.QCS_REMAINING, 
	CC_ROLLUP.TOT_HANDLE_TIME, 
	CC_ROLLUP.TOT_HANDLE_TIME_COUNT, 
	CC_ROLLUP.STAFF_TRTQ_COUNT, 
	CC_ROLLUP.SHORT_CALL_AGENT_COUNT, 
	CC_ROLLUP.ADHERENCE_TOT_LOGGED_IN_TIME, 
	CC_ROLLUP.ADHERENCE_TOT_NOT_READY_TIME, 
	CC_ROLLUP.CALLS_OFFERED, 
	CC_ROLLUP.WEBCHAT_ASSIGNED, 
	CC_ROLLUP.WEBCHAT_TRANSFERRED, 
	CC_ROLLUP.WEBCHAT_CONFERENCED, 
	CC_ROLLUP.WEBCHAT_TOTAL_NUMBER, 
	CC_ROLLUP.SHORT_CALLS_DISCONNECTED_BY_AGENT, 
	CC_ROLLUP.SHORT_CALLS_DISCONNECTED_BY_CONSUMER, 
	CC_ROLLUP.CURRENT_MONTH_EVENTS_SCHEDULED, 
	CC_ROLLUP.CURRENT_MONTH_EVENTS_MET, 
	CC_ROLLUP.FIRST_PRIOR_MONTH_EVENTS_SCHEDULED, 
	CC_ROLLUP.FIRST_PRIOR_MONTH_EVENTS_MET, 
	CC_ROLLUP.SECOND_PRIOR_MONTH_EVENTS_SCHEDULED, 
	CC_ROLLUP.SECOND_PRIOR_MONTH_EVENTS_MET, 
	CC_ROLLUP.FIRST_PRIOR_MONTH_ADHERENCE_TOT_LOGGED_IN_TIME, 
	CC_ROLLUP.FIRST_PRIOR_MONTH_ADHERENCE_TOT_NOT_READY_TIME, 
	CC_ROLLUP.FIRST_PRIOR_MONTH_ADHERENCE_LAG_TIME_TOT_SCHED_PROD_TIME, 
	CC_ROLLUP.SECOND_PRIOR_MONTH_ADHERENCE_TOT_LOGGED_IN_TIME, 
	CC_ROLLUP.SECOND_PRIOR_MONTH_ADHERENCE_TOT_NOT_READY_TIME, 
	CC_ROLLUP.SECOND_PRIOR_MONTH_ADHERENCE_LAG_TIME_TOT_SCHED_PROD_TIME, 
	CC_ROLLUP.THREE_MONTH_CONFORMANCE_MISSED_COUNT, 
	CC_ROLLUP.THREE_MONTH_AVG_ADHERENCE, 
	CC_ROLLUP.THREE_MONTH_ADHERENCE_FLAG, 
	CC_ROLLUP.MONTHLY_CONFORMANCE_FLAG
FROM CURR_STAFF
JOIN CC_ROLLUP ON CURR_STAFF.SUPERVISOR_STAFF_ID = CC_ROLLUP.SUPERVISOR_STAFF_ID
;

	
GRANT SELECT ON DP_SCORECARD.SC_HIERARCHY_MANAGER_SUPERVISOR_CURRENT_SV TO MAXDAT;
GRANT SELECT ON DP_SCORECARD.SC_HIERARCHY_MANAGER_SUPERVISOR_CURRENT_SV TO MAXDAT_REPORTS;
GRANT SELECT ON DP_SCORECARD.SC_HIERARCHY_MANAGER_SUPERVISOR_CURRENT_SV TO MAXDAT_READ_ONLY;
GRANT SELECT ON DP_SCORECARD.SC_HIERARCHY_MANAGER_SUPERVISOR_CURRENT_SV TO DP_SCORECARD_READ_ONLY;




	