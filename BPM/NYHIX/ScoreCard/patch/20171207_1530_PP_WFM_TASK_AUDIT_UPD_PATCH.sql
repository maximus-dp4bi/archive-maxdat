---------------------------------------------------
--  fix the bad TASK_YYYYMM for these 6 tasks
---------------------------------------------------

--update dp_scorecard.pp_wfm_task_audit_ppk_task ppk
--set task_yyyymm = to_char(make_date_time,'yyyymm')
--where ppk.task_id in (66171560, 66171561, 93502734, 93502735, 93502736, 96486052)
--/

--COMMIT;

---------------------------------------------------
---------------------------------------------------

--ALTER TABLE dp_scorecard.pp_wfm_task_audit_ppk_task
--ADD START_DATE DATE;

---------------------------------------------------
---------------------------------------------------

TRUNCATE TABLE DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS;

INSERT INTO DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS
(STAFF_ID, TASK_YYYYMM)
SELECT DISTINCT STAFF_ID, TO_CHAR(TASK_START,'YYYYMM') AS TASK_YYYYMM
FROM DP_SCORECARD.PP_WFM_TASK_BO;

COMMIT;


---------------------------------------------------
---------------------------------------------------

DELETE FROM DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS;

COMMIT;


INSERT INTO DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS
(STAFF_ID, TASK_YYYYMM)
SELECT DISTINCT STAFF_ID, TO_CHAR(TASK_START,'YYYYMM') AS TASK_YYYYMM
FROM DP_SCORECARD.PP_WFM_TASK_BO;

COMMIT;

---------------------------------------------------
---------------------------------------------------

DROP TABLE DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES;


--INSERT INTO DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES
--( TASK_ID, STAFF_ID, TASK_START, 
--   TASK_END, EXTRACT_DT, LAST_UPDATE_DT, 
--   TASK_YYYYMM, MIN_EXT_DT
--)
CREATE TABLE DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES
AS
SELECT 
	TASK_ID, STAFF_ID, TASK_START, 
   TASK_END, EXTRACT_DT, LAST_UPDATE_DT, 
   TASK_YYYYMM, MIN_EXT_DT
FROM DP_SCORECARD.PP_WFM_TASK_BO BO
--
JOIN (SELECT TASK_YYYYMM, MIN(TRUNC(EXTRACT_DT)) AS MIN_EXT_DT
FROM DP_SCORECARD.PP_WFM_TASK_AUDIT_PPK_TASK
GROUP BY TASK_YYYYMM
) EXT_DT
ON EXT_DT.TASK_YYYYMM = TO_CHAR(BO.TASK_START,'YYYYMM')
AND TRUNC(LAST_UPDATE_DT) < EXT_DT.MIN_EXT_DT
---
WHERE TASK_ID IN (
SELECT TASK_ID 
FROM DP_SCORECARD.PP_WFM_TASK_BO
WHERE NVL(DELETE_FLAG,'N') = 'N'
AND DELETE_DETECTED_DATE IS NULL
AND TO_CHAR(TASK_START,'YYYYMM') >= 201601
AND TASK_START <= SYSDATE
MINUS
SELECT TASK_ID
FROM DP_SCORECARD.PP_WFM_TASK_AUDIT_PPK_TASK
)
ORDER BY TASK_ID
/

COMMIT;


---------------------------------------------------
---------------------------------------------------

UPDATE DP_SCORECARD.PP_WFM_TASK_BO
SET DELETE_DETECTED_DATE = NULL,
DELETE_FLAG = 'N'
WHERE DELETE_DETECTED_DATE IS NOT NULL
AND TASK_ID IN ( SELECT TASK_ID FROM DP_SCORECARD.PP_WFM_TASK_AUDIT_PPK_TASK);

COMMIT;