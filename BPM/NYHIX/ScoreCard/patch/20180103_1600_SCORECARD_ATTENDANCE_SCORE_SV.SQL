CREATE OR REPLACE VIEW DP_SCORECARD.SCORECARD_ATTENDANCE_SCORE_SV
AS WITH STAFF AS
(
SELECT
       MANAGER_STAFF_ID,
       MANAGER_NAME,
       SUPERVISOR_STAFF_ID,
       SUPERVISOR_NAME,
       STAFF_STAFF_ID,
       STAFF_STAFF_NAME,
       STAFF_NATID,
       HIRE_DATE,
       0 AS SC_ATTENDANCE_ID,
       HIRE_DATE AS CREATE_DATETIME
  FROM DP_SCORECARD.SCORECARD_HIERARCHY
)
,
STAFF_INITIAL_BALANCES AS
(
SELECT S.MANAGER_STAFF_ID,
       S.MANAGER_NAME,
       S.SUPERVISOR_STAFF_ID,
       S.SUPERVISOR_NAME,
       S.STAFF_STAFF_ID,
       S.STAFF_STAFF_NAME,
       S.STAFF_NATID,
       AIS.START_DATE                              	AS DATES,
       '** Initial Balance - '
			||TO_CHAR(AIS.START_DATE,'MONTH')
			||' '||TO_CHAR(AIS.START_DATE,'YYYY')
			||' **' 								AS ABSENCE_TYPE,
       0			 		                        AS POINT_VALUE,
        NVL(AIS.ATTENDANCE_POINTS,0)                AS BALANCE,
       NVL(AIS.INCENTIVE_POINTS,0) 			        AS INCENTIVE_BALANCE,
       (NVL(AIS.ATTENDANCE_POINTS,0) + NVL(AIS.INCENTIVE_POINTS,0)) AS TOTAL_BALANCE,
       NULL                             AS INCENTIVE_FLAG,
       NULL                             AS COMMENTS,
       NULL								AS CREATE_DATETIME,
       NULL                             AS CREATE_BY,
       NULL                             AS LAST_UPDATED_BY,
       NULL                             AS LAST_UPDATED_DATETIME,
       0                                AS SC_ATTENDANCE_ID
  FROM STAFF S
  JOIN DP_SCORECARD.SC_ATTENDANCE_INITIAL_SCORE AIS
	ON S.STAFF_STAFF_ID = AIS.STAFF_ID
),
STAFF_STARTING_BALANCE AS
(
SELECT MANAGER_STAFF_ID,
       MANAGER_NAME,
       SUPERVISOR_STAFF_ID,
       SUPERVISOR_NAME,
       STAFF_STAFF_ID,
       STAFF_STAFF_NAME,
       STAFF_NATID,
       --HIRE_DATE AS DATES,
       GREATEST(HIRE_DATE,
                TO_DATE(TO_CHAR(ADD_MONTHS(SYSDATE,-12),'YYYYMM'),'YYYYMM')
               )                                    AS DATES,
       '** Starting Balance - '||to_char(sysdate,'Month')||' '||to_char(sysdate,'YYYY')||' **' as absence_type,
       0 								AS POINT_VALUE,
       40 								AS BALANCE,
       0 								AS INCENTIVE_BALANCE,
       40 								AS TOTAL_BALANCE,
       NULL AS INCENTIVE_FLAG,
       NULL AS COMMENTS,
       TO_DATE('19010101','YYYYMMDD')								AS CREATE_DATETIME,
       NULL AS CREATE_BY,
       NULL AS LAST_UPDATED_BY,
       NULL AS LAST_UPDATED_DATETIME,
       SC_ATTENDANCE_ID
  FROM STAFF S
  LEFT OUTER JOIN ( SELECT * FROM DP_SCORECARD.SC_ATTENDANCE_INITIAL_SCORE
					WHERE TO_CHAR(START_DATE,'YYYYMM') >= TO_CHAR(ADD_MONTHS(SYSDATE,-12),'YYYYMM')
				)AIS
				ON S.STAFF_STAFF_ID = AIS.STAFF_ID
				AND AIS.START_DATE = TO_DATE(TO_CHAR(ADD_MONTHS(SYSDATE,-12),'YYYYMM'),'YYYYMM')
   WHERE AIS.STAFF_ID IS NULL
),
SC_ATTEND_ENTRIES AS
(
SELECT S.MANAGER_STAFF_ID,
       S.MANAGER_NAME,
       S.SUPERVISOR_STAFF_ID,
       S.SUPERVISOR_NAME,
       S.STAFF_STAFF_ID,
       S.STAFF_STAFF_NAME,
       S.STAFF_NATID,
       SCA.ENTRY_DATE AS DATES,
       SCA.ABSENCE_TYPE,
       SCA.POINT_VALUE,
       SCA.BALANCE,
       SCA.INCENTIVE_BALANCE,
       SCA.TOTAL_BALANCE,
       SCA.INCENTIVE_FLAG,
       SCA.SC_ATTENDANCE_ID,
       SCA.CREATE_DATETIME,
       SCA.CREATE_BY,
       SCA.LAST_UPDATED_BY,
       SCA.LAST_UPDATED_DATETIME
  FROM STAFF S
INNER JOIN DP_SCORECARD.SC_ATTENDANCE SCA
    ON S.STAFF_STAFF_ID = SCA.STAFF_ID
),
COMBINED AS
( SELECT MANAGER_STAFF_ID,
       MANAGER_NAME,
       SUPERVISOR_STAFF_ID,
       SUPERVISOR_NAME,
       STAFF_STAFF_ID,
       STAFF_STAFF_NAME,
       STAFF_NATID,
       DATES,
       ABSENCE_TYPE,
       POINT_VALUE,
       BALANCE,
       INCENTIVE_BALANCE,
       TOTAL_BALANCE,
       INCENTIVE_FLAG,
       SC_ATTENDANCE_ID,
       CREATE_DATETIME,
       CREATE_BY,
       LAST_UPDATED_BY,
       LAST_UPDATED_DATETIME
  FROM STAFF_INITIAL_BALANCES
UNION ALL
SELECT MANAGER_STAFF_ID,
       MANAGER_NAME,
       SUPERVISOR_STAFF_ID,
       SUPERVISOR_NAME,
       STAFF_STAFF_ID,
       STAFF_STAFF_NAME,
       STAFF_NATID,
       DATES,
       ABSENCE_TYPE,
       POINT_VALUE,
       BALANCE,
       INCENTIVE_BALANCE,
       TOTAL_BALANCE,
       INCENTIVE_FLAG,
       SC_ATTENDANCE_ID,
       CREATE_DATETIME,
       CREATE_BY,
       LAST_UPDATED_BY,
       LAST_UPDATED_DATETIME
  FROM STAFF_STARTING_BALANCE
UNION ALL
SELECT MANAGER_STAFF_ID,
       MANAGER_NAME,
       SUPERVISOR_STAFF_ID,
       SUPERVISOR_NAME,
       STAFF_STAFF_ID,
       STAFF_STAFF_NAME,
       STAFF_NATID,
       DATES,
       ABSENCE_TYPE,
       POINT_VALUE,
       BALANCE,
       INCENTIVE_BALANCE,
       TOTAL_BALANCE,
       INCENTIVE_FLAG,
       SC_ATTENDANCE_ID,
       CREATE_DATETIME,
       CREATE_BY,
       LAST_UPDATED_BY,
       LAST_UPDATED_DATETIME
  FROM SC_ATTEND_ENTRIES
)
SELECT
	MANAGER_STAFF_ID, MANAGER_NAME, SUPERVISOR_STAFF_ID, SUPERVISOR_NAME, STAFF_STAFF_ID,
	STAFF_STAFF_NAME, STAFF_NATID, DATES, ABSENCE_TYPE, POINT_VALUE,
	BALANCE, INCENTIVE_BALANCE, TOTAL_BALANCE, INCENTIVE_FLAG, SC_ATTENDANCE_ID,
	CREATE_DATETIME, CREATE_BY, LAST_UPDATED_BY, LAST_UPDATED_DATETIME
FROM COMBINED
ORDER BY  STAFF_STAFF_ID, DATES, SC_ATTENDANCE_ID, CREATE_DATETIME
/

grant SELECT on DP_SCORECARD.SCORECARD_ATTENDANCE_SCORE_SV to MAXDAT_READ_ONLY;
grant SELECT on DP_SCORECARD.SCORECARD_ATTENDANCE_SCORE_SV to DP_SCORECARD_READ_ONLY;
