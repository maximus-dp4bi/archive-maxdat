---------------------------------------------------
-- DDL modification to DP_SCORECARD.PP_WFM_TASK_BO
---------------------------------------------------
 
ALTER TABLE DP_SCORECARD.PP_WFM_TASK_BO ADD DELETE_DETECTED_DATE DATE;

-----------------------------------------------------
-----------------------------------------------------

--DROP TABLE DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_PPK CASCADE CONSTRAINTS;

CREATE TABLE DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_PPK
(
  TASK_YYYYMM  VARCHAR2(6 BYTE),
  STAFF_ID     NUMBER(38)                       NOT NULL,
  TASK_COUNT   NUMBER,
  TASK_SUM     NUMBER,
  RUN_DATE     DATE
)
TABLESPACE MAXDAT_DATA
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
LOGGING 
NOCOMPRESS 
NOCACHE
MONITORING;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_PPK TO MAXDAT;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_PPK TO MAXDAT_READ_ONLY;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_PPK TO MAXDAT_REPORTS;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_PPK TO DP_SCORECARD_READ_ONLY; 

-----------------------------------------------------
-----------------------------------------------------

--DROP TABLE DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_SC CASCADE CONSTRAINTS;

CREATE TABLE DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_SC
(
  TASK_YYYYMM  VARCHAR2(6 BYTE),
  STAFF_ID     NUMBER(38)                       NOT NULL,
  TASK_COUNT   NUMBER,
  TASK_SUM     NUMBER,
  RUN_DATE     DATE
)
TABLESPACE MAXDAT_DATA
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
LOGGING 
NOCOMPRESS 
NOCACHE
MONITORING;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_SC TO MAXDAT;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_SC TO MAXDAT_READ_ONLY;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_SC TO MAXDAT_REPORTS;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_SC TO DP_SCORECARD_READ_ONLY; 

---------------------------------------------------
-- CREATE TABLE DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES
---------------------------------------------------

--DROP TABLE DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES CASCADE CONSTRAINTS;

CREATE TABLE DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES
(
  STAFF_ID              NUMBER(38),
  TASK_YYYYMM           VARCHAR2(40 BYTE),
  TASK_ID               NUMBER(38),
  DELETE_DETECTED_DATE  DATE
)
TABLESPACE MAXDAT_DATA
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
LOGGING 
NOCOMPRESS 
NOCACHE
MONITORING;

CREATE INDEX DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DEL_IDX1 ON DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES
(STAFF_ID, TASK_ID, TASK_YYYYMM)
LOGGING
TABLESPACE MAXDAT_INDX
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           );

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES TO MAXDAT;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES TO MAXDAT_READ_ONLY;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES TO MAXDAT_REPORTS;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES TO DP_SCORECARD_READ_ONLY; 

---------------------------------------------------
-- create table PP_WFM_TASK_AUDIT_CNTRL_DIFFS
---------------------------------------------------

-- DROP TABLE DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS CASCADE CONSTRAINTS;

CREATE TABLE DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS
(
  TASK_YYYYMM      VARCHAR2(6 BYTE),
  STAFF_ID         NUMBER(38),
  WFM_TASK_YYYYMM  VARCHAR2(6 BYTE),
  WFM_STAFF_ID     NUMBER(38),
  WFM_TASK_COUNT   NUMBER,
  WFM_TASK_SUM     NUMBER,
  SC_TASK_YYYYMM   VARCHAR2(6 BYTE),
  SC_STAFF_ID      NUMBER(38),
  SC_TASK_COUNT    NUMBER,
  SC_TASK_SUM      NUMBER
)
TABLESPACE MAXDAT_DATA
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
LOGGING 
NOCOMPRESS 
NOCACHE
MONITORING;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS TO MAXDAT;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS TO MAXDAT_READ_ONLY;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS TO MAXDAT_REPORTS;

GRANT SELECT ON DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS TO DP_SCORECARD_READ_ONLY; 

---------------------------------------------------
---------------------------------------------------

INSERT INTO PP_WFM_TASK_AUDIT_CNTRL_DIFFS
(STAFF_ID, TASK_YYYYMM)
SELECT DISTINCT STAFF_ID, TASK_YYYYMM
FROM PP_WFM_TASK_AUDIT_PPK_TASK;

COMMIT;

---------------------------------------------------
---------------------------------------------------

INSERT INTO DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES
(STAFF_ID, TASK_YYYYMM, TASK_ID, DELETE_DETECTED_DATE)
SELECT STAFF_ID, 
	TO_CHAR(TASK_START,'YYYYMM') AS TASK_YYYYMM, 
	TASK_ID, 
	SYSDATE AS DELETE_DETECTED_DATE
FROM DP_SCORECARD.PP_WFM_TASK_BO
WHERE NVL(DELETE_FLAG,'N') = 'N'
AND DELETE_DETECTED_DATE IS NULL
AND ( STAFF_ID, TO_CHAR(TASK_START,'YYYYMM' ))
    IN ( SELECT STAFF_ID, TASK_YYYYMM 
        FROM DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS 
        WHERE TASK_YYYYMM BETWEEN '201601' AND TO_CHAR(SYSDATE,'YYYYMM')
        )
MINUS
SELECT STAFF_ID, TO_CHAR(TASK_YYYYMM), TASK_ID, SYSDATE 
FROM PP_WFM_TASK_AUDIT_PPK_TASK
WHERE TASK_YYYYMM BETWEEN '201601' AND TO_CHAR(SYSDATE,'YYYYMM')
AND ( STAFF_ID, TASK_YYYYMM )
    IN ( SELECT STAFF_ID, TASK_YYYYMM 
        FROM DP_SCORECARD.PP_WFM_TASK_AUDIT_CNTRL_DIFFS
        WHERE TASK_YYYYMM BETWEEN '201601' AND TO_CHAR(SYSDATE,'YYYYMM')
        )
/

commit;

----------------------------------------------------
----------------------------------------------------

UPDATE DP_SCORECARD.PP_WFM_TASK_BO T  -- 1,605,108 ROWS UPDATED.
SET T.DELETE_FLAG = 'Y', 
	T.DELETE_DETECTED_DATE = SYSDATE
	--( SELECT DELETE_DETECTED_DATE
	--FROM DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES D
	--WHERE D.TASK_ID = T.TASK_ID
	--AND D.STAFF_ID = T.STAFF_ID
	--AND TO_CHAR(T.TASK_START,'YYYYMM') = D.TASK_YYYYMM
	--)
WHERE NVL(T.DELETE_FLAG,'N') = 'N'
AND T.DELETE_DETECTED_DATE IS NULL
AND (STAFF_ID, TASK_ID, TO_CHAR(TASK_START,'YYYYMM'))
IN ( SELECT STAFF_ID, TASK_ID, TASK_YYYYMM
FROM DP_SCORECARD.PP_WFM_TASK_AUDIT_SC_DELETES
);		

COMMIT;

-- **********************************************
-- End of SCRIPT
-- **********************************************
