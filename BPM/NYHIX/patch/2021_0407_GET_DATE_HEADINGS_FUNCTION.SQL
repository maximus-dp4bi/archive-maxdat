create or replace FUNCTION GET_DATE_HEADINGS (PARM_DATE DATE)
	RETURN VARCHAR2
IS 
    LV_RN                       NUMBER;
    LV_LVL                      NUMBER;
    LV_D_DATE                   DATE; 
    LV_HOLIDAY_DATE             DATE;  
    LV_DAY                      VARCHAR2(100) := NULL;
    LV_COL_NUM                  NUMBER(2) := 0;
    LV_COL_HEADING_HOLD         VARCHAR2(100) := NULL;
    LV_COL_HEADING_OUT          VARCHAR2(100) := NULL;

    CURSOR C1 IS
     SELECT D.RN, D.LVL, D.D_DATE, H.HOLIDAY_DATE, TO_CHAR(D.D_DATE,'DY') AS DY
   -- INTO LV_RN, LV_LVL, LV_D_DATE, LV_HOLIDAY_DATE, LV_DAY      
    FROM 
   (
   SELECT
        ROWNUM AS RN, 
        LEVEL+1 AS LVL,
       -- (TO_DATE('20210216','YYYYMMDD')-5 + LEVEL) AS D_DATE  --<<FOR TESTING
        (PARM_DATE-5 + LEVEL) AS D_DATE  -- LOOK FOERWARD
    FROM DUAL 
          CONNECT BY LEVEL <= 11
    ) D
    LEFT OUTER JOIN MAXDAT.HOLIDAYS H
    ON TRUNC(H.HOLIDAY_DATE) = TRUNC(D.D_DATE)
    ORDER BY D_DATE DESC;

BEGIN

    IF C1%ISOPEN
    THEN CLOSE C1;
    END IF;

    OPEN C1;

    LOOP

    FETCH C1 INTO
        LV_RN, LV_LVL, LV_D_DATE, LV_HOLIDAY_DATE, LV_DAY;

    EXIT WHEN C1%NOTFOUND;

    IF LV_DAY NOT IN ('SAT','SUN')
    AND LV_HOLIDAY_DATE IS NULL
    AND LV_D_DATE > PARM_DATE
    THEN -- IT IS A WORK DAY SEQUENCIALLY BEFORE THE PARM_DATE IN THE CURSOR
        LV_COL_HEADING_HOLD := TO_CHAR(LV_D_DATE,'MM/DD/YYYY');
        CONTINUE;
    END IF;

    --HOLIDAY
    IF ( LV_DAY IN ('SAT','SUN')
    OR LV_HOLIDAY_DATE IS NOT NULL )
    THEN -- ITS A HOLIDAY -- SAVE AND APPEND TO THE HEADING_HOLD
    --SAVE THE DATE
--        LV_COL_HEADING_HOLD := LTRIM(LV_COL_HEADING_HOLD||', '||TO_CHAR(LV_D_DATE,'MM/DD/YYYY'),',');
        LV_COL_HEADING_HOLD := TO_CHAR(LV_D_DATE,'MM/DD/YYYY')||','||LTRIM(LV_COL_HEADING_HOLD);
        CONTINUE;
    END IF;   

--  WORK DAY
    IF LV_DAY NOT IN ('SAT','SUN')
    AND LV_HOLIDAY_DATE IS NULL
    AND LV_D_DATE = PARM_DATE
    THEN -- IT IS A WORK DAY EQUAL TO THE PARM_DATE -- SAVE IT
        LV_COL_HEADING_HOLD := TO_CHAR(LV_D_DATE,'MM/DD/YYYY');
        CONTINUE;
    END IF;

--  WORK DAY
    IF LV_DAY NOT IN ('SAT','SUN')
    AND LV_HOLIDAY_DATE IS NULL
    AND LV_D_DATE < PARM_DATE
    THEN -- IT IS A WORK DAY AFTER THE PARM DATE IN THE CURSOR
       LV_COL_HEADING_OUT := LV_COL_HEADING_HOLD;
       LV_COL_HEADING_HOLD:= LV_D_DATE;
       RETURN LV_COL_HEADING_OUT;
    END IF;


    END LOOP;

    IF C1%ISOPEN
    THEN CLOSE C1;
    END IF;

    RETURN '??';  --<< THIS SHOULD NOT HAPPEN

 END;  

/ 
SHOW ERRORS 

GRANT EXECUTE ON MAXDAT.GET_DATE_HEADINGS TO MAXDAT_READ_ONLY;
