CREATE OR REPLACE VIEW maxdat_support.eligibility_assessment_client_sv as 
SELECT dense_rank() OVER (PARTITION BY ds_load_ts_month ORDER BY ds_load_ts_month,case program_type when 'PT26301' then 'FAM' when 'PT26302' then 'KID' else program_type END ,abs(current_date - least(coalesce(anniversary_date,app_due_date),coalesce(app_due_date,anniversary_date))),uclient.case_id,uclient.client_ssn) AS sequence,
    uclient.client_name,
    uclient.client_ssn,
    uclient.client_dob,
    uclient.dcn,
    uclient.ref_case_id,
    uclient.ref_client_id,
    uclient.gender,
    uclient.marital_status,
    uclient.client_hoh,
    uclient.family_size,
    uclient.gross_income,
    uclient.citizenship_status,
    uclient.citizen_verified,
    uclient.alien_reg_nbr,
    uclient.program_type,
    uclient.aid_category,
    uclient.case_id,
    uclient.anniversary_date,
    uclient.applicant_status,
    uclient.status_date,
    uclient.application_id,
    uclient.app_due_date,
    uclient.record_processing_date,
    abs(current_date - least(coalesce(anniversary_date,app_due_date),coalesce(app_due_date,anniversary_date))) sort_index,
    case when anniversary_date is not null and app_due_date is not null 
      then case when abs(current_date - anniversary_date) < abs(current_date - app_due_date) then anniversary_date else app_due_date end 
                when anniversary_date is null then app_due_date 
                when app_due_date is null then anniversary_date end as sort_date,
     ds_load_ts,
	 uclient.case_id_ext,
	 uclient.decedent_ssn,
	 uclient.decedent_name,
	 uclient.decedent_date_of_birth,
	 uclient.decedent_date_of_death,
	 uclient.decedent_recorded_state_code,
	 uclient.decedent_residence_county
   FROM 
(select 
    --eligibility_assessment_paris_inter_sv.client_name,
    eligibility_assessment_paris_inter_sv.cust_name AS client_name,
    eligibility_assessment_paris_inter_sv.client_ssn,
    eligibility_assessment_paris_inter_sv.client_dob,
    eligibility_assessment_paris_inter_sv.dcn,
    eligibility_assessment_paris_inter_sv.ref_case_id,
    eligibility_assessment_paris_inter_sv.ref_client_id,
    eligibility_assessment_paris_inter_sv.gender,
    eligibility_assessment_paris_inter_sv.marital_status,
    eligibility_assessment_paris_inter_sv.client_hoh,
    eligibility_assessment_paris_inter_sv.family_size,
    eligibility_assessment_paris_inter_sv.gross_income,
    eligibility_assessment_paris_inter_sv.citizenship_status,
    eligibility_assessment_paris_inter_sv.citizen_verified,
    eligibility_assessment_paris_inter_sv.alien_reg_nbr,
    eligibility_assessment_paris_inter_sv.program_type,
    eligibility_assessment_paris_inter_sv.aid_category,
    eligibility_assessment_paris_inter_sv.case_id,
    eligibility_assessment_paris_inter_sv.anniversary_date,
    eligibility_assessment_paris_inter_sv.applicant_status,
    eligibility_assessment_paris_inter_sv.status_date,
    eligibility_assessment_paris_inter_sv.application_id,
    eligibility_assessment_paris_inter_sv.app_due_date,
    eligibility_assessment_paris_inter_sv.record_processing_date,
    DATE_TRUNC('day'::text, eligibility_assessment_paris_inter_sv.ds_load_ts) ds_load_ts,
    DATE_TRUNC('month'::text, eligibility_assessment_paris_inter_sv.ds_load_ts) ds_load_ts_month,
	eligibility_assessment_paris_inter_sv.case_id_ext,
	eligibility_assessment_paris_inter_sv.decedent_ssn,
	eligibility_assessment_paris_inter_sv.decedent_name,
	eligibility_assessment_paris_inter_sv.decedent_date_of_birth,
	eligibility_assessment_paris_inter_sv.decedent_date_of_death,
	eligibility_assessment_paris_inter_sv.decedent_recorded_state_code,
	eligibility_assessment_paris_inter_sv.decedent_residence_county
   FROM maxdat_support.eligibility_assessment_paris_inter_sv
UNION
    select
	--eligibility_assessment_paris_va_sv.client_name,
    eligibility_assessment_paris_va_sv.cust_name AS client_name,
    eligibility_assessment_paris_va_sv.client_ssn,
    eligibility_assessment_paris_va_sv.client_dob,
    eligibility_assessment_paris_va_sv.dcn,
    eligibility_assessment_paris_va_sv.ref_case_id,
    eligibility_assessment_paris_va_sv.ref_client_id,
    eligibility_assessment_paris_va_sv.gender,
    eligibility_assessment_paris_va_sv.marital_status,
    eligibility_assessment_paris_va_sv.client_hoh,
    eligibility_assessment_paris_va_sv.family_size,
    eligibility_assessment_paris_va_sv.gross_income,
    eligibility_assessment_paris_va_sv.citizenship_status,
    eligibility_assessment_paris_va_sv.citizen_verified,
    eligibility_assessment_paris_va_sv.alien_reg_nbr,
    eligibility_assessment_paris_va_sv.program_type,
    eligibility_assessment_paris_va_sv.aid_category,
    eligibility_assessment_paris_va_sv.case_id,
    eligibility_assessment_paris_va_sv.anniversary_date,
    eligibility_assessment_paris_va_sv.applicant_status,
    eligibility_assessment_paris_va_sv.status_date,
    eligibility_assessment_paris_va_sv.application_id,
    eligibility_assessment_paris_va_sv.app_due_date,
    eligibility_assessment_paris_va_sv.record_processing_date,
    DATE_TRUNC('day'::text, eligibility_assessment_paris_va_sv.ds_load_ts) ds_load_ts,
    DATE_TRUNC('month'::text, eligibility_assessment_paris_va_sv.ds_load_ts) ds_load_ts_month,
	eligibility_assessment_paris_va_sv.case_id_ext,
	eligibility_assessment_paris_va_sv.decedent_ssn,
	eligibility_assessment_paris_va_sv.decedent_name,
	eligibility_assessment_paris_va_sv.decedent_date_of_birth,
	eligibility_assessment_paris_va_sv.decedent_date_of_death,
	eligibility_assessment_paris_va_sv.decedent_recorded_state_code,
	eligibility_assessment_paris_va_sv.decedent_residence_county
   FROM maxdat_support.eligibility_assessment_paris_va_sv) uclient;

-- Permissions

ALTER TABLE maxdat_support.eligibility_assessment_client_sv OWNER TO maxdat_support;
GRANT ALL ON TABLE maxdat_support.eligibility_assessment_client_sv TO maxdat_support;
GRANT ALL ON TABLE maxdat_support.eligibility_assessment_client_sv TO maxdat_reports;
