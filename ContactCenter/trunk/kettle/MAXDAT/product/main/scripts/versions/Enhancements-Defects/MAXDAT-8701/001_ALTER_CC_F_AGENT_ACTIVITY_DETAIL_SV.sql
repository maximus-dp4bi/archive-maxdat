CREATE OR REPLACE VIEW CC_F_AGENT_ACTIVITY_DETAIL_SV (F_AGENT_ACTIVITY_DETAIL_ID, D_DATE_ID, D_AGENT_ID, ACTIVITY_EVENT_TYPE_ID, ACTIVITY, EVENTDESC, D_PROGRAM_ID, D_GEOGRAPHY_MASTER_ID, D_GROUP_ID, D_PROJECT_ID, D_SITE_ID, ACTIVITY_START_UTC_DT, ACTIVITY_END_UTC_DT, ACTIVITY_START_ET_DT, ACTIVITY_END_ET_DT, ACTIVITY_DURATION_SECONDS, CREATE_DATE, CREATED_BY, LAST_UPDATE_DATE, LAST_UPDATE_BY, AGENT_LOGIN_ID) AS 
SELECT T.F_AGENT_ACTIVITY_DETAIL_ID,T.D_DATE_ID,T.D_AGENT_ID,T.ACTIVITY_EVENT_TYPE_ID,T.ACTIVITY,T.EVENTDESC,T.D_PROGRAM_ID,T.D_GEOGRAPHY_MASTER_ID,T.D_GROUP_ID,T.D_PROJECT_ID,T.D_SITE_ID,T.ACTIVITY_START_UTC_DT,T.ACTIVITY_END_UTC_DT,T.ACTIVITY_START_ET_DT,T.ACTIVITY_END_ET_DT,T.ACTIVITY_DURATION_SECONDS,T.CREATE_DATE,T.CREATED_BY,T.LAST_UPDATE_DATE,T.LAST_UPDATE_BY,T.AGENT_LOGIN_ID FROM 
(
	SELECT
        MAX(F_AGENT_ACTIVITY_DETAIL_ID) AS F_AGENT_ACTIVITY_DETAIL_ID,
        D_DATE_ID,
        D_AGENT_ID,
        D_PROGRAM_ID,
        D_GEOGRAPHY_MASTER_ID,
        D_GROUP_ID,
        D_PROJECT_ID,
        D_SITE_ID,
        MAX(ACTIVITY_EVENT_TYPE_ID) AS ACTIVITY_EVENT_TYPE_ID,
		ACTIVITY,
        EVENTDESC,
        MIN(UTC_ACTIVITY_START_DATETIME) ACTIVITY_START_UTC_DT,
        MAX(UTC_ACTIVITY_END_DATETIME) ACTIVITY_END_UTC_DT,
        MIN(ACTIVITY_START_DATETIME) ACTIVITY_START_ET_DT,
        MAX(ACTIVITY_END_DATETIME) ACTIVITY_END_ET_DT,
        SUM(ACTIVITY_DURATION_SECONDS) ACTIVITY_DURATION_SECONDS,
        CREATE_DATE,
        CREATED_BY,
        LAST_UPDATE_DATE,
        LAST_UPDATE_BY,
        AGENT_LOGIN_ID
    FROM
        (
        SELECT
		    F.F_AGENT_ACTIVITY_DETAIL_ID,
            F.D_DATE_ID,
            F.D_AGENT_ID,
            F.D_PROGRAM_ID,
            F.D_GEOGRAPHY_MASTER_ID,
            F.D_GROUP_ID,
            F.D_PROJECT_ID,
            F.D_SITE_ID,
            CASE WHEN A.EVENTDESC = 'Logout' THEN (F.UTC_ACTIVITY_START_DATETIME-F.ACTIVITY_DURATION_SECONDS/(24*60*60))
			     ELSE F.UTC_ACTIVITY_START_DATETIME
			END AS UTC_ACTIVITY_START_DATETIME,
            CASE WHEN A.EVENTDESC = 'Logout' THEN F.UTC_ACTIVITY_START_DATETIME
			     ELSE F.UTC_ACTIVITY_END_DATETIME
			END AS UTC_ACTIVITY_END_DATETIME,
            CASE WHEN A.EVENTDESC = 'Logout' THEN (F.ACTIVITY_START_DATETIME-F.ACTIVITY_DURATION_SECONDS/(24*60*60))
			     ELSE F.ACTIVITY_START_DATETIME
			END AS ACTIVITY_START_DATETIME,
            CASE WHEN A.EVENTDESC = 'Logout' THEN F.ACTIVITY_START_DATETIME
			     ELSE F.ACTIVITY_END_DATETIME
			END AS ACTIVITY_END_DATETIME,
            F.ACTIVITY_DURATION_SECONDS,
            LAST_VALUE(F.CREATE_DATE) over (partition by F.AGENT_LOGIN_ID,F.D_PROGRAM_ID,F.D_GEOGRAPHY_MASTER_ID,F.D_GROUP_ID,F.D_PROJECT_ID,F.D_SITE_ID order by F.UTC_ACTIVITY_START_DATETIME) AS CREATE_DATE,
            LAST_VALUE(F.CREATED_BY) over (partition by F.AGENT_LOGIN_ID,F.D_PROGRAM_ID,F.D_GEOGRAPHY_MASTER_ID,F.D_GROUP_ID,F.D_PROJECT_ID,F.D_SITE_ID order by F.UTC_ACTIVITY_START_DATETIME) AS CREATED_BY,
            LAST_VALUE(F.LAST_UPDATE_DATE) over (partition by F.AGENT_LOGIN_ID,F.D_PROGRAM_ID,F.D_GEOGRAPHY_MASTER_ID,F.D_GROUP_ID,F.D_PROJECT_ID,F.D_SITE_ID order by F.UTC_ACTIVITY_START_DATETIME) AS LAST_UPDATE_DATE,
            LAST_VALUE(F.LAST_UPDATE_BY) over (partition by F.AGENT_LOGIN_ID,F.D_PROGRAM_ID,F.D_GEOGRAPHY_MASTER_ID,F.D_GROUP_ID,F.D_PROJECT_ID,F.D_SITE_ID order by F.UTC_ACTIVITY_START_DATETIME) AS LAST_UPDATE_BY,
            F.AGENT_LOGIN_ID,
            F.ACTIVITY_EVENT_TYPE_ID,
            A.ACTIVITY,
            A.EVENTDESC,
            row_number() over (partition by F.AGENT_LOGIN_ID,F.D_PROGRAM_ID,F.D_GEOGRAPHY_MASTER_ID,F.D_GROUP_ID,F.D_PROJECT_ID,F.D_SITE_ID order by F.UTC_ACTIVITY_START_DATETIME) as rn,
            row_number() over (partition by F.AGENT_LOGIN_ID,F.D_PROGRAM_ID,F.D_GEOGRAPHY_MASTER_ID,F.D_GROUP_ID,F.D_PROJECT_ID,F.D_SITE_ID,A.ACTIVITY,A.EVENTDESC order by F.UTC_ACTIVITY_START_DATETIME) as state_rn
        FROM CC_F_ACD_AGENT_ACTIVITY_DETAIL F 
             LEFT JOIN CC_C_ACD_ACTIVITY_EVENT_TYPE A 
               ON F.ACTIVITY_EVENT_TYPE_ID=A.ACD_ACTIVITY_EVENT_TYPE_ID
        )
    GROUP BY 
        D_AGENT_ID,
        D_DATE_ID,
        D_PROGRAM_ID,
        D_GEOGRAPHY_MASTER_ID,
        D_GROUP_ID,
        D_PROJECT_ID,
        D_SITE_ID,
        AGENT_LOGIN_ID,
        ACTIVITY,
        EVENTDESC,
        CREATE_DATE,
        CREATED_BY,
        LAST_UPDATE_DATE,
        LAST_UPDATE_BY,
        (rn - state_rn)
) T
WITH READ ONLY;