alter session set current_schema = cisco_enterprise_cc;

CREATE OR REPLACE VIEW CC_NCEB_F_V2_CALL_SV 
AS 
SELECT
 F.F_V2_CALL_ID
,F.D_DATE_ID
,F.DATETIME
,F.CALLTYPE_REPORTING_DATETIME
,F.D_CONTACT_QUEUE_ID
,F.QUEUE_NUMBER
,F.D_AGENT_ID
,F.AGENT_LOGIN_ID
,F.ROUTER_CALL_KEY_DAY
,F.ROUTER_CALL_KEY
,F.PERIPHERAL_CALL_KEY
,F.PERIPHERAL_CALL_TYPE
,F.PERIPHERAL_ID
,F.SKILL_GROUP_ID
,F.PRECISION_QUEUE_ID
,F.SOURCE_D_AGENT_ID
,F.SOURCE_AGENT_LOGIN_ID
,F.CALL_REFERENCE_ID
,F.CALLGUID
,F.CALL_SEGMENT_ID
,F.SOURCE_CALL_ID
,F.ACTIVITY_ID
,F.DIGITS_DIALED
,F.ANI_PHONE_NUMBER
,F.CALL_DISPOSITION
,DL.CALL_DISPOSITION_DESC
,F.CALL_DISPOSITION_FLAG
,DFL.CALL_DISPOSITION_FLG_DESC
,F.DNIS
,(SELECT COALESCE((select lookup_value from cc_c_lookup where lookup_type = 'LANGUAGE_CODE' and lookup_key = F.QUEUE_NUMBER), 'UNKNOWN') from dual) LANGUAGE
,F.QUEUE_TIME_SECONDS
,F.RING_TIME_SECONDS
,F.HOLD_TIME_SECONDS
,F.WORK_TIME_SECONDS
,F.TALK_TIME_SECONDS
,F.IVR_TIME_SECONDS
,F.NETWORK_TIME_SECONDS
,F.LOCAL_Q_TIME_SECONDS
,F.DELAY_TIME_SECONDS
,F.TIME_TO_ABAND_SECONDS
,F.CALL_DURATION
,F.TRANSFER_TO
,F.XFERRED_OUT_FLAG
,CASE WHEN
	D.QUEUE_TYPE in  (SELECT distinct rtrim(ltrim(regexp_substr(OUT_VAR, '[^,]+', 1, level),''''),'''')
  FROM (SELECT OUT_VAR  FROM CC_A_LIST_LKUP WHERE NAME = 'VM_call_types')
CONNECT BY instr(OUT_VAR, ',', 1, level - 1) > 0)
	THEN 'Y' 	ELSE 'N' END VOICEMAIL_FLAG
,CASE WHEN TIME_TO_ABAND_SECONDS > 0 THEN 1 ELSE 0 END CALL_ABANDONED_FLAG
,CASE WHEN
	D.QUEUE_TYPE in  (SELECT distinct rtrim(ltrim(regexp_substr(OUT_VAR, '[^,]+', 1, level),''''),'''')
  FROM (SELECT OUT_VAR  FROM CC_A_LIST_LKUP WHERE NAME = 'Handled_Inbound_call_types')
CONNECT BY instr(OUT_VAR, ',', 1, level - 1) > 0)
	THEN 1 	ELSE 0 END CALL_OFFERED_FLAG
,CASE WHEN TALK_TIME_SECONDS >0 THEN 1 ELSE 0 END CALL_ANSWERED_FLAG
,CASE WHEN CALL_DISPOSITION in (8,9,11) THEN 1 ELSE 0 END CALL_BUSY_FLAG
,CASE WHEN CALL_DISPOSITION in (10,12) THEN 1 ELSE 0 END CALL_DROPPED_FLAG
,CASE
   WHEN F.D_CONTACT_QUEUE_ID IS NOT NULL THEN D.QUEUE_TYPE
   WHEN F.PERIPHERAL_CALL_TYPE = 9 THEN 'Agent'
   WHEN F.CALL_HANDLE_METHOD = 'Predictive Dialer' THEN CALL_HANDLE_METHOD
ELSE NULL
END CALL_HANDLE_METHOD
,'Manual' as CALL_DIAL_METHOD
,F.CALL_SEGMENT_END_DT
,F.CREATE_DATE
,F.LAST_UPDATE_DATE
,F.LAST_UPDATED_BY
,NULL AS CUSTOMER_ACCOUNT_NUMBER
, D.D_PROJECT_ID
,D.D_PROGRAM_ID
,D.D_UNIT_OF_WORK_ID
FROM CC_F_V2_CALL F
LEFT OUTER JOIN CC_D_CONTACT_QUEUE D ON F.D_CONTACT_QUEUE_ID = D.D_CONTACT_QUEUE_ID
LEFT OUTER JOIN CC_C_CALL_DISPOSITION_LKUP DL ON F.CALL_DISPOSITION = DL.CALL_DISPOSITION_CODE
LEFT OUTER JOIN CC_C_CALL_DISPOSITION_FLG_LKUP DFL ON F.CALL_DISPOSITION_FLAG = DFL.CALL_DISPOSITION_FLG_CODE
LEFT JOIN CC_D_PROJECT P ON D.D_PROJECT_ID = P.PROJECT_ID
WHERE P.PROJECT_NAME = 'NCEB';


GRANT SELECT ON CC_NCEB_F_V2_CALL_SV  TO MAXDAT_READ_ONLY;