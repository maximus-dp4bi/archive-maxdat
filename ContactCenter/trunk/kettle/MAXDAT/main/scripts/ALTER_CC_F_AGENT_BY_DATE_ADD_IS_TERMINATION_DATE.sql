/*

select distinct d_date
from cc_f_agent_by_date f
inner join cc_d_dates dd on f.d_date_id = dd.d_date_id
order by d_date desc
;

select d_date_id, d_date, next_date
from (
  select d_date_id, d_date, lead(d_date) over (order by d_date_id) next_date
  from cc_d_dates
)
where next_date - d_date = 1
order by d_date_id;

SELECT LOGIN_ID, COUNT(*)
FROM CC_D_AGENT
WHERE RECORD_END_DT > SYSDATE
GROUP BY LOGIN_ID
HAVING COUNT(*) > 1
;

SELECT D_AGENT_ID, D_DATE_ID, COUNT(*)
FROM CC_F_AGENT_BY_DATE F
GROUP BY D_AGENT_ID, D_DATE_ID
HAVING COUNT(*) > 1;

*/

ALTER TABLE CC_F_AGENT_BY_DATE ADD(CREATE_DATE DATE DEFAULT SYSDATE NOT NULL, LAST_UPDATE_DATE DATE DEFAULT SYSDATE NOT NULL);
ALTER TABLE CC_F_AGENT_ACTIVITY_BY_DATE ADD(CREATE_DATE DATE DEFAULT SYSDATE NOT NULL, LAST_UPDATE_DATE DATE DEFAULT SYSDATE NOT NULL);

UPDATE (
  SELECT F_AGENT_ACTIVITY_BY_DATE_ID
  , CREATE_DATE
  , LAST_UPDATE_DATE
  , D_DATE
  FROM CC_F_AGENT_ACTIVITY_BY_DATE F
  INNER JOIN CC_D_DATES DD ON F.D_DATE_ID = DD.D_DATE_ID
)
SET CREATE_DATE = D_DATE +1, LAST_UPDATE_DATE = D_DATE + 1
;

UPDATE (
  SELECT F_AGENT_BY_DATE_ID
  , CREATE_DATE
  , LAST_UPDATE_DATE
  , D_DATE
  FROM CC_F_AGENT_BY_DATE F
  INNER JOIN CC_D_DATES DD ON F.D_DATE_ID = DD.D_DATE_ID
)
SET CREATE_DATE = D_DATE +1, LAST_UPDATE_DATE = D_DATE + 1
;



-- ALTER TABLE CC_F_AGENT_BY_DATE DROP (IS_TERMINATION_DATE);
-- ALTER TABLE CC_F_AGENT_BY_DATE ADD (IS_TERMINATION_DATE VARCHAR2(1) DEFAULT 'N' NOT NULL);


MERGE INTO CC_F_AGENT_BY_DATE F
  USING (
    WITH LAST_AGENT_DATE AS (
      SELECT D_AGENT_ID, MAX(D_DATE_ID) AS D_DATE_ID
      FROM CC_F_AGENT_BY_DATE 
      GROUP BY D_AGENT_ID
    )
    SELECT 
      F.D_AGENT_ID
      , D_PROJECT_TARGETS_ID
      , D_PROGRAM_ID
      , D_GEOGRAPHY_MASTER_ID
      , D_GROUP_ID
      , SUPERVISOR_D_AGENT_ID
      , MANAGER_D_AGENT_ID
      , D_SITE_ID
      , TD.D_DATE_ID AS TERMINATION_DATE_ID
    FROM CC_F_AGENT_BY_DATE F
    INNER JOIN LAST_AGENT_DATE 
      ON F.D_AGENT_ID = LAST_AGENT_DATE.D_AGENT_ID
      AND F.D_DATE_ID = LAST_AGENT_DATE.D_DATE_ID
    INNER JOIN CC_D_AGENT CDA ON F.D_AGENT_ID = CDA.D_AGENT_ID
    INNER JOIN CC_D_DATES TD ON CDA.TERMINATION_DATE = TD.D_DATE
    INNER JOIN CC_D_DATES LD ON F.D_DATE_ID = LD.D_DATE_ID
    WHERE CDA.TERMINATION_DATE IS NOT NULL
  ) TERMINATED_AGENTS
  ON (
    F.D_AGENT_ID = TERMINATED_AGENTS.D_AGENT_ID 
    AND F.D_DATE_ID = TERMINATED_AGENTS.TERMINATION_DATE_ID
  )
  WHEN MATCHED THEN 
    UPDATE SET F.IS_TERMINATION_DATE = 'Y' 
  WHEN NOT MATCHED THEN 
    INSERT (
      D_AGENT_ID
      , D_DATE_ID
      , D_PROJECT_TARGETS_ID
      , D_PROGRAM_ID
      , D_GEOGRAPHY_MASTER_ID
      , D_GROUP_ID
      , SUPERVISOR_D_AGENT_ID
      , MANAGER_D_AGENT_ID
      , D_SITE_ID
      , IS_TERMINATION_DATE
      , PREVIEW_TALK_SECONDS 
      , INTERNAL_SECONDS 
      , EXTERNAL_SECONDS 
      , ACTUAL_OVERTIME_MINUTES 
      , ACTUAL_SHIFT_MINUTES 
      , NOT_READY_SECONDS 
      , TALK_RESERVE_SECONDS 
      , INTERNAL_CALLS_COUNT 
      , LOGIN_SECONDS 
      , RING_SECONDS 
      , HOLD_SECONDS 
      , BUSYONDNTIME 
      , WRAP_SECONDS 
      , IDLE_SECONDS 
      , PREVIEW_CALLS_COUNT 
      , CONSULTATION_TIME 
      , PREDICTIVE_CALLS_COUNT 
      , LAST_LOGOUT 
      , PREDICTIVE_TALK_SECONDS 
      , TALK_SECONDS 
      , BREAK_TIME 
      , SCHEDULED_SHIFT_MINUTES 
      , HANDLE_CALLS_COUNT 
      , HANDLE_TIME_SECONDS 
      , FIRST_LOGIN 
      , WALKAWAY_TIME 
      , EXTERNAL_CALLS_COUNT
    ) VALUES (
      TERMINATED_AGENTS.D_AGENT_ID
      , TERMINATED_AGENTS.TERMINATION_DATE_ID
      , TERMINATED_AGENTS.D_PROJECT_TARGETS_ID
      , TERMINATED_AGENTS.D_PROGRAM_ID
      , TERMINATED_AGENTS.D_GEOGRAPHY_MASTER_ID
      , TERMINATED_AGENTS.D_GROUP_ID
      , TERMINATED_AGENTS.SUPERVISOR_D_AGENT_ID
      , TERMINATED_AGENTS.MANAGER_D_AGENT_ID
      , TERMINATED_AGENTS.D_SITE_ID
      , 'Y' -- IS_TERMINATION_DATE
      , 0 -- PREVIEW_TALK_SECONDS 
      , 0 -- INTERNAL_SECONDS 
      , 0 -- EXTERNAL_SECONDS 
      , 0 -- ACTUAL_OVERTIME_MINUTES 
      , 0 -- ACTUAL_SHIFT_MINUTES 
      , 0 -- NOT_READY_SECONDS 
      , 0 -- TALK_RESERVE_SECONDS 
      , 0 -- INTERNAL_CALLS_COUNT 
      , 0 -- LOGIN_SECONDS 
      , 0 -- RING_SECONDS 
      , 0 -- HOLD_SECONDS 
      , 0 -- BUSYONDNTIME 
      , 0 -- WRAP_SECONDS 
      , 0 -- IDLE_SECONDS 
      , 0 -- PREVIEW_CALLS_COUNT 
      , 0 -- CONSULTATION_TIME 
      , 0 -- PREDICTIVE_CALLS_COUNT 
      , NULL -- LAST_LOGOUT 
      , 0 -- PREDICTIVE_TALK_SECONDS 
      , 0 -- TALK_SECONDS 
      , 0 -- BREAK_TIME 
      , 0 -- SCHEDULED_SHIFT_MINUTES 
      , 0 -- HANDLE_CALLS_COUNT 
      , 0 -- HANDLE_TIME_SECONDS 
      , NULL -- FIRST_LOGIN 
      , 0 -- WALKAWAY_TIME 
      , 0 -- EXTERNAL_CALLS_COUNT
    )
;


ROLLBACK;  





