<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>st_call_details</name>
    <description/>
    <extended_description/>
    <trans_version/>
    <trans_status>0</trans_status>
    <directory>&#47;</directory>
    <log>
      <read/>
      <write/>
      <input/>
      <output/>
      <update/>
      <rejected/>
      <connection/>
      <table/>
      <step_performance_table/>
      <use_batchid>Y</use_batchid>
      <use_logfield>N</use_logfield>
    </log>
    <maxdate>
      <connection/>
      <table/>
      <field/>
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file/>
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
  <modified_user>-</modified_user>
  <modified_date>2012&#47;06&#47;19 14:05:41.455</modified_date>
  </info>
  <notepads>
  </notepads>
  <connection>
    <name>esrepo</name>
    <server>&#47;&#47;10.235.130.18</server>
    <type>ORACLE</type>
    <access>Native</access>
    <database>&#47;mxrepo1_discoverer</database>
    <port>1521</port>
    <username>ESREPO</username>
    <password>Encrypted 2be98afc86aa7f2e49b2bff43ecc39f89</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute><code>FORCE_IDENTIFIERS_TO_LOWERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_UPPERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>IS_CLUSTERED</code><attribute>N</attribute></attribute>
      <attribute><code>PORT_NUMBER</code><attribute>1521</attribute></attribute>
      <attribute><code>QUOTE_ALL_FIELDS</code><attribute>N</attribute></attribute>
      <attribute><code>SUPPORTS_BOOLEAN_DATA_TYPE</code><attribute>N</attribute></attribute>
      <attribute><code>USE_POOLING</code><attribute>N</attribute></attribute>
    </attributes>
  </connection>
  <connection>
    <name>esrepo2</name>
    <server>&#47;&#47;165.184.34.72</server>
    <type>ORACLE</type>
    <access>Native</access>
    <database>&#47;maxeierd_discoverer</database>
    <port>1531</port>
    <username>ESREPO</username>
    <password>Encrypted 2be98afc86aa7f2e49b2bff43ecc39f89</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute><code>FORCE_IDENTIFIERS_TO_LOWERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_UPPERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>IS_CLUSTERED</code><attribute>N</attribute></attribute>
      <attribute><code>PORT_NUMBER</code><attribute>1531</attribute></attribute>
      <attribute><code>QUOTE_ALL_FIELDS</code><attribute>N</attribute></attribute>
      <attribute><code>SUPPORTS_BOOLEAN_DATA_TYPE</code><attribute>N</attribute></attribute>
      <attribute><code>USE_POOLING</code><attribute>N</attribute></attribute>
    </attributes>
  </connection>
  <connection>
    <name>esrepo3</name>
    <server>&#47;&#47;10.235.130.18</server>
    <type>ORACLE</type>
    <access>Native</access>
    <database>&#47;mxrepo1_discoverer</database>
    <port>1521</port>
    <username>ESREPO</username>
    <password>Encrypted 2be98afc86aa7f2e49b2bff43ecc39f89</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute><code>FORCE_IDENTIFIERS_TO_LOWERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_UPPERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>IS_CLUSTERED</code><attribute>N</attribute></attribute>
      <attribute><code>PORT_NUMBER</code><attribute>1521</attribute></attribute>
      <attribute><code>QUOTE_ALL_FIELDS</code><attribute>N</attribute></attribute>
      <attribute><code>SUPPORTS_BOOLEAN_DATA_TYPE</code><attribute>N</attribute></attribute>
      <attribute><code>USE_POOLING</code><attribute>N</attribute></attribute>
    </attributes>
  </connection>
  <connection>
    <name>esrepo4</name>
    <server>&#47;&#47;10.235.130.18</server>
    <type>ORACLE</type>
    <access>Native</access>
    <database>&#47;mxrepo1_discoverer</database>
    <port>1521</port>
    <username>ESREPO</username>
    <password>Encrypted 2be98afc86aa7f2e49b2bff43ecc39f89</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute><code>FORCE_IDENTIFIERS_TO_LOWERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_UPPERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>IS_CLUSTERED</code><attribute>N</attribute></attribute>
      <attribute><code>PORT_NUMBER</code><attribute>1521</attribute></attribute>
      <attribute><code>QUOTE_ALL_FIELDS</code><attribute>N</attribute></attribute>
      <attribute><code>SUPPORTS_BOOLEAN_DATA_TYPE</code><attribute>N</attribute></attribute>
      <attribute><code>USE_POOLING</code><attribute>N</attribute></attribute>
    </attributes>
  </connection>
  <connection>
    <name>HDS</name>
    <server/>
    <type>MSSQL</type>
    <access>ODBC</access>
    <database>awdb</database>
    <port>1521</port>
    <username>WFM</username>
    <password>Encrypted 2be98afc86aa7f2b3ae1bb879db85ff8b</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute><code>FORCE_IDENTIFIERS_TO_LOWERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_UPPERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>IS_CLUSTERED</code><attribute>N</attribute></attribute>
      <attribute><code>PORT_NUMBER</code><attribute>1521</attribute></attribute>
      <attribute><code>QUOTE_ALL_FIELDS</code><attribute>N</attribute></attribute>
      <attribute><code>SUPPORTS_BOOLEAN_DATA_TYPE</code><attribute>N</attribute></attribute>
      <attribute><code>USE_POOLING</code><attribute>N</attribute></attribute>
    </attributes>
  </connection>
  <order>
  <hop> <from>Date Dimension from ESREPO</from><to>Merge Join</to><enabled>Y</enabled> </hop>  <hop> <from>Merge Join</from><to>Select values</to><enabled>Y</enabled> </hop>  <hop> <from>Merge Join 2</from><to>Sort rows 2</to><enabled>Y</enabled> </hop>  <hop> <from>Region Dimension from ESREPO 2</from><to>Merge Join 2</to><enabled>Y</enabled> </hop>  <hop> <from>Select values</from><to>Sort rows</to><enabled>Y</enabled> </hop>  <hop> <from>Select values 2</from><to>Table output</to><enabled>Y</enabled> </hop>  <hop> <from>Sort rows</from><to>Merge Join 2</to><enabled>Y</enabled> </hop>  <hop> <from>Table input</from><to>Merge Join</to><enabled>Y</enabled> </hop>  <hop> <from>Sort rows 2</from><to>Add sequence</to><enabled>Y</enabled> </hop>  <hop> <from>Add sequence</from><to>Select values 2</to><enabled>Y</enabled> </hop>  </order>
  <step>
    <name>Add sequence</name>
    <type>Sequence</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
      <valuename>st_cal_dtls_id</valuename>
      <use_database>Y</use_database>
      <connection>esrepo</connection>
      <schema>esrepo</schema>
      <seqname>seq_st_cal_dtls</seqname>
      <use_counter>N</use_counter>
      <counter_name/>
      <start_at>1</start_at>
      <increment_by>1</increment_by>
      <max_value>999999999</max_value>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>991</xloc>
      <yloc>283</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Date Dimension from ESREPO</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <connection>esrepo</connection>
    <sql>SELECT DIM_DATE_ID, DIM_DATE FROM DM_DATE_DIMENSION 
order by DIM_DATE</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>214</xloc>
      <yloc>394</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Merge Join</name>
    <type>MergeJoin</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
<join_type>INNER</join_type>
<step1>Table input</step1>
<step2>Date Dimension from ESREPO</step2>
    <keys_1>
      <key>Call_Date</key>
    </keys_1>
    <keys_2>
      <key>DIM_DATE</key>
    </keys_2>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>418</xloc>
      <yloc>254</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Merge Join 2</name>
    <type>MergeJoin</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
<join_type>LEFT OUTER</join_type>
<step1>Sort rows</step1>
<step2>Region Dimension from ESREPO 2</step2>
    <keys_1>
      <key>Area_Code</key>
    </keys_1>
    <keys_2>
      <key>Area_Code</key>
    </keys_2>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>778</xloc>
      <yloc>247</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Region Dimension from ESREPO 2</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <connection>esrepo</connection>
    <sql>SELECT AREA_CODE,REGION_ID FROM DM_CC_REGIONS_DIM
order by AREA_CODE
</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>Y</lazy_conversion_active>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>673</xloc>
      <yloc>369</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Select values</name>
    <type>SelectValues</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <fields>      <field>        <name>Variable5</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Phone_Number</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Area_Code</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Call_Type_Id</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Language_Id</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>ASA</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Hold_Time</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Work_Time</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Talk_Time</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Variable3</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>RecoveryKey</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>DIM_DATE_ID</name>
        <rename>Call_Date_ID</rename>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>load_date</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Call_Date_Time</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Digits_Dialed</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Agent_ID</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>RouterCallKey</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>RouterCallKeySequenceNumber</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Ring_Time</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>        <select_unspecified>N</select_unspecified>
    </fields>     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>556</xloc>
      <yloc>257</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Select values 2</name>
    <type>SelectValues</type>
    <description/>
    <distribute>N</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <fields>      <field>        <name>Variable5</name>
        <rename>VARIABLE5</rename>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Phone_Number</name>
        <rename>PHONE_NUMBER</rename>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Call_Type_Id</name>
        <rename>CALL_TYPE_ID</rename>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Language_Id</name>
        <rename>LANGUAGE_ID</rename>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>ASA</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Hold_Time</name>
        <rename>HOLD_TIME</rename>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Work_Time</name>
        <rename>WORK_TIME</rename>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Talk_Time</name>
        <rename>TALK_TIME</rename>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Variable3</name>
        <rename>VARIABLE3</rename>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>RecoveryKey</name>
        <rename>RECOVERYKEY</rename>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>load_date</name>
        <rename>LOAD_DATE</rename>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>REGION_ID</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Call_Date_ID</name>
        <rename>CALL_DATE_ID</rename>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Call_Date_Time</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Digits_Dialed</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Agent_ID</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>RouterCallKey</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>st_cal_dtls_id</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>RouterCallKeySequenceNumber</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>      <field>        <name>Ring_Time</name>
        <rename/>
        <length>-2</length>
        <precision>-2</precision>
      </field>        <select_unspecified>N</select_unspecified>
    </fields>     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>1074</xloc>
      <yloc>245</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Sort rows</name>
    <type>SortRows</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
      <directory>%%java.io.tmpdir%%</directory>
      <prefix>out</prefix>
      <sort_size/>
      <free_memory>25</free_memory>
      <compress>N</compress>
      <compress_variable/>
      <unique_rows>N</unique_rows>
    <fields>
      <field>
        <name>Area_Code</name>
        <ascending>Y</ascending>
        <case_sensitive>N</case_sensitive>
      </field>
    </fields>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>671</xloc>
      <yloc>259</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Sort rows 2</name>
    <type>SortRows</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
      <directory>%%java.io.tmpdir%%</directory>
      <prefix>out</prefix>
      <sort_size/>
      <free_memory>25</free_memory>
      <compress>N</compress>
      <compress_variable/>
      <unique_rows>N</unique_rows>
    <fields>
      <field>
        <name>Call_Date_ID</name>
        <ascending>Y</ascending>
        <case_sensitive>N</case_sensitive>
      </field>
      <field>
        <name>RecoveryKey</name>
        <ascending>Y</ascending>
        <case_sensitive>N</case_sensitive>
      </field>
    </fields>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>876</xloc>
      <yloc>248</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Table input</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <connection>HDS</connection>
    <sql>(
	select distinct(a.Variable5), min(b.RouterCallKeySequenceNumber) as RouterCallKeySequenceNumber,
	min(a.ASA) over (partition by a.Variable5) as ASA, 
	a.Variable3,a.Talk_Time,a.load_date, 
	CONVERT(varchar(10),a.Call_Date,101)  Call_Date , a.Call_Date_Time, a.Digits_Dialed, a.Phone_Number,
	a.Area_Code, a.Call_Type_Id, a.Language_Id, a.Hold_Time, a.Work_Time, a.Ring_Time,
	a.RecoveryKey, 
	a.RouterCallKey, 
	a.Agent_ID  
from		(
			select distinct getdate() as load_date, 
			DATEADD(dd, 0, DATEDIFF(dd, 0, tcd.DateTime))  as Call_Date,
			tcd.DateTime as Call_Date_Time,
			--tcd.Variable5,
			ISNULL(NULLIF(tcd.Variable5, &apos;&apos;), &apos;x&apos;) Variable5,	
			tcd.DigitsDialed as Digits_Dialed,
			tcd.ANI as Phone_Number,
			case len(tcd.ANI)
			when 10 then substring(tcd.ANI,1,3)
			else &apos;0&apos;
			end as Area_Code,
			tcd.CallTypeID as Call_Type_Id,
			CASE
			WHEN tcd.CallTypeID in (&apos;5088&apos;,&apos;5500&apos;)  THEN 101
			WHEN tcd.CallTypeID in (&apos;5091&apos;,&apos;5501&apos;)  THEN 102
			ELSE -1
			END AS Language_Id,
			(DATEDIFF(s,rcd.BeganRoutingDateTime, rcd.BeganCallTypeDateTime)+ tcd.NetQTime)  as ASA,
			HoldTime as Hold_Time,
			tcd.WorkTime as Work_Time,
			tcd.TalkTime as Talk_Time,
			tcd.RingTime as Ring_Time,
			tcd.Variable3,
			tcd.RecoveryKey,
			tcd.AgentPeripheralNumber as Agent_ID,
			tcd.RouterCallKeySequenceNumber,
			tcd.RouterCallKey
			from 
			Route_Call_Detail rcd,
			Termination_Call_Detail tcd 
			Where rcd.Variable5 = tcd.Variable5
			and tcd.CallTypeID IN (&apos;5088&apos;,&apos;5091&apos;,&apos;5500&apos;,&apos;5501&apos;)
			and tcd.TalkTime &lt;&gt; &apos;0&apos;
			and tcd.RouterCallKeySequenceNumber = 1
			and (rcd.RouterErrorCode &lt;&gt; 448 and rcd.Label is not null)
			and rcd.RouterErrorCode &lt;&gt; 63
			and CONVERT(varchar(10),tcd.DateTime,112)= CONVERT(varchar(10),getdate()-1,112)
			and  year(rcd.DateTime)=year(tcd.DateTime)
			and  month(rcd.DateTime)=month(tcd.DateTime)
			and day(rcd.DateTime)=day(tcd.DateTime)
			--and tcd.Variable5 is not null 
			) a,

			(
			select 
			ISNULL(NULLIF(tcd.Variable5, &apos;&apos;), &apos;y&apos;) Variable5,	
			--distinct(tcd.Variable5) as Variable5, 
			min(tcd.RouterCallKeySequenceNumber) as RouterCallKeySequenceNumber
			from Route_Call_Detail rcd,
			Termination_Call_Detail tcd 
			Where rcd.Variable5 = tcd.Variable5
			and tcd.CallTypeID IN (&apos;5088&apos;,&apos;5091&apos;,&apos;5500&apos;,&apos;5501&apos;)
			and (rcd.RouterErrorCode &lt;&gt; 448 and rcd.Label is not null)
			and rcd.RouterErrorCode &lt;&gt; 63
			--and tcd.Variable5 is not null 
			and CONVERT(varchar(10),rcd.DateTime,112)= CONVERT(varchar(10),getdate()-1,112)
			group by tcd.Variable5
			) b
				where a.Variable5 = b.Variable5
				and a.RouterCallKeySequenceNumber = b.RouterCallKeySequenceNumber
				--and a.Variable5 is not null 
				group by a.Variable5, b.RouterCallKeySequenceNumber, a.ASA, a.load_date, a.Call_Date, a.Call_Date_Time, a.Digits_Dialed, a.Phone_Number,
				a.Area_Code, a.Call_Type_Id, a.Language_Id, a.Hold_Time, a.Work_Time, a.Talk_Time, a.Ring_Time,
				a.Variable3, a.RecoveryKey, a.RouterCallKey,--a.RouterCallKeyDay,  
				a.Agent_ID
)
 union

(
	select distinct(a.Variable5), a.RouterCallKeySequenceNumber,
	min(a.ASA) over (partition by a.Variable5) as ASA, 
	--min(ASA) as ASA, 
	a.Variable3,a.Talk_Time,a.load_date, a.Call_Date, a.Call_Date_Time, a.Digits_Dialed, a.Phone_Number,
	a.Area_Code, a.Call_Type_Id, a.Language_Id, a.Hold_Time, a.Work_Time, a.Ring_Time,
	a.RecoveryKey, a.RouterCallKey, a.Agent_ID  
from 
	(
			select distinct getdate() as load_date, 
			DATEADD(dd, 0, DATEDIFF(dd, 0, tcd.DateTime))  as Call_Date,
			tcd.DateTime as Call_Date_Time,
			--tcd.Variable5,
			ISNULL(NULLIF(tcd.Variable5, &apos;&apos;), &apos;a&apos;) Variable5,	
			tcd.DigitsDialed as Digits_Dialed,
			tcd.ANI as Phone_Number,
			case len(tcd.ANI)
			when 10 then substring(tcd.ANI,1,3)
			else &apos;0&apos;
			end as Area_Code,
			tcd.CallTypeID as Call_Type_Id,
			CASE
			WHEN tcd.CallTypeID in (&apos;5638&apos;,&apos;5527&apos;,&apos;6707&apos;,&apos;6713&apos;,&apos;5087&apos;,&apos;6573&apos;)  THEN 101  --&apos;6707&apos;,&apos;6713&apos;,&apos;5087&apos;,&apos;5090&apos;,&apos;6710&apos;,&apos;6716&apos; are the new call types added as of 5-1-2012
			WHEN tcd.CallTypeID in (&apos;5639&apos;,&apos;5528&apos;,&apos;5090&apos;,&apos;6710&apos;,&apos;6716&apos;,&apos;6574&apos;)  THEN 102
			ELSE -1
			END AS Language_Id,
			(DATEDIFF(s,rcd.BeganRoutingDateTime, rcd.BeganCallTypeDateTime)+ tcd.NetQTime)  as ASA,
			HoldTime as Hold_Time,
			tcd.WorkTime as Work_Time,
			tcd.TalkTime as Talk_Time,
			tcd.RingTime as Ring_Time,
			tcd.Variable3,
			tcd.RecoveryKey,
			tcd.RouterCallKey,
			tcd.AgentPeripheralNumber as Agent_ID,
			tcd.RouterCallKeySequenceNumber
			from Route_Call_Detail rcd,
			Termination_Call_Detail tcd 
			Where rcd.Variable5 = tcd.Variable5
			and tcd.CallTypeID IN (&apos;5638&apos;,&apos;5639&apos;,&apos;5527&apos;,&apos;5528&apos;,&apos;6707&apos;,&apos;6713&apos;,&apos;5087&apos;,&apos;5090&apos;,&apos;6710&apos;,&apos;6716&apos;,&apos;6573&apos;,&apos;6574&apos;)
			and tcd.TalkTime &lt;&gt; &apos;0&apos;
			and tcd.AgentPeripheralNumber is not null
			and CONVERT(varchar(10),tcd.DateTime,112)= CONVERT(varchar(10),getdate()-1,112)
			and  year(rcd.DateTime)=year(tcd.DateTime)
			and  month(rcd.DateTime)=month(tcd.DateTime)
			and day(rcd.DateTime)=day(tcd.DateTime)
	) as a
				where a.Variable5 &lt;&gt; &apos;a&apos;
				group by a.Variable5, a.RouterCallKeySequenceNumber,
				a.ASA, 
				a.Variable3,a.Talk_Time,a.load_date, a.Call_Date, a.Call_Date_Time, a.Digits_Dialed, a.Phone_Number,
				a.Area_Code, a.Call_Type_Id, a.Language_Id, a.Hold_Time, a.Work_Time, a.Ring_Time,
				a.RecoveryKey, a.RouterCallKey, a.Agent_ID 
)
</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>Y</lazy_conversion_active>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>210</xloc>
      <yloc>178</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Table output</name>
    <type>TableOutput</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <connection>esrepo4</connection>
    <schema>ESREPO</schema>
    <table>st_call_details</table>
    <commit>1000</commit>
    <truncate>N</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field/>
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field/>
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field/>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>1151</xloc>
      <yloc>247</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step_error_handling>
  </step_error_handling>
   <slave-step-copy-partition-distribution>
</slave-step-copy-partition-distribution>
   <slave_transformation>N</slave_transformation>
</transformation>
