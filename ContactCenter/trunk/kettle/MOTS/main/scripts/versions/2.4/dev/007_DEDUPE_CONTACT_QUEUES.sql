--Disable Constraint for duration of cleanup script
ALTER TABLE CC_D_CONTACT_QUEUE
DISABLE CONSTRAINT CC_D_CONTACT_QUEUE__UN;


--Set duplicate records to an invalid effective date
MERGE INTO CC_D_CONTACT_QUEUE a
using ( SELECT * 
	FROM 
	(SELECT
		D_CONTACT_QUEUE_ID
	  , QUEUE_NUMBER
	  , VERSION
	  , RECORD_EFF_DT
	  , RECORD_END_DT
	  , LEAD (RECORD_EFF_DT , 1, NULL) OVER (PARTITION BY QUEUE_NUMBER ORDER BY QUEUE_NUMBER, VERSION, RECORD_EFF_DT, RECORD_END_DT) as NEXT_EFF_DT
	  FROM CC_D_CONTACT_QUEUE a
	  ORDER BY QUEUE_NUMBER, VERSION, RECORD_EFF_DT, RECORD_END_DT
	  )sub 
	WHERE RECORD_END_DT > NEXT_EFF_DT
	ORDER BY QUEUE_NUMBER, VERSION, RECORD_EFF_DT, RECORD_END_DT
) b
ON (a.D_CONTACT_QUEUE_ID = b.D_CONTACT_QUEUE_ID)
WHEN matched THEN UPDATE SET a.RECORD_EFF_DT = TO_DATE('2999-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS');


--Update valid records to cover any gaps created by duplicate records
MERGE INTO CC_D_CONTACT_QUEUE a
using ( SELECT * 
	FROM 
	(SELECT
		D_CONTACT_QUEUE_ID
	  , QUEUE_NUMBER
	  , VERSION
	  , RECORD_EFF_DT
	  , RECORD_END_DT
	  , LEAD (RECORD_EFF_DT , 1, NULL) OVER (PARTITION BY QUEUE_NUMBER ORDER BY QUEUE_NUMBER, VERSION, RECORD_EFF_DT, RECORD_END_DT) as NEXT_EFF_DT
	  FROM CC_D_CONTACT_QUEUE a
	  ORDER BY QUEUE_NUMBER, VERSION, RECORD_EFF_DT, RECORD_END_DT
	  )sub 
	WHERE RECORD_END_DT < NEXT_EFF_DT
    AND NEXT_EFF_DT != TO_DATE('2999-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS')
	ORDER BY QUEUE_NUMBER, VERSION, RECORD_EFF_DT, RECORD_END_DT
) b
ON (a.D_CONTACT_QUEUE_ID = b.D_CONTACT_QUEUE_ID)
WHEN matched THEN UPDATE SET a.RECORD_END_DT = b.NEXT_EFF_DT;


--Update Fact Tables records to valid D_CONTACT_QUEUE record
MERGE INTO CC_F_ACTUALS_QUEUE_INTERVAL a
using (
  SELECT abd.F_CALL_CENTER_ACTLS_INTRVL_ID
      ,  d.D_DATE
      ,  a.QUEUE_NUMBER
  FROM CC_F_ACTUALS_QUEUE_INTERVAL abd
  INNER JOIN CC_D_DATES d on abd.D_DATE_ID = d.D_DATE_ID
  INNER JOIN CC_D_CONTACT_QUEUE a on abd.D_CONTACT_QUEUE_ID = a.D_CONTACT_QUEUE_ID
  WHERE abd.D_CONTACT_QUEUE_ID IN (
    SELECT sub.D_CONTACT_QUEUE_ID
    FROM CC_D_CONTACT_QUEUE sub
    WHERE sub.RECORD_EFF_DT = TO_DATE('2999-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS'))
) b
ON (a.F_CALL_CENTER_ACTLS_INTRVL_ID = b.F_CALL_CENTER_ACTLS_INTRVL_ID)
WHEN matched THEN UPDATE SET a.D_CONTACT_QUEUE_ID = (SELECT sub2.D_CONTACT_QUEUE_ID from CC_D_CONTACT_QUEUE sub2 WHERE (b.D_DATE BETWEEN sub2.RECORD_EFF_DT AND sub2.RECORD_END_DT) AND (sub2.QUEUE_NUMBER = b.QUEUE_NUMBER));


--Delete duplicate CONTACT_QUEUE records
DELETE FROM CC_D_CONTACT_QUEUE a 
WHERE a.RECORD_EFF_DT = TO_DATE('2999-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS');

--Re-Enable Unique Constraint
ALTER TABLE CC_D_CONTACT_QUEUE
ENABLE CONSTRAINT CC_D_CONTACT_QUEUE__UN;

INSERT INTO CC_L_PATCH_LOG ( PATCH_VERSION , SCRIPT_SEQUENCE , SCRIPT_NAME)
VALUES ('2.4','007','007_DEDUPE_CONTACT_QUEUES');

COMMIT;