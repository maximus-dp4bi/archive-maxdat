<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>StateReview_init_OLAP</name>
    <description/>
    <extended_description>Do not edit these four SVN_* variable values.  They are populated when you commit code to SVN and used later to identify deployed code.

    ---------------------------------

    SVN_FILE_URL        = $URL$

    SVN_REVISION        = $Revision$

    SVN_REVISION_DATE   = $Date$

    SVN_REVISION_AUTHOR = $Author$

    ---------------------------------
    </extended_description>
    <trans_version/>
    <trans_type>Normal</trans_type>
    <trans_status>0</trans_status>
    <directory>/</directory>
    <parameters>
    </parameters>
    <log>
      <trans-log-table>
        <connection/>
        <schema/>
        <table/>
        <size_limit_lines/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject/>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject/>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject/>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject/>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection/>
        <schema/>
        <table/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection/>
      <table/>
      <field/>
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file/>
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2012/08/07 17:45:22.283</created_date>
    <modified_user>-</modified_user>
    <modified_date>2012/08/07 17:45:22.283</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
  </notepads>
  <connection>
    <name>MAXDAT</name>
    <server>${DB_MAXDAT_HOSTNAME_IL}</server>
    <type>ORACLE</type>
    <access>Native</access>
    <database>${DB_MAXDAT_NAME_IL}</database>
    <port>${DB_MAXDAT_PORT_IL}</port>
    <username>${DB_MAXDAT_USER_IL}</username>
    <password>Encrypted 2be98afc86aa7f2aebe15b7318cc2fe83</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>INITIAL_POOL_SIZE</code>
        <attribute>5</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>MAXIMUM_POOL_SIZE</code>
        <attribute>10</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>${DB_MAXDAT_PORT_IL}</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STRICT_NUMBER_38_INTERPRETATION</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>Y</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>OLTP_SOURCE</name>
    <server>${DB_OLTP_HOSTNAME_IL}</server>
    <type>ORACLE</type>
    <access>Native</access>
    <database>${DB_OLTP_NAME_IL}</database>
    <port>${DB_OLTP_PORT_IL}</port>
    <username>${DB_OLTP_USER_IL}</username>
    <password>${DB_OLTP_PASSWORD_IL}</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>${DB_OLTP_PORT_IL}</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STRICT_NUMBER_38_INTERPRETATION</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
    <hop>
      <from>Table input - IDs for Queries</from>
      <to>Database join -- Get OLTP Data</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Database join -- Get OLTP Data</from>
      <to>Filter rows - NEW_MI_CREATION_DATE</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Filter rows - NEW_MI_CREATION_DATE</from>
      <to>Set Field - NEW_MI_CREATION_DATE</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Filter rows-NEW_MI_SATISFIED</from>
      <to>Set Field - NEW_MI_SATISFIED</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Filter rows-NEW_MI_SATISFIED</from>
      <to>Dummy (do nothing)</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Set Field - NEW_MI_SATISFIED</from>
      <to>Dummy (do nothing)</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Dummy (do nothing)</from>
      <to>Update STG -- OLTP Data only</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Filter rows - NEW_MI_CREATION_DATE</from>
      <to>Filter rows-NEW_MI_SATISFIED</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Set Field - NEW_MI_CREATION_DATE</from>
      <to>Filter rows-NEW_MI_SATISFIED</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Update STG -- OLTP Data only</from>
      <to>Text file output - OLTP Errors</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <step>
    <name>Database join -- Get OLTP Data</name>
    <type>DBJoin</type>
    <description/>
    <distribute>N</distribute>
    <custom_distribution/>
    <copies>2</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>OLTP_SOURCE</connection>
    <rowlimit>0</rowlimit>
    <sql>select A.*,
       (case when oltp_New_MI_Creation_Date is not null then 'Y' else 'N' end) as oltp_New_MI_flag,
       (case when oltp_New_MI_Satisfied_Date is not null then 'Y' else 'N' end) as oltp_New_MI_Satisfied,
       (case when oltp_New_MI_Creation_Date is not null
             --and oltp_New_MI_Satisfied = 'N'
             and oltp_New_MI_Satisfied_date is null
             and not exists (select 1
                                from app_individual ap_ind,
                                  	 client cl
                                  where ap_ind.CLIENT_ID = cl.CLNT_CLIENT_ID
                                  and ap_ind.application_id = oltp_Application_ID
                                  and cl.do_not_call_ind = 1)	 	 
             then 'Y' 
             else 'N' 
        end) as oltp_CALL_CAMPAIGN_FLAG,
       (select event_id
          from event e1
          where e1.ref_type = 'APP_HEADER'
          and e1.ref_id = oltp_Application_ID
          and e1.event_id = (select min(e2.event_id) 
                              from event e2
                             where e2.ref_id = oltp_Application_ID
                               and e2.ref_type = 'APP_HEADER'
                               and e2.event_type_cd in ('OB_DIALER_MISSING_DATA', 'OB_DIALER_MISSING_DOC')
                               and e2.create_ts >= oltp_New_MI_Creation_Date
                               )
           ) as oltp_CALL_CAMPAIGN_ID
from  (
  select    
          to_char(sysdate,'yyyy/MM/dd HH24:mm:ss') as Capture_Date_string,
          sysdate as oltp_STRW_CAPTURE_DATE,                       
		      'STATE_REVIEW_CAPTURE_DATE' as Update_Field,
          appH.Application_ID as oltp_Application_ID,
		      si.step_instance_id as oltp_StRw_Task_ID,
          --appH.Renewal_Due_Date as oltp_Approval_Date,
          case when not exists (select 1 
                                  from app_missing_info
                                 where satisfied_date is null
                                   and application_id = appH.Application_Id) 
               then 'Y' else 'N' end as oltp_ALL_MI_SATISFIED,         
          /*
           Find out the earliest MI created that is still outstanding after the State Review task completion and before Data Correction 
           task completion (if a Data Correction task exists and NO research task exists) or before Research task completion (if a 
           Research tasks exists).
          */
          ( select min(mi.create_ts) 
             from app_missing_info mi
            where mi.application_id = appH.Application_Id
              and mi.create_ts >= ?--&amp;p_StRw_task_create_date --State Review task completion date.
              AND (
                    (? is not null and ? is not null and ? is null and mi.create_ts &lt;= ?)
                    OR
                    (? is not null and ? is not null and mi.create_ts &lt;= ?)
                    OR
                    (? is not null and ? is null and ? is null and mi.create_ts &lt;= ?)
                   )
            ) as oltp_New_MI_Creation_Date,
           /*
            Get the most recent date when the New MIs only (NOT the older MIs) is satisfied; and NO OTHER New MI should be Outstanding.
            */   
          (select max(mi_2.satisfied_date)
             from app_missing_info mi_2
            where mi_2.application_id = appH.Application_Id   
              and mi_2.create_ts >= ? --stg.new_mi_creation_date
              and mi_2.satisfied_date is not null
              AND (
                    (? is not null and ? is not null and ? is null and mi_2.create_ts &lt;= ?)
                    OR
                    (? is not null and ? is not null and mi_2.create_ts &lt;= ?)
                    OR
                    (? is not null and ? is null and ? is null and mi_2.create_ts &lt;= ?)
                   )
               and not exists (select 1
                                 from app_missing_info mi
                                where mi.application_id = appH.Application_Id
                                  and mi.create_ts >= ? --stg.new_mi_creation_date                                   
                                  and mi.satisfied_date is null
                                  AND (
                                        (? is not null and ? is not null and ? is null and mi.create_ts &lt;= ?)
                                        OR
                                        (? is not null and ? is not null and mi.create_ts &lt;= ?)
                                        OR
                                        (? is not null and ? is null and ? is null and mi.create_ts &lt;= ?)
                                      )
                                   ) 
            ) as  oltp_New_MI_Satisfied_date,          
        (Select distinct first_value(AAS.Report_label) over (partition by HCC.application_id order by last_access_dt desc) 
           From hrt_case_control HCC, 
                enum_app_agency_app_status AAS 
           where HCC.current_status_cd = AAS.value 
             and HCC.application_id = appH.Application_Id) as oltp_Heart_App_Status,
        (CASE appH.STATUS_CD 
              WHEN  'RENEWAL_INITIATED' THEN 'Renewal Initiated'
              WHEN  'RECEIVED' THEN 'Received'
              WHEN  'DISREGARDED'  THEN 'Cancelled'
		          WHEN  'VOID'  THEN 'Cancelled'
              WHEN  'COMPLETED' THEN 'Done' 
              WHEN  'TIMEOUT' THEN 'Done' 
              WHEN  'INPROCESS' THEN 
                                     (CASE (select Distinct 'MI' 
                                      from app_Tracker t 
					                           where t.application_id = appH.Application_Id
                                     and History_Ind = 0 and RFE_STATUS_CD = 'AWAITING_MI')
                                     WHEN 'MI' Then 'Awaiting Missing Information' 
                                     ELSE 'In Process' End )
              ELSE appH.STATUS_CD 
              END) as oltp_App_Status_Group,
         appH.Status_Date as oltp_app_status_date,                 
        (select distinct first_value(RFE_STATUS_CD) over (partition by t.application_id order by app_tracker_id desc)
           from App_Tracker t
          where t.Application_ID = appH.Application_ID 
            and t.history_ind =0) as oltp_RFE_STATUS, -- RFE Status.
		case when app_form_cd='FPBP' then 'Y' else 'N' end as oltp_FPBP_FLAG,
        case when (appH.Status_Cd = 'DISREGARDED' or appH.Status_Cd = 'TIMEOUT') 
             then appH.Update_Ts else null end as oltp_CANCEL_DATE, --Cancel Date.
        case when (select count(DISTINCT RFE_STATUS_CD) 
                    from App_Tracker 
                    where Application_ID =  appH.Application_Id 
                    and HISTORY_IND = 0) > 1 then 'N' else 'Y' 
         end  oltp_RFE_Status_Flag,-- RFE Status Flag.                     
        (case when exists (SELECT 1
                            FROM Hrt_Case_Control HrtCC 
                           WHERE  HrtCC.Application_Id = appH.Application_Id
                             and qc_ind  = 'Y' )
             then 'Y' else 'N' end) as oltp_state_acpt_Ind, --State Acceptance Indicator.
         (case   
            when exists (select 1 
                            from app_tracker t,
                                 app_individual AI
                           where t.application_id = appH.Application_Id
                             and AI.Application_Id = appH.Application_Id
                             and AI.APP_INDIVIDUAL_ID = t.APP_INDIVIDUAL_ID
                             and t.RFE_STATUS_CD = 'ACCEPTED'                             
                             and AI.applicant_ind = 1--Applying Clients only.
                             and t.status_date >= ?--&amp;p_strw_complete_date
                             and not exists (select 1 
                                              from app_tracker t_2,
                                                   app_individual AI_2  
                                             where t_2.application_id = appH.Application_Id
                                              and AI_2.Application_Id = appH.Application_Id
                                              and AI_2.APP_INDIVIDUAL_ID = t_2.APP_INDIVIDUAL_ID                                              
                                              and t_2.RFE_STATUS_CD &lt;&gt; 'ACCEPTED'
                                              and AI_2.applicant_ind = 1
                                              and t_2.status_date >= ?--&amp;p_strw_complete_date
                                              and t.status_date = t_2.status_date 
                                              )
                              and t.status_date = (select min(t_3.status_date)
                                                    from app_tracker t_3
                                                   where t_3.application_id = appH.Application_Id                                              
                                                     and AI.APP_INDIVIDUAL_ID = t_3.APP_INDIVIDUAL_ID
                                                     and t_3.status_date >= ?--&amp;p_strw_complete_date
                                                     )
                                                                       
                          ) then 'ACCEPTED'
            when exists (select 1 
                            from app_tracker t,
                                 app_individual AI
                           where t.application_id = appH.Application_Id
                             and AI.Application_Id = appH.Application_Id
                             and AI.APP_INDIVIDUAL_ID = t.APP_INDIVIDUAL_ID
                             and t.RFE_STATUS_CD in ('AWAITING_DATA_CORRECTION')
                             --and t.created_by &lt;&gt; '-800'                             
                             and AI.applicant_ind = 1 --Applying Clients only.
                             and t.status_date >= ?--&amp;p_strw_complete_date
                             and not exists (select 1 
                                              from app_tracker t_2,
                                                   app_individual AI_2  
                                             where t_2.application_id = appH.Application_Id
                                              and AI_2.Application_Id = appH.Application_Id
                                              and AI_2.APP_INDIVIDUAL_ID = t_2.APP_INDIVIDUAL_ID                      
                                              and t_2.RFE_STATUS_CD not in ('AWAITING_DATA_CORRECTION')                                              
                                              and AI_2.applicant_ind = 1
                                              and t_2.status_date >= ?--&amp;p_strw_complete_date
                                              and t.status_date = t_2.status_date
                                              )
                              and t.status_date = (select min(t_3.status_date)
                                                    from app_tracker t_3
                                                   where t_3.application_id = appH.Application_Id                                                    
                                                     and AI.APP_INDIVIDUAL_ID = t_3.APP_INDIVIDUAL_ID
                                                     and t_3.status_date >= ?--&amp;p_strw_complete_date
                                                     )                 
                           ) then 'REJECTED'
            when (select count(DISTINCT t.RFE_STATUS_CD)
                    from App_Tracker t,
                         app_individual AI
                     where t.application_id = appH.Application_Id
                       and AI.Application_Id = appH.Application_Id
                       and AI.APP_INDIVIDUAL_ID = t.APP_INDIVIDUAL_ID                       
                       and AI.applicant_ind = 1 --Applying Clients only.
                       and t.status_date = (select min(t_3.status_date)
                                              from app_tracker t_3
                                             where t_3.application_id = appH.Application_Id
                                               and AI.APP_INDIVIDUAL_ID = t_3.APP_INDIVIDUAL_ID                                                    
                                               and t_3.status_date >= ?--&amp;p_strw_complete_date
                                               )
                     ) > 1 then 'BOTH'                                
             else null
             end) as oltp_State_Review_Outcome
from App_Header appH
join step_instance si on si.ref_id = appH.Application_Id
                     and appH.Application_Id = ?
                    --and appH.Application_Id = &amp;p_app_id
                     and si.step_instance_id = ?
                    --and si.step_instance_id = &amp;p_task_id
where 1=1
) A
where 1=1</sql>
    <outer_join>N</outer_join>
    <replace_vars>Y</replace_vars>
    <parameter>
      <field>
        <name>STG_ASSD_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_PROCESS_DC</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_DC_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_RESEARCH_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_ASED_PROCESS_DC</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_RESEARCH</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_RESEARCH_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_ASED_RESEARCH</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_DC_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_RESEARCH_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_ASED_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_NEW_MI_CREATION_DATE</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_PROCESS_DC</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_DC_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_RESEARCH_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_ASED_PROCESS_DC</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_RESEARCH</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_RESEARCH_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_ASED_RESEARCH</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_DC_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_RESEARCH_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_ASED_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_NEW_MI_CREATION_DATE</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_PROCESS_DC</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_DC_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_RESEARCH_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_ASED_PROCESS_DC</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_RESEARCH</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_RESEARCH_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_ASED_RESEARCH</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_DC_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_RESEARCH_TASK_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_ASED_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_ASED_RECEIVE_STATE_REVIEW</name>
        <type>Date</type>
      </field>
      <field>
        <name>STG_APP_ID</name>
        <type>Number</type>
      </field>
      <field>
        <name>STG_STATE_REVIEW_TASK_ID</name>
        <type>Number</type>
      </field>
    </parameter>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>85</xloc>
      <yloc>108</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Dummy (do nothing)</name>
    <type>Dummy</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>325</xloc>
      <yloc>316</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Filter rows - NEW_MI_CREATION_DATE</name>
    <type>FilterRows</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <send_true_to>Set Field - NEW_MI_CREATION_DATE</send_true_to>
    <send_false_to>Filter rows-NEW_MI_SATISFIED</send_false_to>
    <compare>
      <condition>
        <negated>N</negated>
        <leftvalue>STG_NEW_MI_CREATION_DATE</leftvalue>
        <function>IS NULL</function>
        <rightvalue/>
      </condition>
    </compare>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>325</xloc>
      <yloc>108</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Filter rows-NEW_MI_SATISFIED</name>
    <type>FilterRows</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <send_true_to>Set Field - NEW_MI_SATISFIED</send_true_to>
    <send_false_to>Dummy (do nothing)</send_false_to>
    <compare>
      <condition>
        <negated>N</negated>
        <leftvalue>STG_NEW_MI_SATISFIED</leftvalue>
        <function>=</function>
        <rightvalue>INNO</rightvalue>
      </condition>
    </compare>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>326</xloc>
      <yloc>211</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Set Field - NEW_MI_CREATION_DATE</name>
    <type>SetValueField</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <name>STG_NEW_MI_CREATION_DATE</name>
        <replaceby>OLTP_NEW_MI_CREATION_DATE</replaceby>
      </field>
      <field>
        <name>STG_NEW_MI_FLAG</name>
        <replaceby>OLTP_NEW_MI_FLAG</replaceby>
      </field>
      <field>
        <name>INUPDATE_FLG</name>
        <replaceby>INYES</replaceby>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>620</xloc>
      <yloc>108</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Set Field - NEW_MI_SATISFIED</name>
    <type>SetValueField</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <name>STG_NEW_MI_SATISFIED</name>
        <replaceby>OLTP_NEW_MI_SATISFIED</replaceby>
      </field>
      <field>
        <name>STG_NEW_MI_SATISFIED_DATE</name>
        <replaceby>OLTP_NEW_MI_SATISFIED_DATE</replaceby>
      </field>
      <field>
        <name>INUPDATE_FLG</name>
        <replaceby>INYES</replaceby>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>631</xloc>
      <yloc>211</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Table input - IDs for Queries</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>MAXDAT</connection>
    <sql>SELECT stg.nesr_id                   as stg_nesr_id,
       stg.APP_ID                    as stg_app_id, 
       stg.state_review_TASK_ID      as stg_state_review_task_id, 
       stg.assd_receive_state_review as stg_assd_receive_state_review,
       stg.ased_receive_state_review as stg_ased_receive_state_review, 
       stg.all_mi_satisfied          as stg_all_mi_satisfied,
       stg.New_MI_Creation_Date      as stg_New_MI_Creation_Date,
       stg.New_MI_flag               as stg_New_MI_flag, 
       nvl(stg.NEW_MI_Satisfied,'N') as stg_NEW_MI_Satisfied,
       stg.NEW_MI_Satisfied_date	 as stg_NEW_MI_Satisfied_date,
       stg.data_correction_task_id   as stg_DC_task_id,
       stg.ased_process_dc           as stg_ASED_Process_DC,
       stg.research_task_id          as stg_research_task_id,
       stg.ased_research             as stg_ased_research,
       null 						 as inUpdate_flg,
        'Y' 						 as inYes,
        'N'                          as inNo
FROM STATE_REVIEW_STG  stg
WHERE stg.STAGE_DONE_DATE IS NULL
--and stg.app_id = 83098
--and new_mi_flag is null ----TEMPORARY CONDITION. Comment later.
order by stg.state_review_TASK_ID
</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>85</xloc>
      <yloc>22</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Text file output - OLTP Errors</name>
    <type>TextFileOutput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <separator>;</separator>
    <enclosure>"</enclosure>
    <enclosure_forced>N</enclosure_forced>
    <enclosure_fix_disabled>N</enclosure_fix_disabled>
    <header>Y</header>
    <footer>N</footer>
    <format>DOS</format>
    <compression>None</compression>
    <encoding/>
    <endedLine/>
    <fileNameInField>N</fileNameInField>
    <fileNameField/>
    <create_parent_folder>N</create_parent_folder>
    <file>
      <name>${ETL_LOG_DIRECTORY}/StateReview_OLTP_Err</name>
      <servlet_output>N</servlet_output>
      <do_not_open_new_file_init>N</do_not_open_new_file_init>
      <extention>txt</extention>
      <append>N</append>
      <split>N</split>
      <haspartno>N</haspartno>
      <add_date>Y</add_date>
      <add_time>Y</add_time>
      <SpecifyFormat>N</SpecifyFormat>
      <date_time_format>MM/dd/yyyy HH:mm:ss</date_time_format>
      <add_to_result_filenames>Y</add_to_result_filenames>
      <pad>N</pad>
      <fast_dump>N</fast_dump>
      <splitevery>0</splitevery>
    </file>
    <fields>
      <field>
        <name>STG_APP_ID</name>
        <type>Number</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <nullif/>
        <trim_type>none</trim_type>
        <length>-1</length>
        <precision>-1</precision>
      </field>
      <field>
        <name>STG_STATE_REVIEW_TASK_ID</name>
        <type>Number</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <nullif/>
        <trim_type>none</trim_type>
        <length>-1</length>
        <precision>-1</precision>
      </field>
      <field>
        <name>errcod</name>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <nullif/>
        <trim_type>none</trim_type>
        <length>-1</length>
        <precision>-1</precision>
      </field>
      <field>
        <name>errdes</name>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <nullif/>
        <trim_type>none</trim_type>
        <length>-1</length>
        <precision>-1</precision>
      </field>
      <field>
        <name>errfld</name>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <nullif/>
        <trim_type>none</trim_type>
        <length>-1</length>
        <precision>-1</precision>
      </field>
      <field>
        <name>noferr</name>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <nullif/>
        <trim_type>none</trim_type>
        <length>-1</length>
        <precision>-1</precision>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>542</xloc>
      <yloc>417</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Update STG -- OLTP Data only</name>
    <type>Update</type>
    <description/>
    <distribute>N</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>MAXDAT</connection>
    <skip_lookup>Y</skip_lookup>
    <commit>10</commit>
    <use_batch>N</use_batch>
    <error_ignored>N</error_ignored>
    <ignore_flag_field/>
    <lookup>
      <schema>MAXDAT</schema>
      <table>STATE_REVIEW_STG</table>
      <key>
        <name>STG_NESR_ID</name>
        <field>NESR_ID</field>
        <condition>=</condition>
        <name2/>
      </key>
      <value>
        <name>PROCESS_STRW_START_TIME</name>
        <rename>OLTP_STRW_CAPTURE_DATE</rename>
      </value>
      <value>
        <name>ALL_MI_SATISFIED</name>
        <rename>OLTP_ALL_MI_SATISFIED</rename>
      </value>
      <value>
        <name>NEW_MI_CREATION_DATE</name>
        <rename>STG_NEW_MI_CREATION_DATE</rename>
      </value>
      <value>
        <name>NEW_MI_FLAG</name>
        <rename>STG_NEW_MI_FLAG</rename>
      </value>
      <value>
        <name>NEW_MI_SATISFIED</name>
        <rename>STG_NEW_MI_SATISFIED</rename>
      </value>
      <value>
        <name>NEW_MI_SATISFIED_DATE</name>
        <rename>STG_NEW_MI_SATISFIED_DATE</rename>
      </value>
      <value>
        <name>CALL_CAMPAIGN_ID</name>
        <rename>OLTP_CALL_CAMPAIGN_ID</rename>
      </value>
      <value>
        <name>CALL_CAMPAIGN_FLAG</name>
        <rename>OLTP_CALL_CAMPAIGN_FLAG</rename>
      </value>
      <value>
        <name>RFE_STATUS</name>
        <rename>OLTP_RFE_STATUS</rename>
      </value>
      <value>
        <name>FPBP_FLAG</name>
        <rename>OLTP_FPBP_FLAG</rename>
      </value>
      <value>
        <name>CANCEL_DT</name>
        <rename>OLTP_CANCEL_DATE</rename>
      </value>
      <value>
        <name>RFE_STATUS_FLAG</name>
        <rename>OLTP_RFE_STATUS_FLAG</rename>
      </value>
      <value>
        <name>STATE_REVIEW_OUTCOME</name>
        <rename>OLTP_STATE_REVIEW_OUTCOME</rename>
      </value>
      <value>
        <name>HEART_APP_STATUS</name>
        <rename>OLTP_HEART_APP_STATUS</rename>
      </value>
      <value>
        <name>APP_STATUS_GROUP</name>
        <rename>OLTP_APP_STATUS_GROUP</rename>
      </value>
      <value>
        <name>APP_STATUS_DATE</name>
        <rename>OLTP_APP_STATUS_DATE</rename>
      </value>
      <value>
        <name>STATE_ACCEPT_IND</name>
        <rename>OLTP_STATE_ACPT_IND</rename>
      </value>
      <value>
        <name>ITM_UPDATE</name>
        <rename>INYES</rename>
      </value>
    </lookup>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>324</xloc>
      <yloc>418</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
    <error>
      <source_step>Database join -- Get OLTP Data</source_step>
      <target_step/>
      <is_enabled>Y</is_enabled>
      <nr_valuename/>
      <descriptions_valuename/>
      <fields_valuename/>
      <codes_valuename/>
      <max_errors/>
      <max_pct_errors/>
      <min_pct_rows/>
    </error>
    <error>
      <source_step>Update STG -- OLTP Data only</source_step>
      <target_step>Text file output - OLTP Errors</target_step>
      <is_enabled>Y</is_enabled>
      <nr_valuename>noferr</nr_valuename>
      <descriptions_valuename>errdesc</descriptions_valuename>
      <fields_valuename>errfld</fields_valuename>
      <codes_valuename>errcod</codes_valuename>
      <max_errors>99999999</max_errors>
      <max_pct_errors/>
      <min_pct_rows/>
    </error>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
  <attributes/>
</transformation>
