--Disable the unique constraint
alter table cc_d_contact_queue DISABLE constraint CC_D_CONTACT_QUEUE__UN;

--Set duplicate records to an invalid effective date
MERGE INTO CC_D_CONTACT_QUEUE cc
using ( SELECT * 
	FROM 
	(SELECT
		D_CONTACT_QUEUE_ID
	  , QUEUE_NUMBER
	  , VERSION
	  , RECORD_EFF_DT
	  , RECORD_END_DT
	  , LEAD (RECORD_EFF_DT , 1, NULL) OVER (PARTITION BY QUEUE_NUMBER ORDER BY QUEUE_NUMBER, VERSION, RECORD_EFF_DT, RECORD_END_DT) as NEXT_EFF_DT
	  FROM CC_D_CONTACT_QUEUE cc
	  ORDER BY QUEUE_NUMBER, VERSION, RECORD_EFF_DT, RECORD_END_DT
	  )sub 
	WHERE RECORD_END_DT > NEXT_EFF_DT
	ORDER BY QUEUE_NUMBER, VERSION, RECORD_EFF_DT, RECORD_END_DT
) b
ON (cc.D_CONTACT_QUEUE_ID = b.D_CONTACT_QUEUE_ID)
WHEN matched THEN UPDATE SET cc.RECORD_EFF_DT = TO_DATE('2999-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS');

--Update valid records to cover any gaps created by duplicate records
MERGE INTO CC_D_CONTACT_QUEUE cc
using ( SELECT * 
	FROM 
	(SELECT
		D_CONTACT_QUEUE_ID
	  , QUEUE_NUMBER
	  , VERSION
	  , RECORD_EFF_DT
	  , RECORD_END_DT
	  , LEAD (RECORD_EFF_DT , 1, NULL) OVER (PARTITION BY QUEUE_NUMBER ORDER BY QUEUE_NUMBER, VERSION, RECORD_EFF_DT, RECORD_END_DT) as NEXT_EFF_DT
	  FROM CC_D_CONTACT_QUEUE cc
	  ORDER BY QUEUE_NUMBER, VERSION, RECORD_EFF_DT, RECORD_END_DT
	  )sub 
	WHERE RECORD_END_DT < NEXT_EFF_DT
    AND NEXT_EFF_DT != TO_DATE('2999-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS')
	ORDER BY QUEUE_NUMBER, VERSION, RECORD_EFF_DT, RECORD_END_DT
) b
ON (cc.D_CONTACT_QUEUE_ID = b.D_CONTACT_QUEUE_ID)
WHEN matched THEN UPDATE SET cc.RECORD_END_DT = b.NEXT_EFF_DT;


--Update Fact Table(s) records to valid D_CONTACT_QUEUE record
MERGE INTO CC_F_ACTUALS_QUEUE_INTERVAL a
using (
  SELECT faqi.F_CALL_CENTER_ACTLS_INTRVL_ID
      ,  d.D_DATE
      ,  cc.QUEUE_NUMBER
  FROM CC_F_ACTUALS_QUEUE_INTERVAL faqi
  INNER JOIN CC_D_DATES d on faqi.D_DATE_ID = d.D_DATE_ID
  INNER JOIN CC_D_CONTACT_QUEUE cc on faqi.D_CONTACT_QUEUE_ID = cc.D_CONTACT_QUEUE_ID
  WHERE faqi.D_CONTACT_QUEUE_ID IN (
    SELECT sub.D_CONTACT_QUEUE_ID
    FROM CC_D_CONTACT_QUEUE sub
    WHERE sub.RECORD_EFF_DT = TO_DATE('2999-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS'))
) b
ON (a.F_CALL_CENTER_ACTLS_INTRVL_ID = b.F_CALL_CENTER_ACTLS_INTRVL_ID)
WHEN matched THEN UPDATE SET a.D_CONTACT_QUEUE_ID = (SELECT sub2.D_CONTACT_QUEUE_ID from CC_D_CONTACT_QUEUE sub2 WHERE (b.D_DATE BETWEEN sub2.RECORD_EFF_DT AND sub2.RECORD_END_DT) AND (sub2.QUEUE_NUMBER = b.QUEUE_NUMBER));


--Delete duplicate Contact Queue records
DELETE FROM CC_D_CONTACT_QUEUE a 
WHERE a.RECORD_EFF_DT = TO_DATE('2999-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS');

--Re-enable the unique constraint
alter table cc_d_contact_queue enable constraint CC_D_CONTACT_QUEUE__UN;

INSERT INTO CC_L_PATCH_LOG ( PATCH_VERSION , SCRIPT_SEQUENCE , SCRIPT_NAME) VALUES ('0.1.5','000','000_DUPLICATE_CONTACT_QUEUE_CLEANUP');

COMMIT;