SELECT CRSV.CASE_ID
FROM
     PUBLIC.D_DATES AS D
LEFT OUTER JOIN    
(SELECT DISTINCT
         CR.PROJECT_ID        
        ,CONS_LINK.EXTERNAL_REF_ID AS CONSUMER_ID        
        ,CC.CASE_ID
        ,CR.CONTACT_RECORD_ID
        ,CR.CREATED_ON
        ,CR.UPDATED_ON
        ,CR.LOG_CREATED_ON
        ,TO_DATE(NVL(CR.CREATED_ON, CR.UPDATED_ON)) CREATE_DATE
        ,CR.CONTACT_RECORD_STATUS_TYPE
        ,(CASE WHEN DATEDIFF(second, LAG(NVL(CR.CREATED_ON, CR.UPDATED_ON)) OVER (PARTITION BY CR.PROJECT_ID, CONS_LINK.EXTERNAL_REF_ID ORDER BY CR.PROJECT_ID, CONS_LINK.EXTERNAL_REF_ID, CR.CONTACT_RECORD_ID), NVL(CR.CREATED_ON, CR.UPDATED_ON)) <= 604800
                AND DATEDIFF(second, LAG(NVL(CR.CREATED_ON, CR.UPDATED_ON)) OVER (PARTITION BY CR.PROJECT_ID, CONS_LINK.EXTERNAL_REF_ID ORDER BY CR.PROJECT_ID, CONS_LINK.EXTERNAL_REF_ID, CR.CONTACT_RECORD_ID), NVL(CR.CREATED_ON, CR.UPDATED_ON)) > 0  THEN 1 ELSE 0 END) YN_REPEATED_CONTACT
    FROM
        MARS_DP4BI_DEV.MARSDB.MARSDB_CONTACT_RECORD_VW CR
    LEFT OUTER JOIN
        MARS_DP4BI_DEV.MARSDB.MARSDB_EXTERNAL_LINKS_VW CONS_LINK
        ON CR.PROJECT_ID = CONS_LINK.PROJECT_ID
        AND CR.CONTACT_RECORD_ID = CONS_LINK.INTERNAL_ID
        AND CONS_LINK.INTERNAL_REF_TYPE = 'CONTACT_RECORD'
        AND CONS_LINK.EXTERNAL_REF_TYPE = 'CONSUMER'
        AND CONS_LINK.EFFECTIVE_END_DATE IS NULL
    LEFT OUTER JOIN
        MARS_DP4BI_DEV.MARSDB.MARSDB_CASE_CONSUMER_VW CC
        ON CONS_LINK.EXTERNAL_REF_ID = CC.CONSUMER_ID
        AND CR.PROJECT_ID = CC.PROJECT_ID
ORDER BY
         CR.PROJECT_ID
        ,CREATE_DATE
        ,CONS_LINK.EXTERNAL_REF_ID
        ,CR.CONTACT_RECORD_ID) CRSV
ON D.D_DATE = CRSV.CREATE_DATE
AND D.PROJECT_ID = CRSV.PROJECT_ID
WHERE
    CRSV.PROJECT_ID ='44'
     and D_DATE = '2021-07-22'
     and CONSUMER_ID = '13156'
  GROUP BY
     CRSV.PROJECT_ID
    ,D_DATE
    ,CRSV.CONSUMER_ID
    ,CRSV.CASE_ID
    ,LOG_CREATED_ON;