 SELECT EMAIL_ADDRESS FROM (SELECT  EML.PRIMARY_INDICATOR
                  ,EML.EMAIL_ADDRESS
                  ,EML.EMAIL_TYPE
                  ,EML.DOES_NOT_WORK_IND
                   ,EML.PROJECT_ID
                  ,CNO.EXTERNAL_REF_ID
                  ,CNO.EXTERNAL_REF_TYPE
                  ,EML.CONTACT_TYPE_ID
                  ,RANK() OVER (PARTITION BY CNO.EXTERNAL_REF_ID, CT.PROJECT_ID ORDER BY DECODE(PRIMARY_INDICATOR,1,1,DECODE(UPPER(EMAIL_TYPE),'PRIMARY',2,'OFFICE',3,4)),EML.EFFECTIVE_END_DATE DESC NULLS FIRST,EML.EMAIL_ID) ernk
           FROM  MARSDB.MARSDB_CONTACTS_OWNER_VW CNO
             LEFT JOIN MARSDB.MARSDB_CONTACTS_VW CT ON CNO.CONTACT_OWNER_ID = CT.OWNER_ID AND CT.PROJECT_ID = CNO.PROJECT_ID AND CT.CONTACT_TYPE = 'EMAIL'
             LEFT JOIN MARSDB.MARSDB_EMAIL_VW EML ON EML.CONTACT_TYPE_ID = CT.CONTACT_TYPE_ID  AND EML.PROJECT_ID = CT.PROJECT_ID
           WHERE UPPER(CNO.EXTERNAL_REF_TYPE) = 'CONSUMER') as CE
     WHERE ernk = 1
and CE.PROJECT_ID = 419
AND CE.EXTERNAL_REF_ID = 121136;