<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>CDC_Letters_stg_v2</name>
    <description/>
    <extended_description>Do not edit these four SVN_* variable values.  They are populated when you commit code to SVN and used later to identify deployed code.

    ---------------------------------

    SVN_FILE_URL        = $URL$

    SVN_REVISION        = $Revision$

    SVN_REVISION_DATE   = $Date$

    SVN_REVISION_AUTHOR = $Author$

    ---------------------------------
    </extended_description>
    <trans_version/>
    <trans_type>Normal</trans_type>
    <directory>&#47;</directory>
    <parameters>
    </parameters>
    <log>
<trans-log-table><connection/>
<schema/>
<table/>
<size_limit_lines/>
<interval/>
<timeout_days/>
<field><id>ID_BATCH</id><enabled>Y</enabled><name>ID_BATCH</name></field><field><id>CHANNEL_ID</id><enabled>Y</enabled><name>CHANNEL_ID</name></field><field><id>TRANSNAME</id><enabled>Y</enabled><name>TRANSNAME</name></field><field><id>STATUS</id><enabled>Y</enabled><name>STATUS</name></field><field><id>LINES_READ</id><enabled>Y</enabled><name>LINES_READ</name><subject/></field><field><id>LINES_WRITTEN</id><enabled>Y</enabled><name>LINES_WRITTEN</name><subject/></field><field><id>LINES_UPDATED</id><enabled>Y</enabled><name>LINES_UPDATED</name><subject/></field><field><id>LINES_INPUT</id><enabled>Y</enabled><name>LINES_INPUT</name><subject/></field><field><id>LINES_OUTPUT</id><enabled>Y</enabled><name>LINES_OUTPUT</name><subject/></field><field><id>LINES_REJECTED</id><enabled>Y</enabled><name>LINES_REJECTED</name><subject/></field><field><id>ERRORS</id><enabled>Y</enabled><name>ERRORS</name></field><field><id>STARTDATE</id><enabled>Y</enabled><name>STARTDATE</name></field><field><id>ENDDATE</id><enabled>Y</enabled><name>ENDDATE</name></field><field><id>LOGDATE</id><enabled>Y</enabled><name>LOGDATE</name></field><field><id>DEPDATE</id><enabled>Y</enabled><name>DEPDATE</name></field><field><id>REPLAYDATE</id><enabled>Y</enabled><name>REPLAYDATE</name></field><field><id>LOG_FIELD</id><enabled>Y</enabled><name>LOG_FIELD</name></field></trans-log-table>
<perf-log-table><connection/>
<schema/>
<table/>
<interval/>
<timeout_days/>
<field><id>ID_BATCH</id><enabled>Y</enabled><name>ID_BATCH</name></field><field><id>SEQ_NR</id><enabled>Y</enabled><name>SEQ_NR</name></field><field><id>LOGDATE</id><enabled>Y</enabled><name>LOGDATE</name></field><field><id>TRANSNAME</id><enabled>Y</enabled><name>TRANSNAME</name></field><field><id>STEPNAME</id><enabled>Y</enabled><name>STEPNAME</name></field><field><id>STEP_COPY</id><enabled>Y</enabled><name>STEP_COPY</name></field><field><id>LINES_READ</id><enabled>Y</enabled><name>LINES_READ</name></field><field><id>LINES_WRITTEN</id><enabled>Y</enabled><name>LINES_WRITTEN</name></field><field><id>LINES_UPDATED</id><enabled>Y</enabled><name>LINES_UPDATED</name></field><field><id>LINES_INPUT</id><enabled>Y</enabled><name>LINES_INPUT</name></field><field><id>LINES_OUTPUT</id><enabled>Y</enabled><name>LINES_OUTPUT</name></field><field><id>LINES_REJECTED</id><enabled>Y</enabled><name>LINES_REJECTED</name></field><field><id>ERRORS</id><enabled>Y</enabled><name>ERRORS</name></field><field><id>INPUT_BUFFER_ROWS</id><enabled>Y</enabled><name>INPUT_BUFFER_ROWS</name></field><field><id>OUTPUT_BUFFER_ROWS</id><enabled>Y</enabled><name>OUTPUT_BUFFER_ROWS</name></field></perf-log-table>
<channel-log-table><connection/>
<schema/>
<table/>
<timeout_days/>
<field><id>ID_BATCH</id><enabled>Y</enabled><name>ID_BATCH</name></field><field><id>CHANNEL_ID</id><enabled>Y</enabled><name>CHANNEL_ID</name></field><field><id>LOG_DATE</id><enabled>Y</enabled><name>LOG_DATE</name></field><field><id>LOGGING_OBJECT_TYPE</id><enabled>Y</enabled><name>LOGGING_OBJECT_TYPE</name></field><field><id>OBJECT_NAME</id><enabled>Y</enabled><name>OBJECT_NAME</name></field><field><id>OBJECT_COPY</id><enabled>Y</enabled><name>OBJECT_COPY</name></field><field><id>REPOSITORY_DIRECTORY</id><enabled>Y</enabled><name>REPOSITORY_DIRECTORY</name></field><field><id>FILENAME</id><enabled>Y</enabled><name>FILENAME</name></field><field><id>OBJECT_ID</id><enabled>Y</enabled><name>OBJECT_ID</name></field><field><id>OBJECT_REVISION</id><enabled>Y</enabled><name>OBJECT_REVISION</name></field><field><id>PARENT_CHANNEL_ID</id><enabled>Y</enabled><name>PARENT_CHANNEL_ID</name></field><field><id>ROOT_CHANNEL_ID</id><enabled>Y</enabled><name>ROOT_CHANNEL_ID</name></field></channel-log-table>
<step-log-table><connection/>
<schema/>
<table/>
<timeout_days/>
<field><id>ID_BATCH</id><enabled>Y</enabled><name>ID_BATCH</name></field><field><id>CHANNEL_ID</id><enabled>Y</enabled><name>CHANNEL_ID</name></field><field><id>LOG_DATE</id><enabled>Y</enabled><name>LOG_DATE</name></field><field><id>TRANSNAME</id><enabled>Y</enabled><name>TRANSNAME</name></field><field><id>STEPNAME</id><enabled>Y</enabled><name>STEPNAME</name></field><field><id>STEP_COPY</id><enabled>Y</enabled><name>STEP_COPY</name></field><field><id>LINES_READ</id><enabled>Y</enabled><name>LINES_READ</name></field><field><id>LINES_WRITTEN</id><enabled>Y</enabled><name>LINES_WRITTEN</name></field><field><id>LINES_UPDATED</id><enabled>Y</enabled><name>LINES_UPDATED</name></field><field><id>LINES_INPUT</id><enabled>Y</enabled><name>LINES_INPUT</name></field><field><id>LINES_OUTPUT</id><enabled>Y</enabled><name>LINES_OUTPUT</name></field><field><id>LINES_REJECTED</id><enabled>Y</enabled><name>LINES_REJECTED</name></field><field><id>ERRORS</id><enabled>Y</enabled><name>ERRORS</name></field><field><id>LOG_FIELD</id><enabled>N</enabled><name>LOG_FIELD</name></field></step-log-table>
    </log>
    <maxdate>
      <connection/>
      <table/>
      <field/>
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file/>
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
  <created_user>-</created_user>
  <created_date>2012&#47;08&#47;21 12:57:58.718</created_date>
  <modified_user>-</modified_user>
  <modified_date>2012&#47;08&#47;21 12:57:58.718</modified_date>
  </info>
  <notepads>
    <notepad>
      <note>This transformation fetches the letters associated to the In-process Apps and&#47;or the completed Apps 
in the past few days(driven by global control value). Also, this transformation gets the Change data only
using the update_ts field.</note>
      <xloc>101</xloc>
      <yloc>458</yloc>
      <width>611</width>
      <heigth>55</heigth>
      <fontname>Arial</fontname>
      <fontsize>10</fontsize>
      <fontbold>N</fontbold>
      <fontitalic>N</fontitalic>
      <fontcolorred>0</fontcolorred>
      <fontcolorgreen>0</fontcolorgreen>
      <fontcolorblue>0</fontcolorblue>
      <backgroundcolorred>255</backgroundcolorred>
      <backgroundcolorgreen>165</backgroundcolorgreen>
      <backgroundcolorblue>0</backgroundcolorblue>
      <bordercolorred>100</bordercolorred>
      <bordercolorgreen>100</bordercolorgreen>
      <bordercolorblue>100</bordercolorblue>
      <drawshadow>Y</drawshadow>
    </notepad>
  </notepads>
  <connection>
    <name>MAXDAT</name>
    <server>${DB_MAXDAT_HOSTNAME}</server>
    <type>ORACLE</type>
    <access>Native</access>
    <database>${DB_MAXDAT_NAME}</database>
    <port>${DB_MAXDAT_PORT}</port>
    <username>${DB_MAXDAT_USER}</username>
    <password>${DB_MAXDAT_PASSWORD}</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute><code>FORCE_IDENTIFIERS_TO_LOWERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_UPPERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>INITIAL_POOL_SIZE</code><attribute>5</attribute></attribute>
      <attribute><code>IS_CLUSTERED</code><attribute>N</attribute></attribute>
      <attribute><code>MAXIMUM_POOL_SIZE</code><attribute>10</attribute></attribute>
      <attribute><code>POOLING_initialSize</code><attribute>${INIT_POOL_SIZE}</attribute></attribute>
      <attribute><code>POOLING_logAbandoned</code><attribute>false</attribute></attribute>
      <attribute><code>POOLING_maxActive</code><attribute>${MAX_POOL_SIZE}</attribute></attribute>
      <attribute><code>POOLING_testOnBorrow</code><attribute>true</attribute></attribute>
      <attribute><code>POOLING_validationQuery</code><attribute>select 1 from dual</attribute></attribute>
      <attribute><code>PORT_NUMBER</code><attribute>${DB_MAXDAT_PORT}</attribute></attribute>
      <attribute><code>PREFERRED_SCHEMA_NAME</code><attribute>${DB_MAXDAT_SCHEMA}</attribute></attribute>
      <attribute><code>QUOTE_ALL_FIELDS</code><attribute>N</attribute></attribute>
      <attribute><code>SQL_CONNECT</code><attribute>ALTER SESSION SET CURRENT_SCHEMA = MAXDAT;</attribute></attribute>
      <attribute><code>SUPPORTS_BOOLEAN_DATA_TYPE</code><attribute>N</attribute></attribute>
      <attribute><code>USE_POOLING</code><attribute>Y</attribute></attribute>
    </attributes>
  </connection>
  <connection>
    <name>OLTP_SOURCE</name>
    <server>${DB_OLTP_HOSTNAME}</server>
    <type>ORACLE</type>
    <access>Native</access>
    <database>${DB_OLTP_NAME}</database>
    <port>${DB_OLTP_PORT}</port>
    <username>${DB_OLTP_USER}</username>
    <password>${DB_OLTP_PASSWORD}</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute><code>FORCE_IDENTIFIERS_TO_LOWERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>FORCE_IDENTIFIERS_TO_UPPERCASE</code><attribute>N</attribute></attribute>
      <attribute><code>INITIAL_POOL_SIZE</code><attribute>5</attribute></attribute>
      <attribute><code>IS_CLUSTERED</code><attribute>N</attribute></attribute>
      <attribute><code>MAXIMUM_POOL_SIZE</code><attribute>10</attribute></attribute>
      <attribute><code>POOLING_initialSize</code><attribute>${INIT_POOL_SIZE}</attribute></attribute>
      <attribute><code>POOLING_logAbandoned</code><attribute>false</attribute></attribute>
      <attribute><code>POOLING_maxActive</code><attribute>${MAX_POOL_SIZE}</attribute></attribute>
      <attribute><code>POOLING_testOnBorrow</code><attribute>true</attribute></attribute>
      <attribute><code>POOLING_validationQuery</code><attribute>select 1 from dual</attribute></attribute>
      <attribute><code>PORT_NUMBER</code><attribute>${DB_OLTP_PORT}</attribute></attribute>
      <attribute><code>PREFERRED_SCHEMA_NAME</code><attribute>${DB_OLTP_SCHEMA}</attribute></attribute>
      <attribute><code>QUOTE_ALL_FIELDS</code><attribute>N</attribute></attribute>
      <attribute><code>SUPPORTS_BOOLEAN_DATA_TYPE</code><attribute>N</attribute></attribute>
      <attribute><code>USE_POOLING</code><attribute>Y</attribute></attribute>
    </attributes>
  </connection>
  <order>
  <hop> <from>Database join - Get letters from OLTP</from><to>Insert &#47; Update</to><enabled>Y</enabled> </hop>  <hop> <from>Get letters last Update Date</from><to>Fetch days past</to><enabled>Y</enabled> </hop>  <hop> <from>Fetch days past</from><to>Database join - Get letters from OLTP</to><enabled>Y</enabled> </hop>  </order>
  <step>
    <name>Database join - Get letters from OLTP</name>
    <type>DBJoin</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <connection>OLTP_SOURCE</connection>
    <rowlimit>0</rowlimit>
    <sql>&#47;*
This SQL gets all the letters on the In-process Applications and completed apps in the last 31 days(days driven by global variable)
and the Material Request letters.
*&#47;
select distinct 
       lr.lmreq_id      as letter_id,
       lr.requested_on  as Letter_requested_on,
       lr.status_cd     as letter_status_cd,
       lr.create_ts     as Letter_create_ts,
       lr.update_ts     as Letter_update_ts,
       lr.sent_on       as letter_sent_on,
       lr.mailed_date   as letter_mailed_date,
       Ll.reference_id  as letter_App_id,
       lr.case_id       as letter_case_id,
	   lr.parent_lmreq_id as LETTER_PARENT_LMREQ_ID,
       ll.reference_type  as Letter_ref_type,
       ld.name            as Letter_type_cd,
       Ld.description     as Letter_type,
       lr.request_type    as Letter_request_type,
       lr.language_cd    as LETTER_LANG_CD,
       lr.driver_type    as LETTER_DRIVER_TYPE,
       lr.material_request_id as LET_MATERIAL_REQUEST_ID
from app_header          ap,
     letter_request      lr, 
     letter_request_link ll , 
     letter_definition   ld
where 1=1
and ( ap.status_cd not in (&apos;COMPLETED&apos;,&apos;TIMEOUT&apos;,&apos;DISREGARDED&apos;)
      or (ap.status_cd in (&apos;COMPLETED&apos;,&apos;TIMEOUT&apos;,&apos;DISREGARDED&apos;) and ap.status_date &gt;= trunc(sysdate)-?)
      )
and Ll.reference_id = ap.application_id
and lr.lmreq_id = ll.lmreq_id 
and lr.lmdef_id = ld.lmdef_id
and lr.update_ts &gt; ?
union
select distinct 
       lr.lmreq_id      as letter_id,
       lr.requested_on  as Letter_requested_on,
       lr.status_cd     as letter_status_cd,
       lr.create_ts     as Letter_create_ts,
       lr.update_ts     as Letter_update_ts,
       lr.sent_on       as letter_sent_on,
       lr.mailed_date   as letter_mailed_date,
       null             as letter_App_id,
       lr.case_id       as letter_case_id,
       lr.parent_lmreq_id as LETTER_PARENT_LMREQ_ID,
       null             as Letter_ref_type,
       ld.name             as Letter_type_cd,
       Ld.description      as Letter_type,
       lr.request_type     as Letter_request_type,
       lr.language_cd      as LETTER_LANG_CD,
       lr.driver_type      as LETTER_DRIVER_TYPE,
       lr.material_request_id as LET_MATERIAL_REQUEST_ID
from 
     letter_request      lr,     
     letter_definition   ld
where 1=1
and lr.lmdef_id = ld.lmdef_id
and ld.name = &apos;XX&apos;
and lr.update_ts &gt; ?</sql>
    <outer_join>N</outer_join>
    <replace_vars>Y</replace_vars>
    <parameter>
      <field>
        <name>IN_LETTERS_CDC_APPS_DAYS_BACK</name>
        <type>Integer</type>
      </field>
      <field>
        <name>IN_LETTERS_LAST_UPD_DT</name>
        <type>Date</type>
      </field>
      <field>
        <name>IN_LETTERS_LAST_UPD_DT</name>
        <type>Date</type>
      </field>
    </parameter>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>241</xloc>
      <yloc>304</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Fetch days past</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <connection>MAXDAT</connection>
    <sql>&#47;*
This global control value is used to fetch all letters on completed Applications going back these many days.
This step fetches the variable that determines how many days back to go to fetch the letters from the OLTP on
completed Applications.
*&#47;
select value as in_LETTERS_CDC_APPS_DAYS_BACK,
	    ?    AS in_Letters_Last_Upd_Dt
from corp_etl_control
where name = &apos;LETTERS_CDC_APPS_DAYS_BACK&apos;</sql>
    <limit>0</limit>
    <lookup>Get letters last Update Date</lookup>
    <execute_each_row>N</execute_each_row>
    <variables_active>Y</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>240</xloc>
      <yloc>171</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Get letters last Update Date</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <connection>MAXDAT</connection>
    <sql>select to_date(value,&apos;yyyy&#47;mm&#47;dd hh24:mi:ss&apos;) as InLetters_Last_Upd_Dt
  from corp_etl_control
 where name = &apos;LETTERS_LAST_UPDATE_DATE&apos;

</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>239</xloc>
      <yloc>42</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step>
    <name>Insert &#47; Update</name>
    <type>InsertUpdate</type>
    <description/>
    <distribute>Y</distribute>
    <copies>1</copies>
         <partitioning>
           <method>none</method>
           <schema_name/>
           </partitioning>
    <connection>MAXDAT</connection>
    <commit>1000</commit>
    <update_bypassed>N</update_bypassed>
    <lookup>
      <schema>MAXDAT</schema>
      <table>letters_stg</table>
      <key>
        <name>LETTER_ID</name>
        <field>LETTER_ID</field>
        <condition>=</condition>
        <name2/>
      </key>
      <value>
        <name>LETTER_ID</name>
        <rename>LETTER_ID</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_REQUESTED_ON</name>
        <rename>LETTER_REQUESTED_ON</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_STATUS_CD</name>
        <rename>LETTER_STATUS_CD</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_CREATE_TS</name>
        <rename>LETTER_CREATE_TS</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_UPDATE_TS</name>
        <rename>LETTER_UPDATE_TS</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_SENT_ON</name>
        <rename>LETTER_SENT_ON</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_MAILED_DATE</name>
        <rename>LETTER_MAILED_DATE</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_APP_ID</name>
        <rename>LETTER_APP_ID</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_CASE_ID</name>
        <rename>LETTER_CASE_ID</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_REF_TYPE</name>
        <rename>LETTER_REF_TYPE</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_TYPE_CD</name>
        <rename>LETTER_TYPE_CD</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_TYPE</name>
        <rename>LETTER_TYPE</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_REQUEST_TYPE</name>
        <rename>LETTER_REQUEST_TYPE</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_LANG_CD</name>
        <rename>LETTER_LANG_CD</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LETTER_DRIVER_TYPE</name>
        <rename>LETTER_DRIVER_TYPE</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LET_MATERIAL_REQUEST_ID</name>
        <rename>LET_MATERIAL_REQUEST_ID</rename>
        <update>Y</update>
      </value>
    </lookup>
     <cluster_schema/>
 <remotesteps>   <input>   </input>   <output>   </output> </remotesteps>    <GUI>
      <xloc>514</xloc>
      <yloc>304</yloc>
      <draw>Y</draw>
      </GUI>
    </step>

  <step_error_handling>
  </step_error_handling>
   <slave-step-copy-partition-distribution>
</slave-step-copy-partition-distribution>
   <slave_transformation>N</slave_transformation>
</transformation>
