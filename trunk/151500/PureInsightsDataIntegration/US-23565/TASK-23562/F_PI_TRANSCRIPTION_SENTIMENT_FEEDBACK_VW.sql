use role SYSADMIN;
use warehouse PUREINSIGHTS_PRD_LOAD_DAILY_WH;
use database PUREINSIGHTS_PRD;
use schema PUBLIC;

create or replace view D_PI_TRANSCRIPTION_SENTIMENT_FEEDBACK_VW(
	PROJECTID,
	PROJECTNAME,
	PROGRAMID,
	PROGRAMNAME,
	ID,
	PHRASE,
	FEEDBACKVALUE,
	DIALECT,
	CREATEDBYID,
	CREATEDBYNAME,
	DATECREATED,
	PROJECTDATECREATED
) COPY GRANTS AS
WITH
    user_created AS (SELECT co.projectid AS projectid, co.raw:id AS ID, TRIM(CAST(co.raw:name AS VARCHAR(255))) AS name FROM raw.configuration_objects co  WHERE co.raw:type = 'user')    
select
	tsf.projectid as PROJECTID,
  	pr.projectname as PROJECTNAME,
  	tsf.programId as PROGRAMID,
  	tsf.programName as PROGRAMNAME,
  	cast (tsf.raw:id as varchar(255)) as ID,
  	cast (tsf.raw:phrase as varchar(255)) as PHRASE,
  	cast (tsf.raw:feedbackValue as varchar(255)) as FEEDBACKVALUE,
  	cast (tsf.raw:dialect as varchar(255)) as DIALECT,
  	cast (tsf.raw:createdById as varchar(255)) as CREATEDBYID,
  	user_created.name as CREATEDBYNAME,
  	cast (tsf.raw:dateCreated as datetime) as DATECREATED,
	convert_timezone('UTC',pr.projectTimezone,cast(tsf.raw:dateCreated as datetime)) as projectdatecreated  	
from 
	raw.transcription_Sentiment_feedback tsf
join 
	PUBLIC.D_PI_PROJECTS pr
on 
	tsf.projectId = pr.projectId
LEFT JOIN
	user_created
ON
(
		tsf.raw:createdById = user_created.ID
	AND	tsf.projectid = user_created.projectid
);

GRANT SELECT ON D_PI_TRANSCRIPTION_SENTIMENT_FEEDBACK_VW TO BI_PRODUCT_DEV;   
GRANT SELECT ON D_PI_TRANSCRIPTION_SENTIMENT_FEEDBACK_VW TO DATA_SUPPORT_ROLE;
GRANT SELECT ON D_PI_TRANSCRIPTION_SENTIMENT_FEEDBACK_VW TO DA_LAB_ADMIN;
GRANT SELECT ON D_PI_TRANSCRIPTION_SENTIMENT_FEEDBACK_VW TO DA_LAB_READ;
GRANT SELECT ON D_PI_TRANSCRIPTION_SENTIMENT_FEEDBACK_VW TO MAX_DEV;
GRANT SELECT ON D_PI_TRANSCRIPTION_SENTIMENT_FEEDBACK_VW TO OPS_ANALYTICS_TEAM;
GRANT SELECT ON D_PI_TRANSCRIPTION_SENTIMENT_FEEDBACK_VW TO PUBLIC;
GRANT SELECT ON D_PI_TRANSCRIPTION_SENTIMENT_FEEDBACK_VW TO INFA_DATA_CATALOG_DEV_READ;
GRANT SELECT ON D_PI_TRANSCRIPTION_SENTIMENT_FEEDBACK_VW TO PUREINSIGHTS_DEV_READ;
GRANT SELECT ON D_PI_TRANSCRIPTION_SENTIMENT_FEEDBACK_VW TO PI_DATA_INGEST_DEV_ALERT_USER;
GRANT DELETE, INSERT, REBUILD, REFERENCES, SELECT, TRUNCATE, UPDATE ON D_PI_TRANSCRIPTION_SENTIMENT_FEEDBACK_VW TO PUREINSIGHTS_DEV_POC;

SELECT * FROM D_PI_TRANSCRIPTION_SENTIMENT_FEEDBACK_VW;
