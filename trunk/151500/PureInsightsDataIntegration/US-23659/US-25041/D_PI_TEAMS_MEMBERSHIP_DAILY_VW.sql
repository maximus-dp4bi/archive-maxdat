use role SYSADMIN;
use warehouse PUREINSIGHTS_DEV_LOAD_DAILY_WH;
use database PUREINSIGHTS_DEV;
use schema PUBLIC;

create or replace view D_PI_TEAMS_MEMBERSHIP_DAILY_VW(
	PROJECTID,
	PROGRAMID,
	INGESTIONDATETIME,
	TEAMID,
	TEAMNAME,
	USERID,
	USERNAME,
	DIVISIONID,
	DIVISIONNAME,
	ROW_HASH,
	SNOWFLAKE_INSERT_DATETIME,
	SNOWFLAKE_UPDATE_DATETIME,
	AS_OF_DATE,
	INSERT_BY,
	CURRENT_USER_RECORD,
	START_DATE,
	END_DATE,
	DATE
) COPY GRANTS as(
WITH tm AS 
(
SELECT *, AS_OF_DATE AS START_DATE, 
CASE WHEN CURRENT_USER_RECORD = 1 THEN CAST('2100-12-31' AS DATE) ELSE LEAD(AS_OF_DATE) OVER (PARTITION BY USERID ORDER BY AS_OF_DATE ASC)-1 END END_DATE 
FROM STAGE.PI_TEAMS_MEMBERSHIP_HISTORY)                                
SELECT 
	PROJECTID,
	PROGRAMID,
	INGESTIONDATETIME,
	TEAMID,
	TEAMNAME,
	USERID,
	USERNAME,
	DIVISIONID,
	DIVISIONNAME,
	ROW_HASH,
	SNOWFLAKE_INSERT_DATETIME,
	SNOWFLAKE_UPDATE_DATETIME,
	AS_OF_DATE,
	INSERT_BY,
	CURRENT_USER_RECORD,
	START_DATE,
	END_DATE, 
	dd.DATE 
FROM 
	tm
LEFT JOIN 
	PUBLIC.D_DATES dd ON dd.DATE BETWEEN START_DATE AND END_DATE AND dd.DATE <= CAST(SYSDATE() AS DATE));

GRANT SELECT ON D_PI_TEAMS_MEMBERSHIP_VW TO BI_PRODUCT_DEV;   
GRANT SELECT ON D_PI_TEAMS_MEMBERSHIP_VW TO DATA_SUPPORT_ROLE;
GRANT SELECT ON D_PI_TEAMS_MEMBERSHIP_VW TO DA_LAB_ADMIN;
GRANT SELECT ON D_PI_TEAMS_MEMBERSHIP_VW TO DA_LAB_READ;
GRANT SELECT ON D_PI_TEAMS_MEMBERSHIP_VW TO MAX_DEV;
GRANT SELECT ON D_PI_TEAMS_MEMBERSHIP_VW TO OPS_ANALYTICS_TEAM;
GRANT SELECT ON D_PI_TEAMS_MEMBERSHIP_VW TO PUBLIC;
GRANT SELECT ON D_PI_TEAMS_MEMBERSHIP_VW TO INFA_DATA_CATALOG_DEV_READ;
GRANT SELECT ON D_PI_TEAMS_MEMBERSHIP_VW TO PUREINSIGHTS_DEV_READ;
GRANT SELECT ON D_PI_TEAMS_MEMBERSHIP_VW TO PI_DATA_INGEST_DEV_ALERT_USER;
GRANT DELETE, INSERT, REBUILD, REFERENCES, SELECT, TRUNCATE, UPDATE ON D_PI_TEAMS_MEMBERSHIP_VW TO PUREINSIGHTS_DEV_POC;

SELECT * FROM D_PI_TEAMS_MEMBERSHIP_DAILY_VW;
