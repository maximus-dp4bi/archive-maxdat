-- CRM_ADDRESS_VW
create or replace view CRM_ADDRESS_VW as
select  DATA:action::VARCHAR as action,
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:projectId::INTEGER as projectId, 
        DATA:projectName::VARCHAR as projectName,
        DATA:dataObject:addrAttn::VARCHAR as addrAttn,
        DATA:dataObject:addrHouseCode::VARCHAR as addrHouseCode,
        DATA:dataObject:addressCity::VARCHAR as addressCity,
        DATA:dataObject:addressCorrelationId::VARCHAR as addressCorrelationId,
        DATA:dataObject:addressCounty::VARCHAR as addressCounty,
        DATA:dataObject:addressId::INTEGER as addressId,
        DATA:dataObject:addressSource::VARCHAR as addressSource,
        DATA:dataObject:addressState::VARCHAR as addressState,
        DATA:dataObject:addressStreet1::VARCHAR as addressStreet1,
        DATA:dataObject:addressStreet2::VARCHAR as addressStreet2,
        DATA:dataObject:addressType::VARCHAR as addressType,
        DATA:dataObject:addressVerfied::INTEGER as addressVerfied,
        DATA:dataObject:addressVerificationSource::VARCHAR as addressVerificationSource,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:addressVerifiedDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as addressVerifiedDate_utc,
        DATA:dataObject:addressZip::VARCHAR as addressZip,
        DATA:dataObject:addressZipFour::VARCHAR as addressZipFour,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:badAddressSetDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as badAddressSetDate_utc,
        DATA:dataObject:badAddressSource::VARCHAR as badAddressSource,
        DATA:dataObject:contactTypeId::INTEGER as contactTypeId,
        DATA:dataObject:correlationId::VARCHAR as correlationId,
        DATA:dataObject:createdBy::VARCHAR as createdBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:effectiveEndDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveEndDate_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:effectiveStartDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveStartDate_utc,
        DATA:dataObject:externalRefId::INTEGER as externalRefId,
        DATA:dataObject:externalRefType::VARCHAR as externalRefType,
        DATA:dataObject:geoCodeAttributes::VARCHAR as geoCodeAttributes,
        DATA:dataObject:inactivationReason::VARCHAR as inactivationReason,
        DATA:dataObject:intelligentMailBarcode::VARCHAR as intelligentMailBarcode,
        DATA:dataObject:primaryIndicator::VARCHAR as primaryIndicator,
        DATA:dataObject:status::VARCHAR as status,
        DATA:dataObject:uiid::VARCHAR as uiid,
        DATA:dataObject:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc
from JSON_ADDRESS_DATA
join
(select DATA:dataObject:addressId as addressId,        
        MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc       
from JSON_ADDRESS_DATA
group by addressId) currentRecord on addressId = currentRecord.addressId and convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) = currentRecord.maxEventCreatedOn_utc;


-- CRM_PHONE_VW
create or replace view CRM_PHONE_VW as
select  DATA:action::VARCHAR as action,
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:projectId::INTEGER as projectId, 
        DATA:projectName::VARCHAR as projectName,
        DATA:dataObject:associatedCaseMember::VARCHAR as associatedCaseMember,
        DATA:dataObject:canReceiveTextInd::VARCHAR as canReceiveTextInd,
        DATA:dataObject:comments::VARCHAR as comments,
        DATA:dataObject:contactTypeId::INTEGER as contactTypeId,
        DATA:dataObject:correlationId::VARCHAR as correlationId,
        DATA:dataObject:createdBy::VARCHAR as createdBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        DATA:dataObject:doesNotWorkInd::VARCHAR as doesNotWorkInd,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:effectiveEndDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveEndDate_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:effectiveStartDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveStartDate_utc,
        DATA:dataObject:externalRefId::INTEGER as externalRefId,
        DATA:dataObject:externalRefType::VARCHAR as externalRefType,
        DATA:dataObject:phoneCorrelationId::VARCHAR as phoneCorrelationId,
        DATA:dataObject:phoneId::INTEGER as phoneId,
        DATA:dataObject:phoneNumber::VARCHAR as phoneNumber,
        DATA:dataObject:phoneType::VARCHAR as phoneType,
        DATA:dataObject:smsEnabledInd::VARCHAR as smsEnabledInd,
        DATA:dataObject:status::VARCHAR as status,
        DATA:dataObject:uiid::VARCHAR as uiid,
        DATA:dataObject:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc
from JSON_PHONE_DATA
join
(select DATA:dataObject:phoneId as phoneId,        
        MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc       
from JSON_PHONE_DATA
group by phoneId) currentRecord on phoneId = currentRecord.phoneId and convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) = currentRecord.maxEventCreatedOn_utc;


-- CRM_EMAIL_VW
create or replace view CRM_EMAIL_VW as
select  DATA:action::VARCHAR as action,
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:projectId::INTEGER as projectId, 
        DATA:projectName::VARCHAR as projectName,
        DATA:dataObject:associatedCaseMember::VARCHAR as associatedCaseMember,
        DATA:dataObject:correlationId::VARCHAR as correlationId,
        DATA:dataObject:createdBy::VARCHAR as createdBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        DATA:dataObject:doesNotWorkInd::VARCHAR as doesNotWorkInd,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:effectiveEndDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveEndDate_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:effectiveStartDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveStartDate_utc,
        DATA:dataObject:emailAddress::VARCHAR as emailAddress,
        DATA:dataObject:emailCorrelationId::VARCHAR as emailCorrelationId,
        DATA:dataObject:emailId::INTEGER as emailId,
        DATA:dataObject:emailType::VARCHAR as emailType,
        DATA:dataObject:externalRefId::INTEGER as externalRefId,
        DATA:dataObject:externalRefType::VARCHAR as externalRefType,
        DATA:dataObject:ownerId::INTEGER as ownerId,
        DATA:dataObject:primaryIndicator::VARCHAR as primaryIndicator,
        DATA:dataObject:status::VARCHAR as status,
        DATA:dataObject:uiid::VARCHAR as uiid,
        DATA:dataObject:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc
from JSON_EMAIL_DATA
join
(select DATA:dataObject:emailId as emailId,        
        MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc       
from JSON_EMAIL_DATA
group by emailId) currentRecord on emailId = currentRecord.emailId and convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) = currentRecord.maxEventCreatedOn_utc;


-- CRM_CONTACT_RECORD_VW
create or replace view CRM_CONTACT_RECORD_VW as
select  DATA:action::VARCHAR as action,        
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:projectId::INTEGER as projectId, 
        DATA:projectName::VARCHAR as projectName,         
        DATA:dataObject:callDuration::INTEGER as callDuration,
        DATA:dataObject:consumerAuthenticatedInd::VARCHAR as consumerAuthenticatedInd,
        DATA:dataObject:consumerEmail::VARCHAR as consumerEmail,
        DATA:dataObject:consumerFirstName::VARCHAR as consumerFirstName,
        DATA:dataObject:consumerLastName::VARCHAR as consumerLastName,
        DATA:dataObject:consumerPhone::VARCHAR as consumerPhone,
        initcap(DATA:dataObject:contactChannelType)::VARCHAR as contactChannelType,
        DATA:dataObject:contactCompaignType::VARCHAR as contactCompaignType,
        DATA:dataObject:contactOutcome::VARCHAR as contactOutcome,
        DATA:dataObject:contactReasonEditType::VARCHAR as contactReasonEditType,        
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:contactRecordEndTime::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as contactRecordEndTime_utc,
        DATA:dataObject:contactRecordId::INTEGER as contactRecordId,        
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:contactRecordStartTime::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as contactRecordStartTime_utc,
        DATA:dataObject:contactRecordStatusType::VARCHAR as contactDisposition,
        DATA:dataObject:contactRecordType::VARCHAR as contactRecordType,
        DATA:dataObject:contactType::VARCHAR as contactType,
        DATA:dataObject:correlationId::VARCHAR as correlationId,
        DATA:dataObject:createdBy::VARCHAR as createdBy,        
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        DATA:dataObject:inboundCallQueue::VARCHAR as inboundCallQueue,
        DATA:dataObject:organizationName::VARCHAR as organizationName,
        DATA:dataObject:preferredLanguageCode::VARCHAR as preferredLanguageCode,
        DATA:dataObject:uiid::VARCHAR as uiid,
        DATA:dataObject:updatedBy::VARCHAR as updatedBy,        
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc,
        DATA:dataObject:wrapUpTime::VARCHAR as wrapUpTime,
        externalId as consumerId
from JSON_CONTACT_RECORD_DATA
join
(select  DATA:dataObject:contactRecordId as contactRecordId,        
        MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc       
from JSON_CONTACT_RECORD_DATA
group by contactRecordId) currentRecord on contactRecordId = currentRecord.contactRecordId and convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) = currentRecord.maxEventCreatedOn_utc
left join CRM_LINK_VW on contactRecordId = internalId and internalRefType = 'CONTACT_RECORD' and externalRefType = 'CONSUMER';


-- CRM_CONTACT_CHANNEL_TYPE_VW
create or replace view CRM_CONTACT_CHANNEL_TYPE_VW as
select distinct contactChannelType
from CRM_CONTACT_RECORD_VW;

-- CRM_CONTACT_RECORD_TYPE_VW
create or replace view CRM_CONTACT_RECORD_TYPE_VW as
select distinct contactRecordType
from CRM_CONTACT_RECORD_VW;

-- CRM_CONTACT_TYPE_VW
create or replace view CRM_CONTACT_TYPE_VW as
select distinct contactType
from CRM_CONTACT_RECORD_VW;

-- CRM_CONTACT_DISPOSITION_VW
create or replace view CRM_CONTACT_DISPOSITION_VW as
select distinct contactDisposition
from CRM_CONTACT_RECORD_VW;

-- CRM_COMPAIGN_TYPE_VW
create or replace view CRM_COMPAIGN_TYPE_VW as
select distinct CONTACTCOMPAIGNTYPE
from CRM_CONTACT_RECORD_VW;

-- CRM_CONTACT_OUTCOME_VW
create or replace view CRM_CONTACT_OUTCOME_VW as
select distinct contactOutcome
from CRM_CONTACT_RECORD_VW;

-- CRM_CONTACT_INBOUND_CALL_QUEUE_VW
create or replace view CRM_CONTACT_INBOUND_CALL_QUEUE_VW as
select distinct inboundCallQueue
from CRM_CONTACT_RECORD_VW;

-- CRM_CONTACT_PREFERRED_LANGUAGE_CODE_VW
create or replace view CRM_CONTACT_PREFERRED_LANGUAGE_CODE_VW as
select distinct preferredLanguageCode
from CRM_CONTACT_RECORD_VW;


-- CRM_CONTACT_RECORD_COMMENT_VW
create or replace view CRM_CONTACT_RECORD_COMMENT_VW as
select  DATA:action::VARCHAR as action,        
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:projectId::INTEGER as projectId, 
        DATA:projectName::VARCHAR as projectName,
        DATA:dataObject:comment::VARCHAR as comment,
        DATA:dataObject:contactRecordCommentId::INTEGER as contactRecordCommentId,
        DATA:dataObject:contactRecordId::INTEGER as contactRecordId,
        DATA:dataObject:correlationId::VARCHAR as correlationId,
        DATA:dataObject:createdBy::VARCHAR as createdBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        DATA:dataObject:uiid::VARCHAR as uiid,
        DATA:dataObject:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc
from JSON_CONTACT_RECORD_COMMENT_DATA
join
(select  DATA:dataObject:contactRecordCommentId as contactRecordCommentId,
         MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc
from JSON_CONTACT_RECORD_COMMENT_DATA
group by contactRecordCommentId) currentRecord on contactRecordCommentId = currentRecord.contactRecordCommentId and convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) = currentRecord.maxEventCreatedOn_utc;

-- CRM_CONTACT_RECORD_REASON_VW
create or replace view CRM_CONTACT_RECORD_REASON_VW as
select  DATA:action::VARCHAR as action,        
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:projectId::INTEGER as projectId, 
        DATA:projectName::VARCHAR as projectName,
        DATA:dataObject:contactRecordId::INTEGER as contactRecordId,
        DATA:dataObject:contactRecordReasonId::INTEGER as contactRecordReasonId,
        DATA:dataObject:contactRecordReasonType::VARCHAR as contactRecordReasonType,
        DATA:dataObject:correlationId::VARCHAR as correlationId,
        DATA:dataObject:createdBy::VARCHAR as createdBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        DATA:dataObject:notes::VARCHAR as notes,
        DATA:dataObject:uiid::VARCHAR as uiid,
        DATA:dataObject:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc
from JSON_CONTACT_RECORD_REASON_DATA
join
(select  DATA:dataObject:contactRecordReasonId as contactRecordReasonId,
         MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc
from JSON_CONTACT_RECORD_REASON_DATA
group by contactRecordReasonId) currentRecord on contactRecordReasonId = currentRecord.contactRecordReasonId and convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) = currentRecord.maxEventCreatedOn_utc;

-- CRM_CONTACT_RECORD_ACTION_VW
create or replace view CRM_CONTACT_RECORD_ACTION_VW as
select * from (
select  DATA:action::VARCHAR as action,        
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:projectId::INTEGER as projectId, 
        DATA:projectName::VARCHAR as projectName,
        DATA:dataObject:contactRecordId::INTEGER as contactRecordId,
        DATA:dataObject:contactRecordReasonId::INTEGER as contactRecordReasonId,
        VALUE:contactRecordActionId::INTEGER as contactRecordActionId,
        VALUE:comment::VARCHAR as comment,
        VALUE:contactRecordActionType::VARCHAR as contactRecordActionType,        
        VALUE:correlationId::VARCHAR as correlationId,
        VALUE:createdBy::VARCHAR as createdBy,        
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        VALUE:uiid::VARCHAR as uiid,
        VALUE:updatedBy::VARCHAR as updatedBy,        
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc
from JSON_CONTACT_RECORD_REASON_DATA, lateral flatten(input=> DATA:dataObject:contactRecordActions)) allRecords
join
(select  DATA:dataObject:contactRecordReasonId as contactRecordReasonIdc,        
         MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc
from JSON_CONTACT_RECORD_REASON_DATA
group by contactRecordReasonIdc) currentRecord on allRecords.contactRecordReasonId = currentRecord.contactRecordReasonIdc and allRecords.eventCreatedOn_utc = currentRecord.maxEventCreatedOn_utc;


-- CRM_TASK_VW
create or replace view CRM_TASK_VW as
select  DATA:action::VARCHAR as action,
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:projectId::INTEGER as projectId, 
        DATA:projectName::VARCHAR as projectName,
        DATA:dataObject:action::VARCHAR as taskAction,
        DATA:dataObject:actionTaken::VARCHAR as taskActionTaken,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:actionedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as taskActionedOn_utc,
        DATA:dataObject:cancelReason::VARCHAR as cancelReason,
        DATA:dataObject:correlationId::VARCHAR as correlationId,
        DATA:dataObject:createdBy::VARCHAR as createdBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:defaultDueDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as defaultDueDate_utc,
        DATA:dataObject:defaultPriority::VARCHAR as defaultPriority,
        DATA:dataObject:escalatedFlag::VARCHAR as escalatedFlag,
        DATA:dataObject:holdReason::VARCHAR as holdReason,
        DATA:dataObject:source::VARCHAR as source,
        DATA:dataObject:staffAssignedTo::VARCHAR as staffAssignedTo,
        convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:statusDate::VARCHAR, 'YYYY/MM/DD')) as statusDate_utc,
        DATA:dataObject:taskDisposition::VARCHAR as taskDisposition,
        DATA:dataObject:taskId::INTEGER as taskId,
        DATA:dataObject:taskInfo::VARCHAR as taskInfo,
        DATA:dataObject:taskNotes::VARCHAR as taskNotes,
        DATA:dataObject:taskStatus::VARCHAR as taskStatus,
        DATA:dataObject:taskTypeId::INTEGER as taskTypeId,
        DATA:dataObject:uiid::VARCHAR as uiid,
        DATA:dataObject:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc,
        externalId as contactRecordId
from JSON_TASK_DATA
join
(select DATA:dataObject:taskId as taskId,        
        MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc       
from JSON_TASK_DATA
group by taskId) currentRecord on taskId = currentRecord.taskId and convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) = currentRecord.maxEventCreatedOn_utc
left join CRM_LINK_VW on taskId = internalId and internalRefType = 'TASK' and externalRefType = 'CONTACT_RECORD';


-- CRM_LINK_VW
create or replace view CRM_LINK_VW as
select * from (
select  DATA:action::VARCHAR as action,        
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:projectId::INTEGER as projectId, 
        DATA:projectName::VARCHAR as projectName,
        VALUE:createdBy::VARCHAR as createdBy,        
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:effectiveStartDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:effectiveEndDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveEndDate_utc,         
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:effectiveStartDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveStartDate_utc,
        VALUE:externalId::INTEGER as externalId,
        VALUE:externalLinkId::INTEGER as externalLinkId,
        VALUE:externalRefType::VARCHAR as externalRefType,
        VALUE:internalId::INTEGER as internalId,
        VALUE:internalRefType::VARCHAR as internalRefType,
        VALUE:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc
from JSON_LINK_DATA, lateral flatten(input=> DATA:dataObject:externalLinkPayload)) allRecords
join
(select  VALUE:externalLinkId as externalLinkIdc,
         VALUE:internalRefType as internalRefTypec,
         MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc
from JSON_LINK_DATA, lateral flatten(input=> DATA:dataObject:externalLinkPayload)
group by externalLinkIdc, internalRefTypec) currentRecord on allRecords.externalLinkId = currentRecord.externalLinkIdc and allRecords.internalRefType = currentRecord.internalRefTypec and allRecords.eventCreatedOn_utc = currentRecord.maxEventCreatedOn_utc
where action = 'Create'
and effectiveEndDate_utc IS NULL;


-- CRM_PROJECT_VW
create or replace view CRM_PROJECT_VW as
select  DATA:action::VARCHAR as action,        
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:dataObject:projectId::INTEGER as projectId,
        DATA:dataObject:projectName::VARCHAR as projectName,
        convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:contractEndDate::VARCHAR, 'YYYY/MM/DD')) as contractEndDate_utc,
        DATA:dataObject:contractId as contractId,
        convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:contractStartDate::VARCHAR, 'YYYY/MM/DD')) as contractStartDate_utc,
        DATA:dataObject:country::VARCHAR as country,
        DATA:dataObject:createdBy::VARCHAR as createdBy,         
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        DATA:dataObject:productId::INTEGER as productId,
        DATA:dataObject:programName::VARCHAR as programName,        
        DATA:dataObject:roleId::INTEGER as roleId,
        DATA:dataObject:state::VARCHAR as state,
        DATA:dataObject:stateAgencyName::VARCHAR as stateAgencyName,
        DATA:dataObject:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc,
        convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:goLiveDate::VARCHAR, 'YYYY/MM/DD')) as goLiveDate_utc,
        DATA:dataObject:projectStatus:projectStatusId::INTEGER as projectStatusId
from JSON_PROJECT_DATA
join
(select DATA:dataObject:projectId as projectId,        
        MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc       
from JSON_PROJECT_DATA
group by projectId) currentRecord on projectId = currentRecord.projectId and convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) = currentRecord.maxEventCreatedOn_utc;


-- CRM_PROJECT_CONTACT_VW
create or replace view CRM_PROJECT_CONTACT_VW as
select * from (
select  DATA:action::VARCHAR as action,        
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:dataObject:projectId::INTEGER as projectId,
        DATA:dataObject:projectName::VARCHAR as projectName,
        VALUE:contactEmail::VARCHAR as contactEmail,
        VALUE:contactFirstName::VARCHAR as contactFirstName,
        VALUE:contactLastName::VARCHAR as contactLastName,
        VALUE:contactMiddleName::VARCHAR as contactMiddleName,
        VALUE:contactPhoneNumber::VARCHAR as contactPhoneNumber,
        VALUE:correlationId::VARCHAR as correlationId,
        VALUE:createdBy::VARCHAR as createdBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:effectiveEndDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveEndDate_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:effectiveStartDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveStartDate_utc,
        VALUE:projectContactId::INTEGER as projectContactId,        
        VALUE:projectRole::VARCHAR as projectRole,
        VALUE:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc,
        VALUE:uuid::VARCHAR as uuid
from JSON_PROJECT_DATA, lateral flatten(input=> DATA:dataObject:projectContact)) allRecords
join
(select  DATA:dataObject:projectId as projectIdc,        
         MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc
from JSON_PROJECT_DATA
group by projectIdc) currentRecord on allRecords.projectId = currentRecord.projectIdc and allRecords.eventCreatedOn_utc = currentRecord.maxEventCreatedOn_utc;


-- CRM_PROJECT_STATUS_VW
create or replace view CRM_PROJECT_STATUS_VW as
select  DATA:action::VARCHAR as action,        
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:dataObject:projectId::INTEGER as projectId,
        DATA:dataObject:projectName::VARCHAR as projectName,
        DATA:dataObject:projectStatus:correlationId::VARCHAR as correlationId,      
        DATA:dataObject:projectStatus:createdBy::VARCHAR as createdBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:projectStatus:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:projectStatus:effectiveEndDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveEndDate_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:projectStatus:effectiveStartDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveStartDate_utc,  
        DATA:dataObject:projectStatus:projectStatusId::INTEGER as projectStatusId,        
        DATA:dataObject:projectStatus:provisioningStatus::VARCHAR as provisioningStatus,
        DATA:dataObject:projectStatus:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:projectStatus:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc,
        DATA:dataObject:projectStatus:uuid::VARCHAR as uuid
from JSON_PROJECT_DATA
join
(select  DATA:dataObject:projectId as projectId,        
         MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc
from JSON_PROJECT_DATA
group by projectId) currentRecord on projectId = currentRecord.projectId and convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) = currentRecord.maxEventCreatedOn_utc;


-- CRM_PROVISIONING_STATUS_VW
create or replace view CRM_PROVISIONING_STATUS_VW as
select * from (
select  DATA:action::VARCHAR as action,        
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:dataObject:projectId::INTEGER as projectId,
        DATA:dataObject:projectName::VARCHAR as projectName,
        VALUE:correlationId::VARCHAR as correlationId,
        VALUE:createdBy::VARCHAR as createdBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:effectiveEndDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveEndDate_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:effectiveStartDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveStartDate_utc,
        VALUE:projectStatusId::INTEGER as projectStatusId,
        VALUE:provisioningStatusId::INTEGER as provisioningStatusId,
        VALUE:provisioningStatus::VARCHAR as provisioningStatus,        
        VALUE:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc,
        VALUE:uuid::VARCHAR as uuid
from JSON_PROJECT_DATA, lateral flatten(input=> DATA:dataObject:provisioningStatus)) allRecords
join
(select  DATA:dataObject:projectId as projectIdc,        
         MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc
from JSON_PROJECT_DATA
group by projectIdc) currentRecord on allRecords.projectId = currentRecord.projectIdc and allRecords.eventCreatedOn_utc = currentRecord.maxEventCreatedOn_utc;


-- CRM_CONSUMER_VW
create or replace view CRM_CONSUMER_VW as
select  DATA:action::VARCHAR as action,
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:projectId::INTEGER as projectId, 
        DATA:projectName::VARCHAR as projectName,
        DATA:dataObject:aiNa::VARCHAR as aiNa,
        DATA:dataObject:caseConsumer::VARCHAR as caseConsumer,
        DATA:dataObject:caseId::INTEGER as caseId,
        convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:consumerDateOfBirth::VARCHAR, 'YYYY/MM/DD')) as consumerDateOfBirth_utc,
        DATA:dataObject:consumerFirstName::VARCHAR as consumerFirstName,
        DATA:dataObject:consumerId::INTEGER as consumerId,
        DATA:dataObject:consumerLastName::VARCHAR as consumerLastName,
        DATA:dataObject:consumerMiddleName::VARCHAR as consumerMiddleName,
        DATA:dataObject:consumerPrefix::VARCHAR as consumerPrefix,
        DATA:dataObject:consumerRole::VARCHAR as consumerRole,
        DATA:dataObject:consumerSSN::VARCHAR as consumerSSN,
        DATA:dataObject:consumerStatus::VARCHAR as consumerStatus,
        DATA:dataObject:consumerSuffix::VARCHAR as consumerSuffix,
        DATA:dataObject:consumerType::VARCHAR as consumerType,
        DATA:dataObject:correlationId::VARCHAR as correlationId,
        DATA:dataObject:createdBy::VARCHAR as createdBy,        
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:dateOfDeath::VARCHAR, 'YYYY/MM/DD')) as dateOfDeath_utc,
        DATA:dataObject:dateOfDeathNotifiedBy::VARCHAR as dateOfDeathNotifiedBy,
        convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:dateOfDeathNotifiedDate::VARCHAR, 'YYYY/MM/DD')) as dateOfDeathNotifiedDate_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:dateOfSsnValidation::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as dateOfSsnValidation_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:effectiveEndDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveEndDate_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:effectiveStartDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveStartDate_utc,
        DATA:dataObject:ethinicityCode::VARCHAR as ethinicityCode,
        DATA:dataObject:genderCode::VARCHAR as genderCode,
        DATA:dataObject:mergeReason::VARCHAR as mergeReason,
        DATA:dataObject:mergedConsumerId::INTEGER as mergedConsumerId,
        DATA:dataObject:notBornInd::VARCHAR as notBornInd,
        DATA:dataObject:preferredLanguage::VARCHAR as preferredLanguage,
        convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:pregnancyDueDate::VARCHAR, 'YYYY/MM/DD')) as pregnancyDueDate_utc,
        DATA:dataObject:pregnancyInd::VARCHAR as pregnancyInd,
        DATA:dataObject:raceCode::VARCHAR as raceCode,
        DATA:dataObject:relationship::VARCHAR as relationship,
        DATA:dataObject:ssnValidationAgency::VARCHAR as ssnValidationAgency,
        DATA:dataObject:ssnValidationCode::VARCHAR as ssnValidationCode,
        DATA:dataObject:uiid::VARCHAR as uiid,
        DATA:dataObject:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(DATA:dataObject:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc,
        DATA:dataObject:usResidentStatusCode::VARCHAR as usResidentStatusCode
from JSON_CONSUMER_DATA
join
(select DATA:dataObject:consumerId as consumerId,        
        MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc       
from JSON_CONSUMER_DATA
group by consumerId) currentRecord on consumerId = currentRecord.consumerId and convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) = currentRecord.maxEventCreatedOn_utc;


-- CRM_COMMUNICATION_PREFERENCES_VW
create or replace view CRM_COMMUNICATION_PREFERENCES_VW as
select * from (
select  DATA:action::VARCHAR as action,
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:projectId::INTEGER as projectId, 
        DATA:projectName::VARCHAR as projectName,
        VALUE:caseId::INTEGER as caseId,
        VALUE:consumerId::INTEGER as consumerId,
        VALUE:createdBy::VARCHAR as createdBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,
        VALUE:defaultInd::VARCHAR as defaultInd,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:effectiveEndDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveEndDate_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:effectiveStartDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveStartDate_utc,
        VALUE:preferenceId::INTEGER as preferenceId,
        VALUE:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc,
        VALUE:valuePairIdCommPref::VARCHAR as valuePairIdCommPref
from JSON_CONSUMER_DATA, lateral flatten(input=> DATA:dataObject:communicationPreferences)) allRecords
join
(select DATA:dataObject:consumerId as consumerIdc,        
        MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc       
from JSON_CONSUMER_DATA
group by consumerIdc) currentRecord on allRecords.consumerId = currentRecord.consumerIdc and allRecords.eventCreatedOn_utc = currentRecord.maxEventCreatedOn_utc;


-- CRM_CONSUMER_CONSENT_REQUEST_VW
create or replace view CRM_CONSUMER_CONSENT_REQUEST_VW as
select * from (
select  DATA:action::VARCHAR as action,
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:projectId::INTEGER as projectId, 
        DATA:projectName::VARCHAR as projectName,
        VALUE:consentType::VARCHAR as consentType,
        VALUE:consumerConsentId::INTEGER as consumerConsentId,
        VALUE:consumerId::INTEGER as consumerId,
        VALUE:createdBy::VARCHAR as createdBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,         
        convert_timezone('UTC', to_timestamp_tz(VALUE:dateOfConsent::VARCHAR, 'YYYY/MM/DD')) as dateOfConsent,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:effectiveEndDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveEndDate_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:effectiveStartDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveStartDate_utc,
        VALUE:howConsentProvided::VARCHAR as howConsentProvided,
        VALUE:noResponseInd::VARCHAR as noResponseInd,
        VALUE:optIn::VARCHAR as optIn,
        VALUE:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc  
from JSON_CONSUMER_DATA, lateral flatten(input=> DATA:dataObject:consumerConsentRequest)) allRecords
join
(select DATA:dataObject:consumerId as consumerIdc,        
        MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc       
from JSON_CONSUMER_DATA
group by consumerIdc) currentRecord on allRecords.consumerId = currentRecord.consumerIdc and allRecords.eventCreatedOn_utc = currentRecord.maxEventCreatedOn_utc;

-- CRM_CONSUMER_IDENTIFICATION_NUMBER_VW
create or replace view CRM_CONSUMER_IDENTIFICATION_NUMBER_VW as
select * from (
select  DATA:action::VARCHAR as action,
        convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM')) as eventCreatedOn_utc,
        DATA:projectId::INTEGER as projectId, 
        DATA:projectName::VARCHAR as projectName,
        VALUE:agencyName::VARCHAR as agencyName,
        VALUE:consumerId::INTEGER as consumerId,
        VALUE:consumerIdentificationNumberId::INTEGER as consumerIdentificationNumberId,
        VALUE:createdBy::VARCHAR as createdBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:createdOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as createdOn_utc,                 
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:effectiveEndDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveEndDate_utc,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:effectiveStartDate::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as effectiveStartDate_utc,
        VALUE:externalConsumerId::VARCHAR as externalConsumerId,
        INITCAP(LOWER(VALUE:identificationNumberType::VARCHAR)) as identificationNumberType,
        VALUE:updatedBy::VARCHAR as updatedBy,
        to_timestamp(convert_timezone('UTC', to_timestamp_tz(VALUE:updatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as updatedOn_utc  
from JSON_CONSUMER_DATA, lateral flatten(input=> DATA:dataObject:consumerIdentificationNumber)) allRecords
join
(select DATA:dataObject:consumerId as consumerIdc,        
        MAX(convert_timezone('UTC', to_timestamp_tz(DATA:eventCreatedOn::VARCHAR, 'YYYY-MM-DD"T"HH24:MI:SS.FFTZH:TZM'))) as maxEventCreatedOn_utc       
from JSON_CONSUMER_DATA
group by consumerIdc) currentRecord on allRecords.consumerId = currentRecord.consumerIdc and allRecords.eventCreatedOn_utc = currentRecord.maxEventCreatedOn_utc;