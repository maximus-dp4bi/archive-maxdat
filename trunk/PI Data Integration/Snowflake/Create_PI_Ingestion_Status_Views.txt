create or replace view admin_pi_ingestion_status_by_project_vw as
with base as (
               select * from (
                               select dl0.projectid, dl0.ts, dd.date as status_date_est,
                               RANK() OVER (PARTITION BY dl0.projectid,dd.date ORDER BY dl0.ts desc) as row_num
                               from raw.ingest_pi_data_det_log dl0
                               join public.d_dates dd
                               on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl0.ts)))) = dd.date
                               where dl0.object_category in ('INGESTION STARTED')
                               and dd.date >= date('2021-06-01')
               ) where row_num=1
),
final as (
select * from (
                               select dl1.projectid, to_timestamp_ltz(to_varchar(dl1.ts)) as status_time_ltz, dd.date as status_date_est, 
                               dl1.object_category, dl1.status_string,
                               RANK() OVER (PARTITION BY dl1.projectid,dd.date ORDER BY dl1.ts desc) as row_num
                               from raw.ingest_pi_data_det_log dl1
                               join public.d_dates dd
                               on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = dd.date
                               --and dd.date =  date(convert_timezone('America/New_York',current_timestamp()))
               ) where row_num=1
),
min_date as (
              select to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(min(dl2.ts))))) as min_date 
              from raw.ingest_pi_data_det_log dl2 
),
projects_tables_list as (
                                                   
select final.status_date_est, final.status_time_ltz, phist.projectid as projectid, phist.projectname, thist.table_name as active_table_name,uthist.table_name as unavailable_table_name
from final

left outer join public.d_pi_projects_history phist
on final.projectid = phist.projectid
and final.status_time_ltz >= phist.start_time
and timestampadd(minute,1,final.status_time_ltz) <= phist.end_time
and phist.active = true

left outer join public.d_pi_tables_history thist
on final.status_time_ltz >= thist.start_time
and timestampadd(minute,1,final.status_time_ltz) <= thist.end_time
and thist.active = true
and thist.s3_sourced = true
                                                   
left outer join public.d_pi_project_unavailable_tables_history uthist
on final.projectid = uthist.project_id
and thist.table_name = uthist.table_name
and final.status_time_ltz >= uthist.start_time
and timestampadd(minute,1,final.status_time_ltz) <= uthist.end_time
and (uthist.end_unavailable_date is null or uthist.end_unavailable_date >= final.status_date_est)
),
table_ingested_count as (
                         select dl1.projectid, ptlist.status_date_est as status_date,
                         count(distinct dl1.object_name) as nmbr_tables_ingested
                         from raw.ingest_pi_data_det_log dl1
                         join base
                         on dl1.projectid = base.projectid
                         and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = base.status_date_est
                         join projects_tables_list ptlist
                         on dl1.projectid = ptlist.projectid
                         and dl1.object_name = ptlist.active_table_name
                         and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = ptlist.status_date_est
                         where dl1.object_category in ('TABLE','TABLE REINGEST') 
                         and dl1.status_string = 'SUCCEEDED'
                         and dl1.ts >= base.ts
                         and ptlist.projectid is not null
                         and ptlist.active_table_name is not null
                         and ptlist.unavailable_table_name is null         
                         group by 1,2
),
table_ingested_zero_count as (
                         select dl1.projectid, ptlist.status_date_est as status_date,
                         count(distinct dl1.object_name) as nmbr_tables_ingested_zero
                         from raw.ingest_pi_data_det_log dl1
                         join base
                         on dl1.projectid = base.projectid
                         and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = base.status_date_est
                         join projects_tables_list ptlist
                         on dl1.projectid = ptlist.projectid
                         and dl1.object_name = ptlist.active_table_name
                         and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = ptlist.status_date_est
                         where dl1.object_category in ('TABLE','TABLE REINGEST') 
                         and dl1.status_string = 'WARNING'
                         and dl1.msg like '%has 0 records%'
                         and dl1.ts >= base.ts
                         and ptlist.projectid is not null
                         and ptlist.active_table_name is not null
                         and ptlist.unavailable_table_name is null         
                         group by 1,2
),
table_configured_count as (
                           select ptlist.projectid, ptlist.status_date_est as status_date,count(*) as nmbr_tables_configured 
                           from projects_tables_list ptlist
                           where ptlist.projectid is not null
                           and ptlist.active_table_name is not null
                           and ptlist.unavailable_table_name is null
                           group by 1,2
),
table_unavailable_count as (
                           select ptlist.projectid, ptlist.status_date_est as status_date,count(*) as nmbr_tables_unavailable 
                           from projects_tables_list ptlist
                           where ptlist.projectid is not null
                           and ptlist.active_table_name is not null
                           and ptlist.unavailable_table_name is not null
                           group by 1,2
),
sp_runs as (
  select * from (
                  select dl1.projectid, dl1.object_name, dl1.status_string, 
                         convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts))) as status_time, high_base.status_date_est,
                         RANK() OVER (PARTITION BY dl1.object_name,high_base.status_date_est ORDER BY dl1.ts desc) as row_num
                         from raw.ingest_pi_data_det_log dl1
                         join (select status_date_est,max(ts) as ts from base group by status_date_est) high_base
                         on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = high_base.status_date_est
                         where object_category = 'SP'
                         --and dl1.ts >= high_base.ts
               ) where row_num=1
  
  ),
    data_found_time as (
 select * from (
                  select dl1.projectid, dl1.object_name, dl1.status_string, 
                         convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts))) as status_time_est, high_base.status_date_est,
                         RANK() OVER (PARTITION BY dl1.projectid,high_base.status_date_est ORDER BY dl1.ts desc) as row_num
                         from raw.ingest_pi_data_det_log dl1
                         join (select status_date_est,max(ts) as ts from base group by status_date_est) high_base
                         on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = high_base.status_date_est
                         where object_name = '_SUCCESS FILE'
                         and status_string = 'SUCCEEDED'
                         --and dl1.ts >= high_base.ts
               ) where row_num=1
  
  ),
zero_means_done as (
select projectid, status_date_est, zero_means_done from admin_pi_ingestion_zero_means_done_by_project_by_date_vw
)

select results.projectid, results.projectname,        
       table_configured_count.nmbr_tables_configured as tables_available,
       table_ingested_count.nmbr_tables_ingested as tables_ingested,
       ifnull(table_ingested_zero_count.nmbr_tables_ingested_zero,0) as tables_ingested_zero_records,
       table_unavailable_count.nmbr_tables_unavailable as tables_unavailable,
       results.status,  
       data_found_time.status_time_est as data_available_time,
       results.status_time, results.status_date
from 
     (select relevant.projectid, relevant.projectname,
      case 
           when relevant.status_string = 'FAILED' and relevant.object_category not like '%REINGEST'
           then 'INGESTION FAILED'

           when relevant.status_string = 'FAILED' and relevant.object_category like '%REINGEST'
           then 'RE-INGESTION FAILED'

           when relevant.object_category = 'INGESTION STARTED' then 'INGESTION STARTED'
           when relevant.object_category = 'INGESTION STARTED REINGEST' then 'RE-INGESTION STARTED'
           when relevant.object_category = 'INGESTION COMPLETED' and relevant.status_string = 'SUCCEEDED'
           and relevant.zero_means_done = 0
           and not exists (select 1 from raw.ingest_PI_data_det_log dl5
                           join base on dl5.projectid = base.projectid
                           and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts)))) = base.status_date_est
                             where dl5.projectid = relevant.projectid
                             and dl5.status_string = 'WARNING'
                             and dl5.ts >= base.ts
                             and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts))))= relevant.status_date )
             then 'INGESTION COMPLETED'
             when relevant.object_category = 'INGESTION COMPLETED REINGEST' and relevant.status_string = 'SUCCEEDED'
             and relevant.zero_means_done = 0
             and not exists (select 1 from raw.ingest_PI_data_det_log dl5
                           join base on dl5.projectid = base.projectid
                           and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts)))) = base.status_date_est
                             where dl5.projectid = relevant.projectid
                             and dl5.status_string = 'WARNING'
                             and dl5.ts >= base.ts
                             and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts))))= relevant.status_date )
             then 'RE-INGESTION COMPLETED'      
      
      
            when relevant.object_category = 'INGESTION COMPLETED' and relevant.status_string = 'SUCCEEDED'
            and relevant.zero_means_done = 0
            and exists (select 1 from raw.ingest_PI_data_det_log dl5
                           join base on dl5.projectid = base.projectid
                           and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts)))) = base.status_date_est
                             where dl5.projectid = relevant.projectid
                             and dl5.status_string = 'WARNING'
                             and dl5.ts >= base.ts
                             and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts))))= relevant.status_date )
             then 'INGESTION COMPLETED WITH WARNINGS'
             when relevant.object_category = 'INGESTION COMPLETED REINGEST' and relevant.status_string = 'SUCCEEDED'
              and relevant.zero_means_done = 0
             and exists (select 1 from raw.ingest_PI_data_det_log dl5
                           join base on dl5.projectid = base.projectid
                           and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts)))) = base.status_date_est
                             where dl5.projectid = relevant.projectid
                             and dl5.status_string = 'WARNING'
                             and dl5.ts >= base.ts
                             and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts))))= relevant.status_date )
             then 'RE-INGESTION COMPLETED WITH WARNINGS'        
      
           when relevant.object_category = 'INGESTION COMPLETED' and relevant.status_string = 'SUCCEEDED'
           and relevant.zero_means_done != 0
          then 'INGESTION COMPLETED WITH ERRORS'
      
          when relevant.object_category = 'INGESTION COMPLETED REINGEST' and relevant.status_string = 'SUCCEEDED'
          and relevant.zero_means_done != 0
          then 'RE-INGESTION COMPLETED WITH ERRORS'
     
             
             when relevant.object_category = 'S3 DATA' and relevant.status_string = 'WAITING' 
             and not exists (select 1 from raw.ingest_PI_data_det_log dl5
                             join base on dl5.projectid = base.projectid
                             and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts)))) = base.status_date_est
                             where dl5.projectid = relevant.projectid
                             and dl5.object_category = 'INGESTION STARTED REINGEST'
                             and dl5.ts >= base.ts
                             and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts))))= relevant.status_date )
             then 'INGESTION WAITING FOR S3 DATA'
               
             when relevant.object_category = 'S3 DATA' and relevant.status_string = 'WAITING' 
             and exists (select 1 from raw.ingest_PI_data_det_log dl5
                             join base on dl5.projectid = base.projectid
                             and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts)))) = base.status_date_est
                             where dl5.projectid = relevant.projectid
                             and dl5.object_category = 'INGESTION STARTED REINGEST'
                             and dl5.ts >= base.ts
                             and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts))))= relevant.status_date )
             then 'RE-INGESTION WAITING FOR S3 DATA'        
      
             when relevant.object_category not in ('INGESTION STARTED','INGESTION COMPLETED') and relevant.status_string != 'WAITING'
             and not exists (select 1 from raw.ingest_PI_data_det_log dl5
                             join base on dl5.projectid = base.projectid
                             and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts)))) = base.status_date_est
                             where dl5.projectid = relevant.projectid
                             and dl5.object_category = 'INGESTION STARTED REINGEST'
                             and dl5.ts >= base.ts
                             and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts))))= relevant.status_date )
             then 'INGESTION IN-PROCESS'
             
             when relevant.object_category not in ('INGESTION STARTED','INGESTION COMPLETED') and relevant.status_string != 'WAITING'
             and exists (select 1 from raw.ingest_PI_data_det_log dl5
                             join base on dl5.projectid = base.projectid
                             and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts)))) = base.status_date_est
                             where dl5.projectid = relevant.projectid
                             and dl5.object_category = 'INGESTION STARTED REINGEST'
                             and dl5.ts >= base.ts
                             and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl5.ts))))= relevant.status_date )
             then 'RE-INGESTION IN-PROCESS'     
      else 'INGESTION STATUS UNKOWN'
      
      end as status,
      status_time, status_date 

     from (
           SELECT pr.projectname,dl2.*,  
           convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl2.ts))) as status_time,
           dd.date as status_date, zero_means_done.zero_means_done,
           RANK() OVER (PARTITION BY dl2.projectid,dd.date ORDER BY dl2.ts desc) as row_num  
           FROM raw.ingest_pi_data_det_log dl2
           join public.d_pi_projects pr
           on dl2.projectid = pr.projectid
           join base
           on dl2.projectid = base.projectid
           and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl2.ts)))) = base.status_date_est
           join public.d_dates dd
           on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl2.ts)))) = dd.date
           join zero_means_done on pr.projectid = zero_means_done.projectid 
           and zero_means_done.status_date_est = dd.date
       where dl2.ts >= base.ts
          ) relevant
     where row_num = 1

     union all

     select pr.projectid, pr.projectname,
            'INGESTION NOT YET STARTED' as status,
            convert_timezone('America/New_York',current_timestamp) as status_time, 
            date (convert_timezone('America/New_York',current_timestamp)) as status_date
     from public.d_pi_projects pr
     left outer join base
     on pr.projectid = base.projectid
      and base.status_date_est = date(convert_timezone('America/New_York',current_timestamp())) 
     where pr.active = true
     and not exists
                    (select 1 from raw.ingest_PI_data_det_log dl3
                              where dl3.projectid = pr.projectid
                              and dl3.object_category = 'INGESTION STARTED'
                              and dl3.ts >= base.ts
                              and date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl3.ts)))) = 
                                  date(convert_timezone('America/New_York',current_timestamp()))  )
     )results
left outer join
table_ingested_count
on results.projectid = table_ingested_count.projectid
and results.status_date = table_ingested_count.status_date
left outer join
table_configured_count
on results.projectid = table_configured_count.projectid
and results.status_date = table_configured_count.status_date
left outer join
table_unavailable_count
on results.projectid = table_unavailable_count.projectid
and results.status_date = table_unavailable_count.status_date
left outer join
table_ingested_zero_count
on results.projectid = table_ingested_zero_count.projectid
and results.status_date = table_ingested_zero_count.status_date
left outer join data_found_time
on results.projectid = data_found_time.projectid
and results.status_date = data_found_time.status_date_est
union all
select projectid, 'NA' as projectname, null,null,null,null, 'SP ' || sp.object_name || ' ' || sp.status_string as status, null, sp.status_time, sp.status_date_est
from sp_runs sp;



create or replace view admin_pi_ingestion_status_by_table_vw as
with base as (
               select * from (
                               select dl0.projectid, dl0.ts, dd.date as status_date_est,
                               RANK() OVER (PARTITION BY dl0.projectid,dd.date ORDER BY dl0.ts desc) as row_num
                               from raw.ingest_pi_data_det_log dl0
                               join public.d_dates dd
                               on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl0.ts)))) = dd.date
                               where dl0.object_category in ('INGESTION STARTED')
                               and dd.date >= date('2021-06-01')
               ) where row_num=1
),
final as (
select * from (
                               select dl1.projectid, to_timestamp_ltz(to_varchar(dl1.ts)) as status_time_ltz, dd.date as status_date_est, dl1.object_category, dl1.status_string,
                               RANK() OVER (PARTITION BY dl1.projectid,dd.date ORDER BY dl1.ts desc) as row_num
                               from raw.ingest_pi_data_det_log dl1
                               join public.d_dates dd
                               on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = dd.date
                               --and dd.date =  date(convert_timezone('America/New_York',current_timestamp()))
               ) where row_num=1
),
projects_tables_list as (
                                                   
select final.status_date_est, final.status_time_ltz, phist.projectid as projectid,phist.projectname, thist.table_name as active_table_name,uthist.table_name as unavailable_table_name
from final

left outer join public.d_pi_projects_history phist
on final.projectid = phist.projectid
and final.status_time_ltz >= phist.start_time
and timestampadd(minute,1,final.status_time_ltz) <= phist.end_time
and phist.active = true

left outer join public.d_pi_tables_history thist
on final.status_time_ltz >= thist.start_time
and timestampadd(minute,1,final.status_time_ltz) <= thist.end_time
and thist.active = true
and thist.s3_sourced = true
                                                   
left outer join public.d_pi_project_unavailable_tables_history uthist
on final.projectid = uthist.project_id
and thist.table_name = uthist.table_name
and final.status_time_ltz >= uthist.start_time
and timestampadd(minute,1,final.status_time_ltz) <= uthist.end_time
and (uthist.end_unavailable_date is null or uthist.end_unavailable_date >= final.status_date_est)
),
sp_runs as (
  select * from (
                  select dl1.projectid, dl1.object_name, dl1.status_string, dl1.msg,
                         convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts))) as status_time, high_base.status_date_est,
                         RANK() OVER (PARTITION BY dl1.object_name,high_base.status_date_est ORDER BY dl1.ts desc) as row_num
                         from raw.ingest_pi_data_det_log dl1
                         join (select status_date_est,max(ts) as ts from base group by status_date_est) high_base
                         on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = high_base.status_date_est
                         where object_category = 'SP'
                         and projectid not in ('9999')
                         --and dl1.ts >= high_base.ts
               ) where row_num=1
  
  )


select dl.projectid,ptlist.projectname, dl.object_name as table_name, dl.status_string as status, dl.msg as log_msg,
convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl.ts))) as status_time, ptlist.status_date_est as status_date 

from raw.ingest_pi_data_det_log dl
left outer join projects_tables_list ptlist
on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl.ts)))) = ptlist.status_date_est
and dl.projectid = ptlist.projectid
and dl.object_name = ptlist.active_table_name

join base
on dl.projectid = base.projectid
and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl.ts)))) = base.status_date_est  
where dl.object_category in ('TABLE','TABLE REINGEST')
and dl.ts >= base.ts
and ptlist.projectid is not null
and ptlist.active_table_name is not null
and ptlist.unavailable_table_name is null
--order by  ptlist.status_date_est desc, dl.ts desc

union all

select projectid, 'NA' as projectname,'NA' as table_name, 'SP ' || sp.object_name || ' ' || sp.status_string as status, 
msg as log_msg,sp.status_time, sp.status_date_est
from sp_runs sp;




create or replace view admin_pi_ingestion_zero_means_done_by_project_by_date_vw as
with base as (
               select * from (
                               select dl0.projectid, dl0.ts, dd.date as status_date_est,
                               RANK() OVER (PARTITION BY dl0.projectid,dd.date ORDER BY dl0.ts desc) as row_num
                               from raw.ingest_pi_data_det_log dl0
                               join public.d_dates dd
                               on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl0.ts)))) = dd.date
                               where dl0.object_category in ('INGESTION STARTED')
               ) where row_num=1
),
final as (
select * from (
                               select dl1.projectid, to_timestamp_ltz(to_varchar(dl1.ts)) as status_time_ltz, dd.date as status_date_est, 
                               dl1.object_category, dl1.status_string,
                               RANK() OVER (PARTITION BY dl1.projectid,dd.date ORDER BY dl1.ts desc) as row_num
                               from raw.ingest_pi_data_det_log dl1
                               join public.d_dates dd
                               on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = dd.date
  where dl1.projectid != 'ALL'
                               --and dd.date =  date(convert_timezone('America/New_York',current_timestamp()))
               ) where row_num=1
),
min_date as (
              select to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(min(dl2.ts))))) as min_date 
              from raw.ingest_pi_data_det_log dl2 
),
projects_tables_list as (
                                                   
select final.status_date_est, final.status_time_ltz, phist.projectid as projectid,thist.table_name as active_table_name,uthist.table_name as unavailable_table_name
from final

left outer join public.d_pi_projects_history phist
on final.projectid = phist.projectid
and final.status_time_ltz >= phist.start_time
and timestampadd(minute,1,final.status_time_ltz) <= phist.end_time
and phist.active = true

left outer join public.d_pi_tables_history thist
on final.status_time_ltz >= thist.start_time
and timestampadd(minute,1,final.status_time_ltz) <= thist.end_time
and thist.active = true
and thist.s3_sourced = true
                                                   
left outer join public.d_pi_project_unavailable_tables_history uthist
on final.projectid = uthist.project_id
and thist.table_name = uthist.table_name
and final.status_time_ltz >= uthist.start_time
and timestampadd(minute,1,final.status_time_ltz) <= uthist.end_time
and (uthist.end_unavailable_date is null or uthist.end_unavailable_date >= final.status_date_est)
),
sp_runs as (
  select * from (
                  select dl1.projectid, dl1.object_name, dl1.status_string, dl1.msg,
                         convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts))) as status_time, high_base.status_date_est,
                         RANK() OVER (PARTITION BY dl1.object_name,high_base.status_date_est ORDER BY dl1.ts desc) as row_num
                         from raw.ingest_pi_data_det_log dl1
                         join (select status_date_est,max(ts) as ts from base where base.projectid not in ('9999') group by status_date_est) high_base
                         on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = high_base.status_date_est
                         where object_category = 'SP'
                         and dl1.ts >= high_base.ts
               ) where row_num=1
  
  ),
main as (
select ptlist.status_date_est,ptlist.projectid,ptlist.active_table_name as table_name
from projects_tables_list ptlist
join final 
on ptlist.projectid = final.projectid
and ptlist.status_date_est = final.status_date_est 
where ptlist.projectid is not null
and ptlist.active_table_name is not null
and ptlist.unavailable_table_name is null  
and (not exists (
                select 1 from raw.ingest_pi_data_det_log dl
                join base
                on dl.projectid = base.projectid
                and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl.ts)))) = base.status_date_est  
                where dl.projectid = ptlist.projectid
                and dl.object_category in ('TABLE','TABLE REINGEST')
                and dl.object_name = ptlist.active_table_name
                and dl.status_string = 'SUCCEEDED'
                and dl.ts >= base.ts 
                and date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl.ts)))) = ptlist.status_date_est
)
or not (final.object_category in ('INGESTION COMPLETED','INGESTION COMPLETED REINGEST') and final.status_string != 'SUCCESS')
)
)

(select ptlist.projectid, ptlist.status_date_est, count(main.table_name) as zero_means_done
from projects_tables_list ptlist
left outer join main
on ptlist.projectid = main.projectid
and ptlist.active_table_name = main.table_name
and ptlist.status_date_est = main.status_date_est
group by 1,2 order by 2,1)

union all

select 'ALL' as projectid, d_dates.date,(1 - ifnull(count(sp_runs.*),0)) as zero_means_done
from public.d_dates left outer join sp_runs
on d_dates.date = sp_runs.status_date_est
left outer join min_date
where d_dates.date >= min_date
and d_dates.date <= date(convert_timezone('America/New_York',current_timestamp()))
group by 1,2 order by 1,2;

select * from raw.groups_membership;

select * from admin_pi_ingestion_zero_means_done_by_project_by_date_vw where projectid = 'ALL' order by status_date_est;
select * from raw.ingest_pi_data_det_log where date(to_timestamp(to_varchar(ts))) = date('2021-05-20') and object_category in ('SP','INGESTION STARTED') order by ts;

create or replace view admin_pi_ingestion_zero_means_done_vw as
with base as (
               select * from (
                               select dl0.projectid, dl0.ts, dd.date as status_date,
                               RANK() OVER (PARTITION BY dl0.projectid,dd.date ORDER BY dl0.ts desc) as row_num
                               from raw.ingest_pi_data_det_log dl0
                               join public.d_dates dd
                               on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl0.ts)))) = dd.date
                               where dl0.object_category in ('INGESTION STARTED')
                               and dd.date =  date(convert_timezone('America/New_York',current_timestamp()))
               ) where row_num=1
),
final as (
select * from (
                               select dl1.projectid, dl1.ts, dd.date as status_date, dl1.object_category, dl1.status_string,
                               RANK() OVER (PARTITION BY dl1.projectid,dd.date ORDER BY dl1.ts desc) as row_num
                               from raw.ingest_pi_data_det_log dl1
                               join public.d_dates dd
                               on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = dd.date
                               where dd.date =  date(convert_timezone('America/New_York',current_timestamp()))
               ) where row_num=1
),
sp_runs as (
  select count(*) as sp_count from (
                  select dl1.projectid, dl1.object_name, dl1.status_string, dl1.msg,
                         convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts))) as status_time, high_base.status_date,
                         RANK() OVER (PARTITION BY dl1.object_name,high_base.status_date ORDER BY dl1.ts desc) as row_num
                         from raw.ingest_pi_data_det_log dl1
                         join (select status_date,max(ts) as ts from base where base.projectid not in ('9999') group by status_date) high_base
                         on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = high_base.status_date
                         where object_category = 'SP'
                         and status_string = 'SUCCEEDED'
                         and dl1.ts >= high_base.ts
               ) where row_num=1
  
  ),
main as (
select count(*) as zero_means_done from 
public.d_pi_projects pr
join public.d_pi_tables ta
left outer join base on pr.projectid = base.projectid
left outer join final on pr.projectid = final.projectid
where pr.active = true
and ta.active = true
and ta.s3_sourced = true
and not exists (
                 select 1 from public.d_pi_project_unavailable_tables ua
                 where ua.project_id = pr.projectid
                 and ua.table_name = ta.table_name
                 and ((ua.end_unavailable_date is null) or (ua.end_unavailable_date >= date(convert_timezone('America/New_York',current_timestamp()))  ))
                )
and (not exists (
                select 1 from raw.ingest_pi_data_det_log dl
                where dl.projectid = pr.projectid
                and dl.object_category in ('TABLE','TABLE REINGEST')
                and dl.object_name = ta.table_name
                and dl.status_string = 'SUCCEEDED'
                and dl.ts >= base.ts 
                 and date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl.ts)))) = 
                                  date(convert_timezone('America/New_York',current_timestamp())) 
)
or not (final.object_category in ('INGESTION COMPLETED','INGESTION COMPLETED REINGEST') and final.status_string != 'SUCCESS')
)
)
  select (main.zero_means_done + (1- ifnull(sp_runs.sp_count,0))) as zero_means_done
  from main
  left outer join sp_runs
;

select convert_timezone('America/New_York',to_timestamp_ltz('1622116968107'));
select * from raw.ingest_pi_data_det_log where date(to_timestamp_ltz(to_varchar(ts))) = date('2021-06-02') 
order by ts desc;

select * from public.admin_pi_ingestion_status_by_project_vw where status_date = date('2021-06-03') order by projectid;



with base as (
               select * from (
                               select dl0.projectid, dl0.ts, dd.date as status_date_est,
                               RANK() OVER (PARTITION BY dl0.projectid,dd.date ORDER BY dl0.ts desc) as row_num
                               from raw.ingest_pi_data_det_log dl0
                               join public.d_dates dd
                               on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl0.ts)))) = dd.date
                               where dl0.object_category in ('INGESTION STARTED')
               ) where row_num=1
),
final as (
select * from (
                               select dl1.projectid, to_timestamp_ltz(to_varchar(dl1.ts)) as status_time_ltz, dd.date as status_date_est, 
                               dl1.object_category, dl1.status_string,
                               RANK() OVER (PARTITION BY dl1.projectid,dd.date ORDER BY dl1.ts desc) as row_num
                               from raw.ingest_pi_data_det_log dl1
                               join public.d_dates dd
                               on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = dd.date
                               --and dd.date =  date(convert_timezone('America/New_York',current_timestamp()))
               ) where row_num=1
),
min_date as (
              select to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(min(dl2.ts))))) as min_date 
              from raw.ingest_pi_data_det_log dl2 
),
projects_tables_list as (
                                                   
select final.status_date_est, final.status_time_ltz, phist.projectid as projectid, phist.projectname, thist.table_name as active_table_name,uthist.table_name as unavailable_table_name
from final

left outer join public.d_pi_projects_history phist
on final.projectid = phist.projectid
and final.status_time_ltz >= phist.start_time
and timestampadd(minute,1,final.status_time_ltz) <= phist.end_time
and phist.active = true

left outer join public.d_pi_tables_history thist
on final.status_time_ltz >= thist.start_time
and timestampadd(minute,1,final.status_time_ltz) <= thist.end_time
and thist.active = true
and thist.s3_sourced = true
                                                   
left outer join public.d_pi_project_unavailable_tables_history uthist
on final.projectid = uthist.project_id
and thist.table_name = uthist.table_name
and final.status_time_ltz >= uthist.start_time
and timestampadd(minute,1,final.status_time_ltz) <= uthist.end_time
and (uthist.end_unavailable_date is null or uthist.end_unavailable_date >= final.status_date_est)
),
table_ingested_count as (
                         select dl1.projectid, ptlist.status_date_est as status_date,
                         count(distinct dl1.object_name) as nmbr_tables_ingested
                         from raw.ingest_pi_data_det_log dl1
                         join base
                         on dl1.projectid = base.projectid
                         and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = base.status_date_est
                         join projects_tables_list ptlist
                         on dl1.projectid = ptlist.projectid
                         and dl1.object_name = ptlist.active_table_name
                         and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = ptlist.status_date_est
                         where dl1.object_category in ('TABLE','TABLE REINGEST') 
                         and dl1.status_string = 'SUCCEEDED'
                         and dl1.ts >= base.ts
                         and ptlist.projectid is not null
                         and ptlist.active_table_name is not null
                         and ptlist.unavailable_table_name is null         
                         group by 1,2
),
table_ingested_zero_count as (
                         select dl1.projectid, ptlist.status_date_est as status_date,
                         count(distinct dl1.object_name) as nmbr_tables_ingested_zero
                         from raw.ingest_pi_data_det_log dl1
                         join base
                         on dl1.projectid = base.projectid
                         and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = base.status_date_est
                         join projects_tables_list ptlist
                         on dl1.projectid = ptlist.projectid
                         and dl1.object_name = ptlist.active_table_name
                         and to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = ptlist.status_date_est
                         where dl1.object_category in ('TABLE','TABLE REINGEST') 
                         and dl1.status_string = 'WARNING'
                         and dl1.msg like '%has 0 records%'
                         and dl1.ts >= base.ts
                         and ptlist.projectid is not null
                         and ptlist.active_table_name is not null
                         and ptlist.unavailable_table_name is null         
                         group by 1,2
),
table_configured_count as (
                           select ptlist.projectid, ptlist.status_date_est as status_date,count(*) as nmbr_tables_configured 
                           from projects_tables_list ptlist
                           where ptlist.projectid is not null
                           and ptlist.active_table_name is not null
                           and ptlist.unavailable_table_name is null
                           group by 1,2
),
table_unavailable_count as (
                           select ptlist.projectid, ptlist.status_date_est as status_date,count(*) as nmbr_tables_unavailable 
                           from projects_tables_list ptlist
                           where ptlist.projectid is not null
                           and ptlist.active_table_name is not null
                           and ptlist.unavailable_table_name is not null
                           group by 1,2
),
sp_runs as (
  select * from (
                  select dl1.projectid, dl1.object_name, dl1.status_string, 
                         convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts))) as status_time, 
   convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(high_base.ts))) as hb_tme, high_base.status_date_est,
                         RANK() OVER (PARTITION BY dl1.object_name,high_base.status_date_est ORDER BY dl1.ts desc) as row_num
                         from raw.ingest_pi_data_det_log dl1
                         join (select status_date_est,max(ts) as ts from base group by status_date_est) high_base
                         on to_date(convert_timezone('America/New_York',to_timestamp_ltz(to_varchar(dl1.ts)))) = high_base.status_date_est
                         where object_category = 'SP'
                         and dl1.ts >= high_base.ts
               ) where row_num=1
  
  )
  select * from sp_runs order by status_date_est desc;
  